<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Griplog ‚Äî Items & ItemFolder</title>

  <!-- Basic CSP meta (works only for HTML doc) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' https://www.gstatic.com https://www.google-analytics.com; frame-ancestors 'self'">

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --brand:#0ea5a3;
      --bg:#f8fafc;
    }
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:#fff}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:#fff;z-index:10}
    .logo{display:flex;align-items:center;gap:10px}
    .logo svg{width:96px;height:28px}
    .toolbar{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.warn{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .btn.ghost{background:#fff}
    .pill{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
    main{padding:16px}
    .grid{border:1px solid var(--line);border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px 12px;text-align:left;font-size:14px;vertical-align:middle}
    th{background:#fafafa;font-weight:600}
    tr:hover{background:#fafcff}

    /* Actions button (icon-only) */
    .btn-actions{display:inline-flex;align-items:center;justify-content:center;gap:0;width:32px;height:32px;padding:0;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer;font-size:18px;line-height:1}
    .btn-actions:hover{background:#fafafa}

    /* FORCE-HIDE any delete triggers in list views */
    [aria-label="Delete"], [aria-label="Verwijderen"],
    button[title*="Delete"], button[title*="Verwijder"],
    a[title*="Delete"], a[title*="Verwijder"],
    .btn-delete, .delete, .del, [data-action="delete"], .action-delete,
    .fa-trash, .icon-trash { display:none !important; visibility:hidden !important; }

    /* ItemFolder overlay */
    .itemfolder-overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);z-index:9999;display:none}
    .itemfolder-overlay.open{display:block}
    .itemfolder{position:absolute;inset:32px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);
      display:flex;flex-direction:column;overflow:hidden}
    .itemfolder-header{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .itemfolder-title{font-size:18px;font-weight:800;color:var(--ink);display:flex;align-items:center;gap:10px}
    .itemfolder-body{height:100%;overflow:auto;background:linear-gradient(180deg,#f8fafc,#fff)}
    .itemfolder-footer{position:sticky;bottom:0;padding:10px 16px;border-top:1px solid var(--line);background:#fff;display:flex;justify-content:flex-end;gap:10px}

    /* Collapsible sections */
    .acc{border-bottom:1px solid var(--line);background:#fff}
    .acc-h{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer}
    .acc-h h3{margin:0;font-size:15px}
    .acc-h .count{font-size:12px;color:var(--muted)}
    .acc-b{display:none;padding:14px 16px;background:#fff}
    .acc.open .acc-b{display:block}

    /* Form grid */
    .formgrid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width: 900px){ .formgrid{grid-template-columns:1fr 1fr} }
    .field{display:flex;flex-direction:column;gap:.35rem}
    .field label{font-size:12px;color:var(--muted)}

    input[type="text"], textarea, select, input[type="date"]{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px
    }
    textarea{min-height:110px;resize:vertical}

    /* Related lists */
    .list{display:grid;grid-template-columns:1fr;gap:8px}
    @media(min-width:1000px){ .list{grid-template-columns:1fr 1fr} }
    .card{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px}
    .card h4{margin:0 0 6px 0;font-size:14px}
    .card p{margin:0;font-size:13px;color:var(--muted)}

    /* Accessibility utility */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Hide missing external logo (to avoid 404 noise) */
    img[src$="dorcas-logo.svg"]{display:none}
  </style>

  <!-- Firebase (v12) modules: app + firestore + analytics. Expose to window for inline scripts. -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import {
      getFirestore, doc, getDoc, getDocs, setDoc, deleteDoc, collection, query, where
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // === CONFIG: pas aan indien nodig ===
    const firebaseConfig = {
      apiKey: "AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps",
      authDomain: "griplog.firebaseapp.com",
      projectId: "griplog",
      storageBucket: "griplog.firebasestorage.app",
      messagingSenderId: "1097061844582",
      appId: "1:1097061844582:web:5fc1c25e320af9c9384fa7",
      measurementId: "G-NPE08326BM"
    };

    const app = initializeApp(firebaseConfig);
    try{
      if (location.protocol === "https:" || location.hostname === "localhost") {
        getAnalytics(app);
      }
    }catch(e){ console.warn("[Analytics] skipped", e); }

    // Expose to window
    window.app = app;
    window.firebaseApp = app;
    window.getFirestore = getFirestore;
    window.doc = doc;
    window.getDoc = getDoc;
    window.getDocs = getDocs;
    window.setDoc = setDoc;
    window.deleteDoc = deleteDoc;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.db = getFirestore(app);

    // Nested collections? (bv. "projects/XYZ/") -> stel hier in.
    window.GRID_BASE_PATH = ""; // e.g. "projects/XYZ/"
  </script>
</head>
<body>
  <header>
    <div class="logo" aria-label="Dorcas">
      <!-- Inline placeholder logo -->
      <svg viewBox="0 0 96 28" role="img" aria-label="Dorcas"><rect width="96" height="28" rx="6" fill="#0ea5a3"></rect><text x="12" y="19" font-family="system-ui, sans-serif" font-size="14" fill="#fff">Dorcas</text></svg>
      <span class="pill">Griplog</span>
    </div>
    <div class="toolbar">
      <button id="btnRefresh" class="btn">Refresh</button>
      <select id="roleSelect" aria-label="Kies rol">
        <option value="viewer">Viewer</option>
        <option value="editor">Editor</option>
        <option value="admin">Admin</option>
      </select>
    </div>
  </header>

  <main>
    <!-- Demo grid (je eigen tabellen blijven werken; dit is alleen als voorbeeld) -->
    <section class="grid" aria-label="Goals grid">
      <table id="goalsGrid">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Goal</th>
            <th scope="col">Owner</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="goalsTbody">
          <!-- Voorbeeld-rijen (verwijder gerust). Pattern G#, R#, I#, P#, Q#, S# wordt automatisch herkend. -->
          <tr data-id="G1">
            <td>G1</td><td>Voorbeeld doel</td><td>Team</td><td>Open</td><td></td>
          </tr>
          <tr data-id="G2">
            <td>G2</td><td>Veiligheid verbeteren</td><td>Kernteam</td><td>In progress</td><td></td>
          </tr>
        </tbody>
      </table>
    </section>

    <section style="margin-top:16px;color:var(--muted);font-size:13px">
      Tip: jouw bestaande lijsten/tabellen hoeven niet aangepast te worden. Deze pagina injecteert automatisch een üìÅ Actions-knop in elke rij
      waar een ID als <code>G12/R3/I7/P2/S4/Q9</code> zichtbaar is of als <code>data-id</code> attribuut staat.
    </section>
  </main>

  <!-- === ItemFolder Overlay === -->
  <div id="ItemFolderOverlay" class="itemfolder-overlay" aria-hidden="true">
    <div class="itemfolder" role="dialog" aria-modal="true">
      <div class="itemfolder-header">
        <div class="itemfolder-title">
          <span id="ItemFolderType">Item</span>
          <span id="ItemFolderId" style="opacity:.7"></span>
        </div>
        <div class="itemfolder-actions">
          <button class="btn" id="IF_CloseBtn" title="Sluiten">Close</button>
          <button class="btn primary" id="IF_SaveBtn" title="Opslaan">Save</button>
          <button class="btn warn" id="IF_DeleteBtn" title="Verwijderen">Delete</button>
        </div>
      </div>
      <div class="itemfolder-body" id="ItemFolderBody">
        <section class="acc open" id="IF_Section_Summary">
          <div class="acc-h"><h3>Summary</h3><div class="count"></div></div>
          <div class="acc-b">
            <div class="formgrid">
              <div class="field">
                <label for="IF_Title">Title</label>
                <input id="IF_Title" name="IF_Title" type="text" placeholder="Short title" autocomplete="off">
              </div>
              <div class="field">
                <label for="IF_Status">Status</label>
                <select id="IF_Status" name="IF_Status" aria-label="Status">
                  <option value="">‚Äî</option>
                  <option>Open</option><option>In progress</option><option>Blocked</option><option>Closed</option>
                </select>
              </div>
              <div class="field" style="grid-column:1/-1">
                <label for="IF_Description">Description</label>
                <textarea id="IF_Description" name="IF_Description" placeholder="Description"></textarea>
              </div>
              <div class="field" style="grid-column:1/-1">
                <label for="IF_Notes">Notes</label>
                <textarea id="IF_Notes" name="IF_Notes" placeholder="Notes"></textarea>
              </div>
            </div>
          </div>
        </section>

        <section class="acc" id="IF_Section_Risks">
          <div class="acc-h"><h3>Risks</h3><div class="count" id="IF_Count_Risks">0</div></div>
          <div class="acc-b">
            <div class="list" id="IF_List_Risks"></div>
            <div id="IF_New_Risk_Wrap" style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn primary" id="IF_AddRiskBtn">New Risk</button>
            </div>
          </div>
        </section>

        <section class="acc" id="IF_Section_Issues">
          <div class="acc-h"><h3>Issues</h3><div class="count" id="IF_Count_Issues">0</div></div>
          <div class="acc-b">
            <div class="list" id="IF_List_Issues"></div>
            <div id="IF_New_Issue_Wrap" style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn primary" id="IF_AddIssueBtn">New Issue</button>
            </div>
          </div>
        </section>

        <section class="acc" id="IF_Section_Plans">
          <div class="acc-h"><h3>Plans</h3><div class="count" id="IF_Count_Plans">0</div></div>
          <div class="acc-b">
            <div class="list" id="IF_List_Plans"></div>
            <div id="IF_New_Plan_Wrap" style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn primary" id="IF_AddPlanBtn">New Plan</button>
            </div>
          </div>
        </section>

        <section class="acc" id="IF_Section_Questions">
          <div class="acc-h"><h3>Questions</h3><div class="count" id="IF_Count_Questions">0</div></div>
          <div class="acc-b">
            <div class="list" id="IF_List_Questions"></div>
            <div id="IF_New_Question_Wrap" style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn primary" id="IF_AddQuestionBtn">New Question</button>
            </div>
          </div>
        </section>

        <section class="acc" id="IF_Section_Suggestions">
          <div class="acc-h"><h3>Suggestions</h3><div class="count" id="IF_Count_Suggestions">0</div></div>
          <div class="acc-b">
            <div class="list" id="IF_List_Suggestions"></div>
            <div id="IF_New_Suggestion_Wrap" style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn primary" id="IF_AddSuggestionBtn">New Suggestion</button>
            </div>
          </div>
        </section>

        <section class="acc" id="IF_Section_Notifications">
          <div class="acc-h"><h3>Notifications</h3><div class="count" id="IF_Count_Notifications">0</div></div>
          <div class="acc-b">
            <div class="list" id="IF_List_Notifications"></div>
            <div id="IF_New_Notification_Wrap" style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn" id="IF_AddNotificationBtn">New Notification</button>
            </div>
          </div>
        </section>

        <div class="itemfolder-footer">
          <button class="btn" id="IF_CancelBtn">Cancel</button>
          <button class="btn primary" id="IF_SaveBtn_Footer">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ==== Utilities & Config ====
  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const COLL_FOR = { goal:'goals', risk:'risks', issue:'issues', plan:'plans', question:'questions', suggestion:'suggestions', notification:'notifications' };
  const PREFIX_FOR = { goal:'G', risk:'R', issue:'I', plan:'P', question:'Q', suggestion:'S', notification:'N' };
  const CHILDREN_FOR = {
    goal: ['risk','issue','plan','question','suggestion','notification'],
    risk: ['issue','plan','question','suggestion'],
    issue:['plan','question','suggestion'],
    plan: ['question','suggestion']
  };
  window.CURRENT_ROLE = 'viewer';

  function basePathParts(){
    return (window.GRID_BASE_PATH||"").split('/').filter(Boolean);
  }
  function collRef(db, coll){
    const parts = basePathParts(); parts.push(coll);
    return window.collection(db, ...parts);
  }
  function docRef(db, coll, id){
    const parts = basePathParts(); parts.push(coll, id);
    return window.doc(db, ...parts);
  }

  // ==== ID compute ====
  async function computeNextId(collName, prefix){
    // scan doc IDs (cheap for small sets; for big sets, replace by a counter doc)
    let maxNum = 0;
    try{
      const snap = await window.getDocs(collRef(window.db, collName));
      snap.docs.forEach(d=>{
        const n = parseInt(String(d.id||'').replace(/\\D+/g,''),10);
        if(!isNaN(n) && n>maxNum) maxNum=n;
      });
    }catch(e){ console.warn('computeNextId fallback', e); }
    return prefix + String(maxNum+1);
  }

  // ==== ItemFolder ====
  window.ItemFolder = (function(){
    let ctx = { type:null, id:null, data:null };

    function isAdmin(){ return (window.CURRENT_ROLE === 'admin'); }
    function canEdit(t){
      if(isAdmin()) return true;
      if(window.CURRENT_ROLE === 'editor') return true;
      if(window.CURRENT_ROLE === 'viewer') return (t==='question' || t==='suggestion') ? false : false;
      return false;
    }
    function canDelete(){ return isAdmin(); }

    function titleFor(type, d){
      if(!d) return '';
      if(type==='goal') return d.goal || d.title || d.name || d.summary || '';
      if(type==='question' || type==='suggestion') return d.subject || d.title || d.summary || '';
      return d.title || d.summary || d.description || '';
    }
    function notesFor(d){ return (d && (d.notes||d.note||d.resolution||d.mitigation)) || ''; }

    async function loadItem(type, id){
      try{
        const coll = COLL_FOR[type];
        // try by doc id
        const snap = await window.getDoc(docRef(window.db, coll, id));
        if(snap.exists()) return snap.data();
        // fallback: by field 'id' or 'code'
        for(const field of ['id','code']){
          const qy = window.query(collRef(window.db, coll), window.where(field,'==', id));
          const qs = await window.getDocs(qy);
          if(qs.docs.length) return qs.docs[0].data();
        }
        return null;
      }catch(e){ console.warn('loadItem error', e); return null; }
    }

    async function open(type, id){
      ctx = { type, id, data:null };
      $('#ItemFolderType').textContent = type.charAt(0).toUpperCase()+type.slice(1);
      $('#ItemFolderId').textContent = '‚Ä¢ ' + id;
      $('#IF_SaveBtn').style.display = canEdit(type) ? '' : 'none';
      $('#IF_SaveBtn_Footer').style.display = canEdit(type) ? '' : 'none';
      $('#IF_DeleteBtn').style.display = canDelete() ? '' : 'none';

      $$('.acc').forEach(sec=>sec.classList.remove('open'));
      $('#IF_Section_Summary').classList.add('open');

      const data = await loadItem(type, id); ctx.data = data||{};
      // fill fields
      $('#IF_Title').value = titleFor(type, ctx.data);
      $('#IF_Status').value = ctx.data.status || '';
      $('#IF_Description').value = ctx.data.description || ctx.data.desc || '';
      $('#IF_Notes').value = notesFor(ctx.data);

      // show correct "new" buttons
      configureCreateButtons(type);

      // open overlay
      const ov = $('#ItemFolderOverlay'); ov.classList.add('open'); ov.setAttribute('aria-hidden','false');
    }

    function configureCreateButtons(parentType){
      const show = (id, flag)=>{ const el = $('#'+id); if(el) el.style.display = flag ? '' : 'none'; };
      ['IF_New_Risk_Wrap','IF_New_Issue_Wrap','IF_New_Plan_Wrap','IF_New_Question_Wrap','IF_New_Suggestion_Wrap','IF_New_Notification_Wrap']
        .forEach(id=>show(id,false));

      const allow = CHILDREN_FOR[parentType] || [];
      if(allow.includes('risk')) show('IF_New_Risk_Wrap', true);
      if(allow.includes('issue')) show('IF_New_Issue_Wrap', true);
      if(allow.includes('plan')) show('IF_New_Plan_Wrap', true);
      if(allow.includes('question')) show('IF_New_Question_Wrap', true);
      if(allow.includes('suggestion')) show('IF_New_Suggestion_Wrap', true);
      if(allow.includes('notification')) show('IF_New_Notification_Wrap', true);
    }

    function collectSummary(){
      return {
        title: $('#IF_Title').value.trim(),
        status: $('#IF_Status').value,
        description: $('#IF_Description').value.trim(),
        notes: $('#IF_Notes').value.trim(),
        updatedAt: Date.now()
      };
    }

    async function save(){
      if(!canEdit(ctx.type)) return;
      const coll = COLL_FOR[ctx.type];
      const up = collectSummary();
      // map back field names
      if(ctx.type==='goal'){ up.goal = up.title; delete up.title; }
      else if(ctx.type==='question' || ctx.type==='suggestion'){ up.subject = up.title; delete up.title; }
      try{
        await window.setDoc(docRef(window.db, coll, ctx.id), { ...(ctx.data||{}), ...up }, { merge:true });
        close();
      }catch(e){ alert('Save failed'); console.warn(e); }
    }

    async function doDelete(){
      if(!canDelete()) return;
      if(!confirm('Delete this item?')) return;
      try{
        await window.deleteDoc(docRef(window.db, COLL_FOR[ctx.type], ctx.id));
        close();
      }catch(e){ alert('Delete failed'); console.warn(e); }
    }

    function close(){
      const ov = $('#ItemFolderOverlay'); ov.classList.remove('open'); ov.setAttribute('aria-hidden','true');
    }

    // Lazy-load related lists when section opens
    async function lazyLoadRelated(kind){
      try{
        const type = ctx.type, id = ctx.id;
        let goalId = (type==='goal') ? id : (ctx.data && (ctx.data.parentGoalId || ctx.data.goalId));
        let riskId = (type==='risk') ? id : (ctx.data && ctx.data.parentRiskId);
        let issueId = (type==='issue') ? id : (ctx.data && ctx.data.parentIssueId);

        const listEl = $('#IF_List_'+capitalize(kind));
        const countEl = $('#IF_Count_'+capitalize(kind));
        if(!listEl) return;
        listEl.innerHTML = '<div class="card"><em>Loading‚Ä¶</em></div>';

        let qList = [];
        if(kind==='risks'){ if(goalId) qList.push( window.query(collRef(window.db,'risks'), window.where('parentGoalId','==',goalId)) ); }
        else if(kind==='issues'){
          if(goalId) qList.push( window.query(collRef(window.db,'issues'), window.where('parentGoalId','==',goalId)) );
          if(riskId) qList.push( window.query(collRef(window.db,'issues'), window.where('parentRiskId','==',riskId)) );
        }else if(kind==='plans'){
          if(goalId) qList.push( window.query(collRef(window.db,'plans'), window.where('parentGoalId','==',goalId)) );
          if(issueId) qList.push( window.query(collRef(window.db,'plans'), window.where('parentIssueId','==',issueId)) );
        }else if(kind==='questions'){
          if(goalId) qList.push( window.query(collRef(window.db,'questions'), window.where('parentGoalId','==',goalId)) );
          if(riskId) qList.push( window.query(collRef(window.db,'questions'), window.where('parentRiskId','==',riskId)) );
          if(issueId) qList.push( window.query(collRef(window.db,'questions'), window.where('parentIssueId','==',issueId)) );
        }else if(kind==='suggestions'){
          if(goalId) qList.push( window.query(collRef(window.db,'suggestions'), window.where('parentGoalId','==',goalId)) );
          if(riskId) qList.push( window.query(collRef(window.db,'suggestions'), window.where('parentRiskId','==',riskId)) );
          if(issueId) qList.push( window.query(collRef(window.db,'suggestions'), window.where('parentIssueId','==',issueId)) );
        }else if(kind==='notifications'){
          if(goalId) qList.push( window.query(collRef(window.db,'notifications'), window.where('parentGoalId','==',goalId)) );
        }

        let items = [];
        for(const qy of qList){
          const snap = await window.getDocs(qy);
          snap.docs.forEach(d=> items.push({ id:d.id, ...(typeof d.data==='function' ? d.data() : {}) }) );
        }

        if(items.length===0){
          listEl.innerHTML = '<div class="card"><em>No items.</em></div>';
        }else{
          listEl.innerHTML = items.map(it=>renderMiniCard(it, kind)).join('');
        }
        if(countEl) countEl.textContent = String(items.length);
      }catch(e){
        console.warn('lazyLoadRelated', kind, e);
        const listEl = $('#IF_List_'+capitalize(kind));
        if(listEl) listEl.innerHTML = '<div class="card"><em>Error loading.</em></div>';
      }
    }

    function renderMiniCard(it, kind){
      const title = it.title || it.name || it.summary || it.subject || it.id;
      const desc = it.description || it.desc || '';
      const pid = it.id || '';
      const type = kind.slice(0,-1);
      return `<div class="card">
        <h4>${escapeHtml(title)} <small style="opacity:.6">${escapeHtml(pid)}</small></h4>
        <p>${escapeHtml(desc).slice(0,180)}</p>
        <div style="margin-top:8px;display:flex;gap:6px;">
          <button class="btn" onclick="ItemFolder.open('${type}','${pid}')">Open</button>
        </div>
      </div>`;
    }

    // Create child
    async function createChild(childType){
      try{
        const parentType = ctx.type;
        const coll = { risk:'risks', issue:'issues', plan:'plans', question:'questions', suggestion:'suggestions', notification:'notifications' }[childType];
        const prefix = { risk:'R', issue:'I', plan:'P', question:'Q', suggestion:'S', notification:'N' }[childType];
        const id = await computeNextId(coll, prefix);
        const title = prompt(`Title for new ${childType}?`) || '';
        if(!title.trim()) return;

        const base = { id, title, createdAt: Date.now(), updatedAt: Date.now() };
        // link parents
        if(parentType==='goal'){ base.parentGoalId = ctx.id; }
        else if(parentType==='risk'){
          base.parentRiskId = ctx.id;
          base.parentGoalId = (ctx.data && (ctx.data.parentGoalId || ctx.data.goalId)) || '';
        }else if(parentType==='issue'){
          base.parentIssueId = ctx.id;
          base.parentGoalId = (ctx.data && (ctx.data.parentGoalId || ctx.data.goalId)) || '';
        }else if(parentType==='plan'){
          base.parentGoalId = (ctx.data && (ctx.data.parentGoalId || ctx.data.goalId)) || '';
        }

        await window.setDoc(docRef(window.db, coll, id), base);
        // refresh if its section is open
        const secId = 'IF_Section_' + (coll.charAt(0).toUpperCase()+coll.slice(1));
        const sec = $('#'+secId);
        if(sec && sec.classList.contains('open')){
          const kind = coll; // same naming
          await lazyLoadRelated(kind);
        }
      }catch(e){ alert('Create failed'); console.warn(e); }
    }

    // Helpers
    function capitalize(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }

    // Wire events
    document.addEventListener('click', (e)=>{
      const h = e.target.closest && e.target.closest('.acc-h');
      if(h){ const sec = h.parentElement; if(sec && sec.classList.contains('acc')){
        const opened = sec.classList.toggle('open');
        if(opened){
          const id = sec.id || '';
          if(id.endsWith('_Risks')) lazyLoadRelated('risks');
          if(id.endsWith('_Issues')) lazyLoadRelated('issues');
          if(id.endsWith('_Plans')) lazyLoadRelated('plans');
          if(id.endsWith('_Questions')) lazyLoadRelated('questions');
          if(id.endsWith('_Suggestions')) lazyLoadRelated('suggestions');
          if(id.endsWith('_Notifications')) lazyLoadRelated('notifications');
        }
      }}

      if(e.target && e.target.id==='IF_AddRiskBtn') createChild('risk');
      if(e.target && e.target.id==='IF_AddIssueBtn') createChild('issue');
      if(e.target && e.target.id==='IF_AddPlanBtn') createChild('plan');
      if(e.target && e.target.id==='IF_AddQuestionBtn') createChild('question');
      if(e.target && e.target.id==='IF_AddSuggestionBtn') createChild('suggestion');
      if(e.target && e.target.id==='IF_AddNotificationBtn') createChild('notification');

      if(e.target && e.target.id==='IF_CloseBtn') close();
      if(e.target && e.target.id==='IF_CancelBtn') close();
      if(e.target && (e.target.id==='IF_SaveBtn' || e.target.id==='IF_SaveBtn_Footer')) save();
      if(e.target && e.target.id==='roleSelect'){
        window.CURRENT_ROLE = e.target.value;
      }
    });

    return { open, loadItem };
  })();

  // ==== Grid augmentation: inject üìÅ and hide delete ====
  (function(){
    function inferTypeFromId(id){
      return ({'G':'goal','R':'risk','I':'issue','P':'plan','S':'suggestion','Q':'question'}[(id||'')[0]?.toUpperCase()] ) || null;
    }
    function findIdInRow(row){
      if(row.dataset && row.dataset.id && /^[GRIPSQ]\d+$/i.test(row.dataset.id)) return row.dataset.id.toUpperCase();
      let cell = row.querySelector('[data-col="id"], .col-id, [data-field="id"]');
      if(cell){
        const m = (cell.textContent||'').match(/\b([GRIPSQ]\d{1,8})\b/i);
        if(m) return m[1].toUpperCase();
      }
      const m = (row.innerText||'').match(/\b([GRIPSQ]\d{1,8})\b/i);
      if(m) return m[1].toUpperCase();
      return null;
    }
    function injectActions(row, id){
      if(row.querySelector('.btn-actions')) return;
      const type = inferTypeFromId(id); if(!type) return;
      const btn = document.createElement('button');
      btn.className='btn-actions'; btn.type='button'; btn.setAttribute('title','Open folder'); btn.setAttribute('aria-label','Open folder'); btn.textContent='üìÅ';
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); ItemFolder.open(type, id); });
      const lastCell = row.querySelector('td:last-child') || row;
      const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.justifyContent='flex-end';
      wrap.appendChild(btn); lastCell.appendChild(wrap);
      row.classList.add('folder-injected');
      row.addEventListener('dblclick', ()=> ItemFolder.open(type,id) );
    }
    function hideDelete(){
      document.querySelectorAll('button, a, [role="button"]').forEach(el=>{
        const t = (el.textContent||'').trim().toLowerCase();
        const title = (el.title||'').toLowerCase();
        if(el.matches('.btn-delete,.delete,.del,[data-action="delete"],.action-delete,[aria-label="Delete"],[aria-label="Verwijderen"]') || /\bdelete\b|\bverwijder/.test(t+title)){
          el.style.display='none'; el.style.visibility='hidden';
        }
      });
    }
    function AUGMENT(){
      hideDelete();
      document.querySelectorAll('tr, .row, .grid-row').forEach(row=>{
        if(row.classList && row.classList.contains('folder-injected')) return;
        const id = findIdInRow(row);
        if(id) injectActions(row, id);
      });
    }
    document.addEventListener('DOMContentLoaded', AUGMENT);
    window.addEventListener('load', AUGMENT);
    setInterval(AUGMENT, 1200); // keep it simple for dynamic grids
  })();

  // ==== Demo: refresh button (no-op placeholder) ====
  document.getElementById('btnRefresh').addEventListener('click', ()=>location.reload());
  </script>
</body>
</html>
