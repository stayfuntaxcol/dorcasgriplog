<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GRIPlog – Honey Value Chain (Invulkaart + Boomgrafiek)</title>
<link rel="icon" href="assets/dorcas-logo.svg" />
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --brand:#0ea5a3; --danger:#ef4444; --ok:#10b981;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  header{display:flex;align-items:flex-start;gap:12px;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
  header img{height:34px;width:auto}
  header .title{font-weight:800;font-size:18px}
  header .sub{color:var(--muted);font-size:12px}
  .header-left{display:flex;gap:12px;align-items:center}
  .header-right{margin-left:auto;text-align:right;display:flex;flex-direction:column;gap:4px;align-items:flex-end}
  .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
  .dot{width:8px;height:8px;border-radius:999px;background:#bbb}
  .ok{background:var(--ok)}
  .user-info{font-size:12px;color:var(--ink);text-transform:lowercase}

  .toolbar{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:10px 16px;background:#f0f5f5;border-bottom:1px solid var(--line)}
  .leftbar{display:flex;gap:8px;align-items:center}
  .rightbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .input, select, input[type="text"], input[type="password"], input[type="email"]{border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff;font-size:14px}
  .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:14px}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.ghost{background:transparent}
  /* Grijstinten: Edit / Save / Delete */
  .btn.edit{background:#f8fafc;border-color:#d1d5db;color:#111827}
  .btn.save{background:#e5e7eb;border-color:#d1d5db;color:#111827}
  .btn.delete{background:#111827;border-color:#111827;color:#fff}

  nav.tabs{display:flex;gap:8px;padding:10px 16px;background:var(--card);border-bottom:1px solid var(--line)}
  nav.tabs button{border:none;background:#eaf6f6;color:#065a59;padding:8px 10px;border-radius:10px;font-weight:700;cursor:pointer}
  nav.tabs button.active{background:#0ea5a3;color:#fff}
  nav.tabs .push-right{margin-left:auto}

  section{display:none;padding:14px 16px}
  section.active{display:block}

  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
  h2{margin:0;font-size:18px}
  .sectionbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:6px 0}
  .sectionbar .left{display:flex;gap:8px;align-items:center}
  .sectionbar .right{display:flex;gap:8px;align-items:center}

  table{width:100%;border-collapse:collapse}
  th, td{border:1px solid var(--line);padding:6px 8px;vertical-align:top;font-size:14px;background:#fff}
  th{background:#f9fbfb;text-align:left}
  thead tr.filters th{background:#fff}
  .row-actions{display:flex;gap:6px}
  .cell-text{white-space:pre-wrap}

  /* Overlay Invulkaart */
  #overlay{position:fixed;inset:0;display:none;z-index:1000}
  #overlay.show{display:block}
  .ov-backdrop{position:absolute;inset:0;background:rgba(15,23,42,.55);backdrop-filter:blur(2px)}
  .ov-panel{position:absolute;inset:24px;display:flex;flex-direction:column;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
  .ov-header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#fff,#f8fafc)}
  .ov-title{font-weight:800;font-size:16px}
  .ov-body{padding:12px 16px;overflow:auto}
  .ov-footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:space-between;align-items:center}
  .ov-actions{display:flex;gap:8px}
  .ov-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .block{grid-column:span 12;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .form-row{display:grid;grid-template-columns:160px 1fr;gap:10px;margin:8px 0}
  .form-row label{color:var(--muted);font-size:12px;padding-top:6px}
  .form-row input,.form-row textarea,.form-row select{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;font-size:14px}
  .form-row textarea{min-height:96px;resize:vertical}

  /* Boomgrafiek */
  .ov-body .ov-split{display:flex;gap:16px}
  .ov-left{flex:1.3;min-width:0}
  .ov-right{flex:0.7;min-width:260px;max-width:520px;border-left:1px solid #e5e7eb;padding-left:12px}
  .tree-wrap{max-height:100%;height:100%;overflow-x:auto;overflow-y:auto;padding-bottom:8px}
  .tree, .tree ul{list-style:none;margin:0;padding-left:14px;position:relative}
  .tree ul:before{content:'';position:absolute;left:6px;top:0;bottom:0;border-left:1px solid #d1d5db}
  .tree li{position:relative;margin:0;padding:8px 0 0 12px}
  .tree li:before{content:'';position:absolute;left:6px;top:18px;width:10px;border-top:1px solid #d1d5db}
  .node{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #cbd5e1;border-radius:14px;background:linear-gradient(180deg,#fff,#f9fafb);font-weight:600;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);transition:transform .15s ease,box-shadow .15s ease,border-color .15s ease;cursor:pointer}
  .node:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.08)}
  .node small{font-weight:500;color:#6b7280;margin-left:6px}
  .node.goal{background:#eef2ff;border-color:#c7d2fe}
  .node.risk{background:#fef3c7;border-color:#fde68a}
  .node.issue{background:#fee2e2;border-color:#fecaca}
  .node.plan{background:#dcfce7;border-color:#bbf7d0}
  .node.question{background:#e0f2fe;border-color:#bae6fd}
  .node.suggestion{background:#f3e8ff;border-color:#e9d5ff}
  /* Huidig item duidelijk groter */
  .node.current{transform:scale(1.14);border-color:#6366f1;box-shadow:0 10px 22px rgba(99,102,241,.22);padding:10px 14px;font-size:13px}

  /* Actieknop in rijen */
  .row-actions .btn{padding:6px 10px}
</style>
</head>
<body>
  <header>
    <div class="header-left">
      <img src="assets/dorcas-logo.svg" alt="Dorcas" onerror="this.style.display='none'">
      <div>
        <div class="title">GRIPlog – Honey Value Chain (Kitui)</div>
        <div class="sub">Get a GRIP: Goals • Risks • Issues • Plans • Questions • Suggestions • Notifications</div>
      </div>
    </div>
    <div class="header-right">
      <span class="chip"><span id="authDot" class="dot"></span><span id="authTxt">not signed in</span></span>
      <span id="userInfo" class="user-info"></span>
    </div>
  </header>

  <div class="toolbar">
    <div class="leftbar">
      <button id="btnLoad" class="btn">Load Database</button>
      <button id="btnSaveAll" class="btn primary" disabled>Save to Database</button>
    </div>
    <div class="rightbar">
      <input id="fullName" class="input" placeholder="full name *" />
      <input id="email" class="input" type="email" placeholder="email (required for editors)" />
      <input id="org" class="input" placeholder="organization *" />
      <select id="role" class="input">
        <option value="Viewer" selected>Viewer (read-only)</option>
        <option>Admin</option>
        <option>Projectmanager</option>
        <option>Strategic Program Advisor</option>
        <option>Thematic Expert</option>
      </select>
      <input id="password" class="input" type="password" placeholder="password *" />
      <button id="btnSignup" class="btn">register</button>
      <button id="btnSignin" class="btn primary">login</button>
      <button id="btnSignout" class="btn" style="display:none">logout</button>
    </div>
  </div>

  <!-- Tabs -->
  <nav class="tabs" role="tablist">
    <button class="active" data-tab="goals">G – Goals</button>
    <button data-tab="risks">R – Risks</button>
    <button data-tab="issues">I – Issues</button>
    <button data-tab="plans">P – Plans</button>
    <button class="push-right" data-tab="questions">Q – Questions</button>
    <button data-tab="suggestions">S – Suggestions</button>
    <button data-tab="notifications">N – Notifications</button>
  </nav>

  <!-- Goals -->
  <section id="goals" class="active" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left">
          <h2>Goals</h2>
          <button class="btn" id="addGoalBtn" disabled>+ New Goal</button>
        </div>
        <div class="right"></div>
      </div>
      <table id="tblGoals">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Goal (SMART)</th>
            <th style="width:160px">Owner</th>
            <th style="width:130px">Start</th>
            <th style="width:130px">End</th>
            <th style="width:140px">Status</th>
            <th>DateStamp</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="gSearch" class="input" placeholder="search goal/notes" /></th>
            <th><select id="gOwner" class="input"></select></th>
            <th><input type="date" id="gStartFrom" class="input" /></th>
            <th><input type="date" id="gEndTo" class="input" /></th>
            <th><select id="gStatus" class="input"></select></th>
            <th></th>
            <th><button id="gReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Risks -->
  <section id="risks" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left">
          <h2>Risks</h2>
          <button class="btn" id="addRiskBtn" disabled>+ New Risk</button>
        </div>
        <div class="right"></div>
      </div>
      <table id="tblRisks">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:160px">Owner</th>
            <th style="width:120px">Likelihood</th>
            <th style="width:120px">Impact</th>
            <th style="width:140px">Status</th>
            <th>DateStamp</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="rSearch" class="input" placeholder="search description/mitigation" /></th>
            <th><select id="rOwner" class="input"></select></th>
            <th><select id="rLikelihood" class="input"></select></th>
            <th><select id="rImpact" class="input"></select></th>
            <th><select id="rStatus" class="input"></select></th>
            <th></th>
            <th><button id="rReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Issues -->
  <section id="issues" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left">
          <h2>Issues</h2>
          <button class="btn" id="addIssueBtn" disabled>+ New Issue</button>
        </div>
        <div class="right"></div>
      </div>
      <table id="tblIssues">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:160px">Owner</th>
            <th style="width:120px">Severity</th>
            <th style="width:140px">Status</th>
            <th>DateStamp</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="iSearch" class="input" placeholder="search description/resolution" /></th>
            <th><select id="iOwner" class="input"></select></th>
            <th><select id="iSeverity" class="input"></select></th>
            <th><select id="iStatus" class="input"></select></th>
            <th></th>
            <th><button id="iReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Plans -->
  <section id="plans" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left">
          <h2>Plans</h2>
          <button class="btn" id="addPlanBtn" disabled>+ New Plan</button>
        </div>
        <div class="right"></div>
      </div>
      <table id="tblPlans">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:160px">Owner</th>
            <th>Goal Link</th>
            <th style="width:130px">Start</th>
            <th style="width:130px">End</th>
            <th style="width:140px">Status</th>
            <th>DateStamp</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="pSearch" class="input" placeholder="search description" /></th>
            <th><select id="pOwner" class="input"></select></th>
            <th><input type="text" id="pGoalId" class="input" placeholder="G1, G2…" /></th>
            <th></th>
            <th></th>
            <th><select id="pStatus" class="input"></select></th>
            <th></th>
            <th><button id="pReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Questions (zonder user-label + zonder Comments-kolom) -->
  <section id="questions" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left">
          <h2>Questions</h2>
          <button class="btn" id="addQuestionBtn">+ New Question</button>
        </div>
        <div class="right"></div>
      </div>
      <table id="tblQuestions">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:150px">Subject</th>
            <th style="width:160px">Owner</th>
            <th style="width:130px">Submitted</th>
            <th style="width:130px">Status</th>
            <th style="width:160px">Reviewer Role</th>
            <th style="width:130px">Reviewed</th>
            <th class="col-stars" style="width:120px">Stars</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="qSearch" class="input" placeholder="search description" /></th>
            <th><select id="qSubject" class="input"></select></th>
            <th><select id="qOwner" class="input"></select></th>
            <th><input type="date" id="qSubmitted" class="input" /></th>
            <th><select id="qStatus" class="input"></select></th>
            <th><select id="qReviewerRole" class="input"></select></th>
            <th><input type="date" id="qReviewed" class="input" /></th>
            <th></th>
            <th><button id="qReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Suggestions (zonder user-label + zonder Comments-kolom) -->
  <section id="suggestions" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left">
          <h2>Suggestions</h2>
          <button class="btn" id="addSuggestionBtn">+ New Suggestion</button>
        </div>
        <div class="right"></div>
      </div>
      <table id="tblSuggestions">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:150px">Subject</th>
            <th style="width:160px">Owner</th>
            <th style="width:130px">Submitted</th>
            <th style="width:130px">Status</th>
            <th style="width:160px">Reviewer Role</th>
            <th style="width:130px">Reviewed</th>
            <th class="col-stars" style="width:120px">Stars</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="sSearch" class="input" placeholder="search description" /></th>
            <th><select id="sSubject" class="input"></select></th>
            <th><select id="sOwner" class="input"></select></th>
            <th><input type="date" id="sSubmitted" class="input" /></th>
            <th><select id="sStatus" class="input"></select></th>
            <th><select id="sReviewerRole" class="input"></select></th>
            <th><input type="date" id="sReviewed" class="input" /></th>
            <th></th>
            <th><button id="sReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Notifications (zonder user-label + zonder Comments-kolom) -->
  <section id="notifications" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left"><h2>Notifications</h2></div>
        <div class="right"></div>
      </div>
      <table id="tblNotifications">
        <thead>
          <tr class="labels">
            <th style="width:80px">ID</th>
            <th>Description</th>
            <th style="width:160px">Subject</th>
            <th style="width:140px">Status</th>
            <th style="width:160px">Role</th>
            <th style="width:140px">Date</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th><input type="text" id="nId" class="input" placeholder="G1/R2/..."/></th>
            <th><input type="text" id="nSearch" class="input" placeholder="search description"/></th>
            <th><select id="nSubject" class="input"></select></th>
            <th><select id="nStatus" class="input"></select></th>
            <th><select id="nRole" class="input"></select></th>
            <th><input type="date" id="nFrom" class="input"/> – <input type="date" id="nTo" class="input"/></th>
            <th><button id="nReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="help" style="color:#64748b;font-size:12px;margin:8px 0 0">Only <strong>Admin</strong> can edit or delete rows in this logbook.</p>
    </div>
  </section>

  <footer style="padding:16px;color:var(--muted);font-size:12px">© <span id="yr"></span> Dorcas / GRIPlog – role-based viewer/editor.</footer>

  <!-- Overlay -->
  <div id="overlay" aria-hidden="true">
    <div class="ov-backdrop"></div>
    <div class="ov-panel" role="dialog" aria-modal="true" aria-labelledby="ovTitle">
      <div class="ov-header">
        <div class="ov-title" id="ovTitle">New Item</div>
        <div><button class="btn" id="ovClose">Close</button></div>
      </div>
      <div class="ov-body">
        <div class="ov-split">
          <div class="ov-left">
            <div class="block" id="ovFormBlock">
              <!-- dynamic form -->
            </div>
          </div>
          <div class="ov-right">
            <h4>Boomgrafiek</h4>
            <div class="tree-wrap"><div id="tree" class="tree"></div></div>
          </div>
        </div>
      </div>
      <div class="ov-footer">
        <div class="ov-hint" id="ovHint" style="font-size:12px;color:#64748b"></div>
        <div class="ov-actions">
          <button class="btn edit" id="ovEdit" style="display:none">Edit</button>
          <button class="btn save" id="ovSave">Save</button>
          <button class="btn delete" id="ovDelete" style="display:none">Delete</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, getDocs, setDoc, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps",
    authDomain: "griplog.firebaseapp.com",
    projectId: "griplog",
    storageBucket: "griplog.appspot.com",
    messagingSenderId: "1097061844582",
    appId: "1:1097061844582:web:5fc1c25e320af9c9384fa7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const $  = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
  $('#yr').textContent = new Date().getFullYear();

  // ---------- Loginvelden onthouden (localStorage) ----------
  const LS = {
    set:(k,v)=>localStorage.setItem(k,v),
    get:(k)=>localStorage.getItem(k)||'',
  };
  const loginFields = ['fullName','email','org','role'];
  loginFields.forEach(id=>{
    const el = $('#'+id);
    const val = LS.get('login.'+id);
    if(val) el.value = val;
    el.addEventListener('change',()=>LS.set('login.'+id, el.value));
    el.addEventListener('blur',()=>LS.set('login.'+id, el.value));
  });

  // ---------- Role / Edit ----------
  const EDIT_ROLES = new Set(['Admin','Projectmanager','Strategic Program Advisor','Thematic Expert']);
  let CAN_EDIT=false; let CURRENT_UID=null; let CURRENT_ROLE='Viewer'; let CURRENT_NAME='';
  function setEditMode(can){
    CAN_EDIT=!!can;
    $('#btnSaveAll').disabled=!CAN_EDIT;
    $('#addGoalBtn').disabled=!CAN_EDIT;
    $('#addRiskBtn').disabled=!CAN_EDIT;
    $('#addIssueBtn').disabled=!CAN_EDIT;
    $('#addPlanBtn').disabled=!CAN_EDIT;
    renderAll();
  }

  function slugEmailFromName(name){ return name.trim().toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,40)+"@griplog.local"; }
  async function upsertUserDoc(uid, data){
    const ref=doc(db,'users',uid); const snap=await getDoc(ref);
    await setDoc(ref, snap.exists()? {...snap.data(), ...data} : data, {merge:true});
  }

  $('#btnSignup').onclick=async ()=>{
    const fullName=$('#fullName').value.trim(); const email=($('#email').value||'').trim();
    const org=$('#org').value.trim(); const role=$('#role').value; const pass=$('#password').value;
    if(!fullName||!org||!pass){ alert('fill required fields'); return; }
    if(EDIT_ROLES.has(role) && !email){ alert('email required for editors'); return; }
    const used=email||slugEmailFromName(fullName);
    try{
      const cred=await createUserWithEmailAndPassword(auth, used, pass);
      await updateProfile(cred.user,{displayName:fullName});
      await upsertUserDoc(cred.user.uid,{ fullName, email: email||'', org, role, createdAt: (new Date()).toISOString() });
      alert('registered. please login.'); await signOut(auth);
    }catch(e){ alert(e.code==='auth/email-already-in-use' ? 'account exists. login.' : e.message); }
  };
  $('#btnSignin').onclick=async ()=>{
    const fullName=$('#fullName').value.trim(); const email=($('#email').value||'').trim();
    const rolePick=$('#role').value; const pass=$('#password').value;
    if(!fullName||!pass){ alert('fill required fields'); return; }
    if(EDIT_ROLES.has(rolePick) && !email){ alert('email required for editors'); return; }
    const used=email||slugEmailFromName(fullName);
    try{
      const cred=await signInWithEmailAndPassword(auth, used, pass);
      if(EDIT_ROLES.has(rolePick) && email){ await upsertUserDoc(cred.user.uid,{ role: rolePick, email, fullName }); }
    }catch(e){ alert('login failed: '+e.message); }
  };
  $('#btnSignout').onclick=()=>signOut(auth);

  onAuthStateChanged(auth, async (user)=>{
    const authDot=$('#authDot'), authTxt=$('#authTxt'), userInfo=$('#userInfo');
    if(!user){
      authDot.classList.remove('ok'); authTxt.textContent='not signed in'; userInfo.textContent='';
      $('#btnSignout').style.display='none'; setEditMode(false);
      CURRENT_UID=null; CURRENT_ROLE='Viewer'; CURRENT_NAME='';
      return;
    }
    $('#btnSignout').style.display='inline-block'; authDot.classList.add('ok');
    CURRENT_UID=user.uid; CURRENT_NAME=user.displayName||user.email||'';
    let role='Viewer', full=user.displayName||user.email||'';
    try{
      const snap=await getDoc(doc(db,'users',user.uid));
      if(snap.exists()){
        const d=snap.data();
        role=d.role||role; full=d.fullName||full;
        if(EDIT_ROLES.has(role) && !(user.email&&user.email.length)) role='Viewer';
      }else{
        await upsertUserDoc(user.uid,{ fullName: full, email: user.email||'', role: 'Viewer' });
      }
    }catch(err){ console.warn('role load failed', err); }
    CURRENT_ROLE=role; CURRENT_NAME=full;
    const isEditor = EDIT_ROLES.has(role) && !!user.email;
    authTxt.textContent = isEditor? 'editor' : 'viewer';
    userInfo.textContent = `${(full||'').toLowerCase()} – ${role.toLowerCase()}`;
    setEditMode(isEditor);
    await loadAll();
  });

  // ---------- Data + helpers ----------
  let DATA_READY=false;
  function disableNewButtons(disabled=true){
    ['addGoalBtn','addRiskBtn','addIssueBtn','addPlanBtn'].forEach(id=>{
      const el = document.getElementById(id); if(el) el.disabled = disabled;
    });
  }
  disableNewButtons(true);

  const owners=["","Coop Board","Kamaki Cooperative","QA Manager","Operations Lead","Value Add Manager","MRDP Field Coord.","SEKU (QA Lab)","Finance Lead","Sales Lead","County Govt Kitui","Dorcas Kenya","Program Manager","Procurement","FFS Coordinator","Partner/Sponsor"];
  const statuses={ goals:["","Open","In progress","Done"], risks:["","Open","In progress","Done"], issues:["","Open","In progress","Blocked","Done"], plans:["","Open","In progress","Done"] };
  const tri=["","Low","Medium","High"];
  const suggestionSubjects=["","New Goal","New Risk","New Issue","New Plan"];
  const suggestionStatus=["","Approved","Pending","Dismissed"];
  const suggestionReviewer=["","Admin","Strategic Program Advisor","Thematic Expert","Projectmanager"];
  const noteSubjects=["","Goal","Risk","Issue","Plan","Suggestion","Question","New Goal","New Risk","New Issue","New Plan","New Suggestion","New Question"];
  const noteStatus=["","Added","Edited","Deleted","Approved","Pending","Dismissed"];
  const noteRoles=["","Admin","Projectmanager","Strategic Program Advisor","Thematic Expert","Viewer"];

  let cache={goals:[],risks:[],issues:[],plans:[],suggestions:[],questions:[],notifications:[]};

  const getNum = (id)=>parseInt(String(id||'').replace(/\D+/g,'')||'0',10);
  function idSort(a,b){
    const na=getNum(a.id), nb=getNum(b.id);
    if(na!==nb) return na-nb;
    return String(a.id||'').localeCompare(String(b.id||''));
  }

  async function loadAll(){
    const [g,r,i,p,s,q] = await Promise.all([
      getDocs(collection(db,'goals')),
      getDocs(collection(db,'risks')),
      getDocs(collection(db,'issues')),
      getDocs(collection(db,'plans')),
      getDocs(collection(db,'suggestions')),
      getDocs(collection(db,'questions')),
    ]);
    cache.goals = g.docs.map(d=>({id:d.id,...d.data()}));
    cache.risks  = r.docs.map(d=>({id:d.id,...d.data()}));
    cache.issues = i.docs.map(d=>({id:d.id,...d.data()}));
    cache.plans  = p.docs.map(d=>({id:d.id,...d.data()}));
    cache.suggestions = s.docs.map(d=>({id:d.id,...d.data()}));
    cache.questions   = q.docs.map(d=>({id:d.id,...d.data()}));
    buildFilterOptions();
    renderAll();
    DATA_READY=true; disableNewButtons(false);
  }
  $('#btnLoad').onclick=loadAll;
  $('#btnSaveAll').onclick=()=>alert('Tabel-massasave niet nodig; gebruik de Invulkaart (Save).');

  function fillSelect(sel, arr, ph){ const el=$(sel); if(!el) return; el.innerHTML = arr.map((v,i)=>`<option value="${v}">${i===0? (ph||'Any') : v}</option>`).join(''); }
  function buildFilterOptions(){
    fillSelect('#gOwner', owners, 'Owner'); fillSelect('#gStatus', statuses.goals, 'Status');
    fillSelect('#rOwner', owners, 'Owner'); fillSelect('#rLikelihood', tri, 'Likelihood'); fillSelect('#rImpact', tri, 'Impact'); fillSelect('#rStatus', statuses.risks, 'Status');
    fillSelect('#iOwner', owners, 'Owner'); fillSelect('#iSeverity', tri, 'Severity'); fillSelect('#iStatus', statuses.issues, 'Status');
    fillSelect('#pOwner', owners, 'Owner'); fillSelect('#pStatus', statuses.plans, 'Status');

    fillSelect('#sSubject', suggestionSubjects, 'Subject');
    fillSelect('#sOwner', owners, 'Owner');
    fillSelect('#sStatus', suggestionStatus, 'Status');
    fillSelect('#sReviewerRole', suggestionReviewer, 'Reviewer Role');

    fillSelect('#qSubject', suggestionSubjects, 'Subject');
    fillSelect('#qOwner', owners, 'Owner');
    fillSelect('#qStatus', suggestionStatus, 'Status');
    fillSelect('#qReviewerRole', suggestionReviewer, 'Reviewer Role');

    fillSelect('#nSubject', noteSubjects, 'Subject');
    fillSelect('#nStatus', noteStatus, 'Status');
    fillSelect('#nRole', noteRoles, 'Role');

    // filters event
    ['gOwner','gStatus','gStartFrom','gEndTo','gSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderGoals));
    ['rOwner','rLikelihood','rImpact','rStatus','rSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderRisks));
    ['iOwner','iSeverity','iStatus','iSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderIssues));
    ['pOwner','pStatus','pGoalId','pSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderPlans));
    ['sSubject','sOwner','sSubmitted','sStatus','sReviewerRole','sReviewed','sSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderSuggestions));
    ['qSubject','qOwner','qSubmitted','qStatus','qReviewerRole','qReviewed','qSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderQuestions));
    ['nId','nSearch','nSubject','nStatus','nRole','nFrom','nTo'].forEach(id=> $('#'+id)?.addEventListener('input', ()=>renderNotifications(cache.notifications)));

    $('#gReset')?.addEventListener('click', ()=>{ ['gOwner','gStatus','gStartFrom','gEndTo','gSearch'].forEach(i=>$('#'+i).value=''); renderGoals(); });
    $('#rReset')?.addEventListener('click', ()=>{ ['rOwner','rLikelihood','rImpact','rStatus','rSearch'].forEach(i=>$('#'+i).value=''); renderRisks(); });
    $('#iReset')?.addEventListener('click', ()=>{ ['iOwner','iSeverity','iStatus','iSearch'].forEach(i=>$('#'+i).value=''); renderIssues(); });
    $('#pReset')?.addEventListener('click', ()=>{ ['pOwner','pStatus','pGoalId','pSearch'].forEach(i=>$('#'+i).value=''); renderPlans(); });
    $('#sReset')?.addEventListener('click', ()=>{ ['sSubject','sOwner','sSubmitted','sStatus','sReviewerRole','sReviewed','sSearch'].forEach(i=>$('#'+i).value=''); renderSuggestions(); });
    $('#qReset')?.addEventListener('click', ()=>{ ['qSubject','qOwner','qSubmitted','qStatus','qReviewerRole','qReviewed','qSearch'].forEach(i=>$('#'+i).value=''); renderQuestions(); });
    $('#nReset')?.addEventListener('click', ()=>{ ['nId','nSearch','nSubject','nStatus','nRole','nFrom','nTo'].forEach(i=>$('#'+i).value=''); renderNotifications(cache.notifications); });
  }

  // ---------- Renderers ----------
  function actionsCell(coll, id){ return `<div class="row-actions"><button class="btn" data-menu="${coll}" data-id="${id}">Menu</button></div>`; }
  function rowGoal(r){
    const ownerSel = `<select disabled>${owners.map(o=>`<option ${o===(r.owner||'')?'selected':''}>${o}</option>`).join('')}</select>`;
    const statusSel= `<select disabled>${statuses.goals.map(s=>`<option ${s===(r.status||'')?'selected':''}>${s}</option>`).join('')}</select>`;
    const start = `<input type="date" value="${r.start||''}" disabled />`;
    const end   = `<input type="date" value="${r.end||''}" disabled />`;
    return `<td>${r.id||''}</td>
      <td><div class="cell-text">${(r.goal||'')}</div></td>
      <td>${ownerSel}</td>
      <td>${start}</td>
      <td>${end}</td>
      <td>${statusSel}</td>
      <td>${r.dateStamp||''}</td>
      <td>${actionsCell('goals', r.id)}</td>`;
  }
  function rowRisk(r){
    const ownerSel = `<select disabled>${owners.map(o=>`<option ${o===(r.owner||'')?'selected':''}>${o}</option>`).join('')}</select>`;
    const likeSel  = `<select disabled>${tri.map(v=>`<option ${v===(r.likelihood||'')?'selected':''}>${v}</option>`).join('')}</select>`;
    const impSel   = `<select disabled>${tri.map(v=>`<option ${v===(r.impact||'')?'selected':''}>${v}</option>`).join('')}</select>`;
    const statusSel= `<select disabled>${statuses.risks.map(s=>`<option ${s===(r.status||'')?'selected':''}>${s}</option>`).join('')}</select>`;
    return `<td>${r.id||''}</td>
      <td><div class="cell-text">${(r.description||'')}</div></td>
      <td>${ownerSel}</td>
      <td>${likeSel}</td>
      <td>${impSel}</td>
      <td>${statusSel}</td>
      <td>${r.dateStamp||''}</td>
      <td>${actionsCell('risks', r.id)}</td>`;
  }
  function rowIssue(r){
    const ownerSel = `<select disabled>${owners.map(o=>`<option ${o===(r.owner||'')?'selected':''}>${o}</option>`).join('')}</select>`;
    const sevSel   = `<select disabled>${tri.map(v=>`<option ${v===(r.severity||'')?'selected':''}>${v}</option>`).join('')}</select>`;
    const statusSel= `<select disabled>${statuses.issues.map(s=>`<option ${s===(r.status||'')?'selected':''}>${s}</option>`).join('')}</select>`;
    return `<td>${r.id||''}</td>
      <td><div class="cell-text">${(r.description||'')}</div></td>
      <td>${ownerSel}</td>
      <td>${sevSel}</td>
      <td>${statusSel}</td>
      <td>${r.dateStamp||''}</td>
      <td>${actionsCell('issues', r.id)}</td>`;
  }
  function rowPlan(r){
    const ownerSel = `<select disabled>${owners.map(o=>`<option ${o===(r.owner||'')?'selected':''}>${o}</option>`).join('')}</select>`;
    const statusSel= `<select disabled>${statuses.plans.map(s=>`<option ${s===(r.status||'')?'selected':''}>${s}</option>`).join('')}</select>`;
    const start = `<input type="date" value="${r.start||''}" disabled />`;
    const end   = `<input type="date" value="${r.end||''}" disabled />`;
    return `<td>${r.id||''}</td>
      <td><div class="cell-text">${(r.description||'')}</div></td>
      <td>${ownerSel}</td>
      <td><input type="text" value="${(r.goalId||'')}" disabled /></td>
      <td>${start}</td>
      <td>${end}</td>
      <td>${statusSel}</td>
      <td>${r.dateStamp||''}</td>
      <td>${actionsCell('plans', r.id)}</td>`;
  }
  function rowSuggestion(r){
    const subjectSel = `<select disabled>${suggestionSubjects.map(s=>`<option ${s===r.subject?'selected':''}>${s}</option>`).join('')}</select>`;
    const ownerSel   = `<select disabled>${owners.map(o=>`<option ${o===r.owner?'selected':''}>${o}</option>`).join('')}</select>`;
    const statusSel  = `<select disabled>${suggestionStatus.map(s=>`<option ${s===r.status?'selected':''}>${s}</option>`).join('')}</select>`;
    const revRoleSel = `<select disabled>${suggestionReviewer.map(o=>`<option ${o===r.reviewerRole?'selected':''}>${o}</option>`).join('')}</select>`;
    const subDate    = `<input type="date" value="${r.submitted||''}" disabled />`;
    const revDate    = `<input type="date" value="${r.reviewed||''}" disabled />`;
    const already = !!(r.starredBy && CURRENT_UID && r.starredBy[CURRENT_UID]);
    const starBtn = `<button class="btn ghost" data-star-sug ${!CURRENT_UID||already?'disabled':''}>⭐</button>`;
    const starCnt = `<span data-star-count>${r.stars || 0}</span>`;
    return `
      <td>${r.id||''}</td>
      <td><div class="cell-text">${(r.description||'')}</div></td>
      <td>${subjectSel}</td>
      <td>${ownerSel}</td>
      <td>${subDate}</td>
      <td>${statusSel}</td>
      <td>${revRoleSel}</td>
      <td>${revDate}</td>
      <td class="col-stars">${starBtn} ${starCnt}</td>
      <td>${actionsCell('suggestions', r.id)}</td>`;
  }
  function rowQuestion(r){
    const subjectSel = `<select disabled>${suggestionSubjects.map(s=>`<option ${s===r.subject?'selected':''}>${s}</option>`).join('')}</select>`;
    const ownerSel   = `<select disabled>${owners.map(o=>`<option ${o===r.owner?'selected':''}>${o}</option>`).join('')}</select>`;
    const statusSel  = `<select disabled>${suggestionStatus.map(s=>`<option ${s===r.status?'selected':''}>${s}</option>`).join('')}</select>`;
    const revRoleSel = `<select disabled>${suggestionReviewer.map(o=>`<option ${o===r.reviewerRole?'selected':''}>${o}</option>`).join('')}</select>`;
    const subDate    = `<input type="date" value="${r.submitted||''}" disabled />`;
    const revDate    = `<input type="date" value="${r.reviewed||''}" disabled />`;
    const already = !!(r.starredBy && CURRENT_UID && r.starredBy[CURRENT_UID]);
    const starBtn = `<button class="btn ghost" data-star-q ${!CURRENT_UID||already?'disabled':''}>⭐</button>`;
    const starCnt = `<span data-star-count>${r.stars || 0}</span>`;
    return `
      <td>${r.id||''}</td>
      <td><div class="cell-text">${(r.description||'')}</div></td>
      <td>${subjectSel}</td>
      <td>${ownerSel}</td>
      <td>${subDate}</td>
      <td>${statusSel}</td>
      <td>${revRoleSel}</td>
      <td>${revDate}</td>
      <td class="col-stars">${starBtn} ${starCnt}</td>
      <td>${actionsCell('questions', r.id)}</td>`;
  }
  function renderGoals(){ const tb=$('#tblGoals tbody'); tb.innerHTML=''; let rows=[...cache.goals];
    const fOwner=$('#gOwner').value; if(fOwner) rows=rows.filter(r=> (r.owner||'')===fOwner);
    const fStatus=$('#gStatus').value; if(fStatus) rows=rows.filter(r=> (r.status||'')===fStatus);
    const fStart=$('#gStartFrom').value; if(fStart) rows=rows.filter(r=> (r.start||'')>=fStart);
    const fEnd=$('#gEndTo').value; if(fEnd) rows=rows.filter(r=> (r.end||'')<=fEnd);
    const q=$('#gSearch').value?.toLowerCase()||''; if(q) rows=rows.filter(r=> ((r.goal||'')+' '+(r.notes||'')).toLowerCase().includes(q));
    rows.sort(idSort); rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=rowGoal(r); tb.appendChild(tr); });
  }
  function renderRisks(){ const tb=$('#tblRisks tbody'); tb.innerHTML=''; let rows=[...cache.risks];
    const fOwner=$('#rOwner').value; if(fOwner) rows=rows.filter(r=> (r.owner||'')===fOwner);
    const fL=$('#rLikelihood').value; if(fL) rows=rows.filter(r=> (r.likelihood||'')===fL);
    const fI=$('#rImpact').value; if(fI) rows=rows.filter(r=> (r.impact||'')===fI);
    const fS=$('#rStatus').value; if(fS) rows=rows.filter(r=> (r.status||'')===fS);
    const q=$('#rSearch').value?.toLowerCase()||''; if(q) rows=rows.filter(r=> ((r.description||'')+' '+(r.mitigation||'')).toLowerCase().includes(q));
    rows.sort(idSort); rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=rowRisk(r); tb.appendChild(tr); });
  }
  function renderIssues(){ const tb=$('#tblIssues tbody'); tb.innerHTML=''; let rows=[...cache.issues];
    const fOwner=$('#iOwner').value; if(fOwner) rows=rows.filter(r=> (r.owner||'')===fOwner);
    const fV=$('#iSeverity').value; if(fV) rows=rows.filter(r=> (r.severity||'')===fV);
    const fS=$('#iStatus').value; if(fS) rows=rows.filter(r=> (r.status||'')===fS);
    const q=$('#iSearch').value?.toLowerCase()||''; if(q) rows=rows.filter(r=> ((r.description||'')+' '+(r.resolution||'')).toLowerCase().includes(q));
    rows.sort(idSort); rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=rowIssue(r); tb.appendChild(tr); });
  }
  function renderPlans(){ const tb=$('#tblPlans tbody'); tb.innerHTML=''; let rows=[...cache.plans];
    const fOwner=$('#pOwner').value; if(fOwner) rows=rows.filter(r=> (r.owner||'')===fOwner);
    const fS=$('#pStatus').value; if(fS) rows=rows.filter(r=> (r.status||'')===fS);
    const fG=$('#pGoalId').value.trim().toLowerCase(); if(fG) rows=rows.filter(r=> (r.goalId||'').toLowerCase().includes(fG));
    const q=$('#pSearch').value?.toLowerCase()||''; if(q) rows=rows.filter(r=> ((r.description||'')).toLowerCase().includes(q));
    rows.sort(idSort); rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=rowPlan(r); tb.appendChild(tr); });
  }
  function renderSuggestions(){
    const tb=$('#tblSuggestions tbody'); tb.innerHTML=''; let rows=[...cache.suggestions];
    const q=$('#sSearch').value?.toLowerCase()||'';
    const fSub=$('#sSubject').value; const fOwner=$('#sOwner').value; const fSubm=$('#sSubmitted').value;
    const fStatus=$('#sStatus').value; const fRevRole=$('#sReviewerRole').value; const fRevDate=$('#sReviewed').value;
    if(q) rows=rows.filter(r=> ((r.description||'')).toLowerCase().includes(q));
    if(fSub) rows=rows.filter(r=> (r.subject||'')===fSub);
    if(fOwner) rows=rows.filter(r=> (r.owner||'')===fOwner);
    if(fSubm) rows=rows.filter(r=> (r.submitted||'')>=fSubm);
    if(fStatus) rows=rows.filter(r=> (r.status||'')===fStatus);
    if(fRevRole) rows=rows.filter(r=> (r.reviewerRole||'')===fRevRole);
    if(fRevDate) rows=rows.filter(r=> (r.reviewed||'')>=fRevDate);
    rows.sort(idSort); rows.forEach(r=>{ if(r.stars==null) r.stars=0; if(!r.starredBy) r.starredBy={}; const tr=document.createElement('tr'); tr.dataset.sugid=r.id; tr.innerHTML=rowSuggestion(r); tb.appendChild(tr); });
  }
  function renderQuestions(){
    const tb=$('#tblQuestions tbody'); tb.innerHTML=''; let rows=[...cache.questions];
    const q=$('#qSearch').value?.toLowerCase()||'';
    const fSub=$('#qSubject').value; const fOwner=$('#qOwner').value; const fSubm=$('#qSubmitted').value;
    const fStatus=$('#qStatus').value; const fRevRole=$('#qReviewerRole').value; const fRevDate=$('#qReviewed').value;
    if(q) rows=rows.filter(r=> ((r.description||'')).toLowerCase().includes(q));
    if(fSub) rows=rows.filter(r=> (r.subject||'')===fSub);
    if(fOwner) rows=rows.filter(r=> (r.owner||'')===fOwner);
    if(fSubm) rows=rows.filter(r=> (r.submitted||'')>=fSubm);
    if(fStatus) rows=rows.filter(r=> (r.status||'')===fStatus);
    if(fRevRole) rows=rows.filter(r=> (r.reviewerRole||'')===fRevRole);
    if(fRevDate) rows=rows.filter(r=> (r.reviewed||'')>=fRevDate);
    rows.sort(idSort); rows.forEach(r=>{ if(r.stars==null) r.stars=0; if(!r.starredBy) r.starredBy={}; const tr=document.createElement('tr'); tr.dataset.qid=r.id; tr.innerHTML=rowQuestion(r); tb.appendChild(tr); });
  }
  function renderNotifications(rows){
    const tb=$('#tblNotifications tbody'); tb.innerHTML='';
    let list=[...rows];
    const idf=$('#nId').value?.trim(); const q=$('#nSearch').value?.toLowerCase()||'';
    const sub=$('#nSubject').value; const st=$('#nStatus').value; const rl=$('#nRole').value;
    const from=$('#nFrom').value; const to=$('#nTo').value;
    if(idf) list=list.filter(r=> (r.id||'').toLowerCase().includes(idf.toLowerCase()));
    if(q) list=list.filter(r=> ((r.description||'')).toLowerCase().includes(q));
    if(sub) list=list.filter(r=> (r.subject||'')===sub);
    if(st) list=list.filter(r=> (r.status||'')===st);
    if(rl) list=list.filter(r=> (r.role||'')===rl);
    if(from) list=list.filter(r=> (r.date||'')>=from);
    if(to) list=list.filter(r=> (r.date||'')<=to);
    list.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    list.forEach(r=>{
      const tr=document.createElement('tr'); tr.dataset.docid=r.__id||'';
      const actions = (CURRENT_ROLE==='Admin')? `<div class="row-actions"><button class="btn delete" data-del-note>Del</button></div>` : '—';
      tr.innerHTML = `
        <td>${r.id||''}</td>
        <td>${r.description||''}</td>
        <td>${r.subject||''}</td>
        <td>${r.status||''}</td>
        <td>${r.role||''}</td>
        <td>${r.date||''}</td>
        <td>${actions}</td>`;
      tb.appendChild(tr);
    });
  }

  function renderAll(){
    renderGoals(); renderRisks(); renderIssues(); renderPlans(); renderSuggestions(); renderQuestions(); renderNotifications(cache.notifications||[]);
  }

  // Tabs
  $$('.tabs button').forEach(btn=>btn.addEventListener('click',()=>{
    $$('.tabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    const tab=btn.dataset.tab; $$('section').forEach(s=>s.classList.remove('active')); $('#'+tab).classList.add('active');
  }));

  // ---------- New Item → Overlay (i.p.v. prompt pop-ups) ----------
  const prefixByColl = {goals:'G', risks:'R', issues:'I', plans:'P', suggestions:'S', questions:'Q'};
  function nextIdFrom(cacheArr, prefix){ let m=0; cacheArr.forEach(x=>{ const n=getNum(x.id); if(n>m) m=n; }); return prefix+(m+1); }

  $('#addGoalBtn').onclick = ()=> openOverlay('goals','new');
  $('#addRiskBtn').onclick = ()=> openOverlay('risks','new');
  $('#addIssueBtn').onclick= ()=> openOverlay('issues','new');
  $('#addPlanBtn').onclick = ()=> openOverlay('plans','new');
  $('#addSuggestionBtn').onclick = ()=> openOverlay('suggestions','new');
  $('#addQuestionBtn').onclick   = ()=> openOverlay('questions','new');

  document.addEventListener('click', async (e)=>{
    const starBtn = e.target.closest('[data-star-sug]');
    if(starBtn){
      if(!CURRENT_UID){ alert('Please login to star.'); return; }
      const tr = starBtn.closest('tr'); const sugId = tr?.dataset.sugid; if(!sugId) return;
      starBtn.disabled = true;
      try{
        const ref = doc(db,'suggestions', sugId);
        const cntEl = tr.querySelector('[data-star-count]');
        const current = parseInt(cntEl?.textContent||'0',10) || 0;
        await updateDoc(ref, { stars: current + 1, ["starredBy."+CURRENT_UID]: true });
        cntEl.textContent = String(current+1);
      }catch(err){ alert('Star failed: '+err.message); starBtn.disabled=false; }
    }
    const starQBtn = e.target.closest('[data-star-q]');
    if(starQBtn){
      if(!CURRENT_UID){ alert('Please login to star.'); return; }
      const tr = starQBtn.closest('tr'); const qid = tr?.dataset.qid; if(!qid) return;
      starQBtn.disabled = true;
      try{
        const ref = doc(db,'questions', qid);
        const cntEl = tr.querySelector('[data-star-count]');
        const current = parseInt(cntEl?.textContent||'0',10) || 0;
        await updateDoc(ref, { stars: current + 1, ["starredBy."+CURRENT_UID]: true });
        cntEl.textContent = String(current+1);
      }catch(err){ alert('Star failed: '+err.message); starQBtn.disabled=false; }
    }

    const menuBtn = e.target.closest('button[data-menu]');
    if(menuBtn){
      if(!DATA_READY){ alert('Load Database first.'); return; }
      const coll = menuBtn.dataset.menu; const id = menuBtn.dataset.id;
      openOverlay(coll, 'edit', id);
    }

    if(e.target.id==='ovClose'){ closeOverlay(); }
    if(e.target.id==='ovEdit'){ enableForm(true); }
    if(e.target.id==='ovSave'){ await saveOverlay(); }
    if(e.target.id==='ovDelete'){ await deleteOverlay(); }
    const delNoteBtn = e.target.closest('[data-del-note]');
    if(delNoteBtn){
      if(CURRENT_ROLE!=='Admin'){ alert('Only Admin can delete notifications.'); return; }
      // notifications opslag is uitgeschakeld in deze versie
      alert('Notifications storage is uitgeschakeld.');
    }
  });

  const overlay = {
    el: $('#overlay'),
    mode: 'new',
    coll: '',
    id: '',
    currentDoc: null
  };

  function openOverlay(coll, mode='new', id=null){
    overlay.mode = mode; overlay.coll = coll; overlay.id = id||'';
    const titleMap = {goals:'Goal',risks:'Risk',issues:'Issue',plans:'Plan',suggestions:'Suggestion',questions:'Question'};
    $('#ovTitle').textContent = (mode==='new' ? 'New ' : 'Edit ') + titleMap[coll] + (id? ' '+id : '');
    // Bouw form
    const formHtml = buildForm(coll, mode);
    $('#ovFormBlock').innerHTML = formHtml;
    // standaard EDIT aan voor editors
    enableForm(CAN_EDIT);
    // Knoppen-visibility
    $('#ovEdit').style.display = CAN_EDIT? 'none' : 'inline-block';
    $('#ovDelete').style.display = (mode==='edit' && CAN_EDIT)? 'inline-block' : 'none';
    $('#ovHint').textContent = CAN_EDIT ? 'Je kunt direct bewerken en opslaan.' : 'Lezen alleen. Log in met edit-rechten om te bewerken.';
    // Boomgrafiek opbouwen en huidig ID highlighten
    renderTree(overlay.coll, overlay.id || $('#fld_id')?.value || '');
    overlay.el.classList.add('show');
  }
  function closeOverlay(){ overlay.el.classList.remove('show'); overlay.currentDoc=null; }

  function todayISO(){ return new Date().toISOString().slice(0,10); }

  function buildForm(coll, mode){
    const isNew = mode==='new';
    let data = {};
    if(isNew){
      const prefix = prefixByColl[coll];
      const nextId = nextIdFrom(cache[coll], prefix);
      data = { id: nextId, dateStamp: todayISO() };
    }else{
      const docData = (cache[coll]||[]).find(x=>String(x.id)===String(overlay.id)) || {};
      data = {...docData};
    }
    overlay.currentDoc = {...data};

    // velden per type
    const commonTop = `
      <div class="form-row"><label>ID</label><input id="fld_id" value="${data.id||''}" disabled /></div>
      <div class="form-row"><label>DateStamp (string)</label><input id="fld_dateStamp" value="${data.dateStamp||todayISO()}" /></div>
    `;

    if(coll==='goals'){
      return `
        ${commonTop}
        <div class="form-row"><label>Goal (SMART)</label><textarea id="fld_goal">${data.goal||''}</textarea></div>
        <div class="form-row"><label>Owner</label>${selectHtml('fld_owner', owners, data.owner||'')}</div>
        <div class="form-row"><label>Start</label><input type="date" id="fld_start" value="${data.start||''}"/></div>
        <div class="form-row"><label>End</label><input type="date" id="fld_end" value="${data.end||''}"/></div>
        <div class="form-row"><label>Status</label>${selectHtml('fld_status', statuses.goals, data.status||'')}</div>
        <div class="form-row"><label>Notes</label><textarea id="fld_notes">${data.notes||''}</textarea></div>
      `;
    }
    if(coll==='risks'){
      return `
        ${commonTop}
        <div class="form-row"><label>Description</label><textarea id="fld_description">${data.description||''}</textarea></div>
        <div class="form-row"><label>Owner</label>${selectHtml('fld_owner', owners, data.owner||'')}</div>
        <div class="form-row"><label>Likelihood</label>${selectHtml('fld_likelihood', tri, data.likelihood||'')}</div>
        <div class="form-row"><label>Impact</label>${selectHtml('fld_impact', tri, data.impact||'')}</div>
        <div class="form-row"><label>Status</label>${selectHtml('fld_status', statuses.risks, data.status||'')}</div>
        <div class="form-row"><label>Mitigation</label><textarea id="fld_mitigation">${data.mitigation||''}</textarea></div>
      `;
    }
    if(coll==='issues'){
      return `
        ${commonTop}
        <div class="form-row"><label>Description</label><textarea id="fld_description">${data.description||''}</textarea></div>
        <div class="form-row"><label>Owner</label>${selectHtml('fld_owner', owners, data.owner||'')}</div>
        <div class="form-row"><label>Severity</label>${selectHtml('fld_severity', tri, data.severity||'')}</div>
        <div class="form-row"><label>Status</label>${selectHtml('fld_status', statuses.issues, data.status||'')}</div>
        <div class="form-row"><label>Resolution</label><textarea id="fld_resolution">${data.resolution||''}</textarea></div>
      `;
    }
    if(coll==='plans'){
      // LET OP: bij New Plan GEEN Goal Link veld tonen (op verzoek)
      const goalLinkBlock = (mode==='edit')
        ? `<div class="form-row"><label>Goal Link</label><input id="fld_goalId" value="${data.goalId||''}"/></div>`
        : '';
      return `
        ${commonTop}
        <div class="form-row"><label>Description</label><textarea id="fld_description">${data.description||''}</textarea></div>
        <div class="form-row"><label>Owner</label>${selectHtml('fld_owner', owners, data.owner||'')}</div>
        ${goalLinkBlock}
        <div class="form-row"><label>Start</label><input type="date" id="fld_start" value="${data.start||''}"/></div>
        <div class="form-row"><label>End</label><input type="date" id="fld_end" value="${data.end||''}"/></div>
        <div class="form-row"><label>Status</label>${selectHtml('fld_status', statuses.plans, data.status||'')}</div>
      `;
    }
    if(coll==='suggestions'){
      return `
        ${commonTop}
        <div class="form-row"><label>Description</label><textarea id="fld_description">${data.description||''}</textarea></div>
        <div class="form-row"><label>Subject</label>${selectHtml('fld_subject', suggestionSubjects, data.subject||'')}</div>
        <div class="form-row"><label>Owner</label>${selectHtml('fld_owner', owners, data.owner||'')}</div>
        <div class="form-row"><label>Submitted</label><input type="date" id="fld_submitted" value="${data.submitted||todayISO()}"/></div>
        <div class="form-row"><label>Status</label>${selectHtml('fld_status', suggestionStatus, data.status||'')}</div>
        <div class="form-row"><label>Reviewer Role</label>${selectHtml('fld_reviewerRole', suggestionReviewer, data.reviewerRole||'')}</div>
        <div class="form-row"><label>Reviewed</label><input type="date" id="fld_reviewed" value="${data.reviewed||''}"/></div>
      `;
    }
    if(coll==='questions'){
      return `
        ${commonTop}
        <div class="form-row"><label>Description</label><textarea id="fld_description">${data.description||''}</textarea></div>
        <div class="form-row"><label>Subject</label>${selectHtml('fld_subject', suggestionSubjects, data.subject||'')}</div>
        <div class="form-row"><label>Owner</label>${selectHtml('fld_owner', owners, data.owner||'')}</div>
        <div class="form-row"><label>Submitted</label><input type="date" id="fld_submitted" value="${data.submitted||todayISO()}"/></div>
        <div class="form-row"><label>Status</label>${selectHtml('fld_status', suggestionStatus, data.status||'')}</div>
        <div class="form-row"><label>Reviewer Role</label>${selectHtml('fld_reviewerRole', suggestionReviewer, data.reviewerRole||'')}</div>
        <div class="form-row"><label>Reviewed</label><input type="date" id="fld_reviewed" value="${data.reviewed||''}"/></div>
      `;
    }
    return '';
  }

  function selectHtml(id, arr, val){
    return `<select id="${id}">${arr.map(v=>`<option ${String(v)===String(val)?'selected':''}>${v}</option>`).join('')}</select>`;
  }

  function enableForm(on){
    $('#ovFormBlock').querySelectorAll('input,textarea,select').forEach(el=>{
      if(el.id==='fld_id') return; // id altijd locken
      el.disabled = !on;
    });
    $('#ovSave').disabled = !on;
    $('#ovDelete').disabled = !on;
  }

  async function saveOverlay(){
    if(!CAN_EDIT){ alert('no edit rights'); return; }
    const c = overlay.coll; const id = $('#fld_id').value.trim();
    const base = { id, dateStamp: $('#fld_dateStamp').value.trim() };
    let docData = {};
    if(c==='goals'){
      docData = {...base,
        goal:$('#fld_goal').value, owner:$('#fld_owner').value, start:$('#fld_start').value, end:$('#fld_end').value,
        status:$('#fld_status').value, notes:$('#fld_notes').value
      };
    }else if(c==='risks'){
      docData = {...base,
        description:$('#fld_description').value, owner:$('#fld_owner').value,
        likelihood:$('#fld_likelihood').value, impact:$('#fld_impact').value,
        status:$('#fld_status').value, mitigation:$('#fld_mitigation').value
      };
    }else if(c==='issues'){
      docData = {...base,
        description:$('#fld_description').value, owner:$('#fld_owner').value,
        severity:$('#fld_severity').value, status:$('#fld_status').value, resolution:$('#fld_resolution').value
      };
    }else if(c==='plans'){
      docData = {...base,
        description:$('#fld_description').value, owner:$('#fld_owner').value,
        goalId: ($('#fld_goalId')?.value || ''), start:$('#fld_start').value, end:$('#fld_end').value, status:$('#fld_status').value
      };
    }else if(c==='suggestions' || c==='questions'){
      docData = {...base,
        description:$('#fld_description').value, subject:$('#fld_subject').value, owner:$('#fld_owner').value,
        submitted:$('#fld_submitted').value, status:$('#fld_status').value,
        reviewerRole:$('#fld_reviewerRole').value, reviewed:$('#fld_reviewed').value,
        stars: overlay.currentDoc?.stars||0, starredBy: overlay.currentDoc?.starredBy||{}
      };
    }
    await setDoc(doc(db, c, id), docData);
    // cache updaten
    const arr = cache[c]||[];
    const ix = arr.findIndex(x=>String(x.id)===String(id));
    if(ix>=0) arr[ix]=docData; else arr.push(docData);
    renderTabForColl(c);
    renderTree(c, id);
    alert('Saved.');
    overlay.mode='edit'; overlay.id=id; overlay.currentDoc=docData;
    $('#ovTitle').textContent = 'Edit ' + ({goals:'Goal',risks:'Risk',issues:'Issue',plans:'Plan',suggestions:'Suggestion',questions:'Question'})[c] + ' ' + id;
    // Na save blijft edit aan
    enableForm(true);
    $('#ovDelete').style.display = CAN_EDIT? 'inline-block' : 'none';
  }

  async function deleteOverlay(){
    if(!CAN_EDIT){ alert('no edit rights'); return; }
    const c=overlay.coll, id = overlay.id || $('#fld_id').value.trim();
    if(!confirm('Delete '+id+'?')) return;
    await deleteDoc(doc(db, c, id));
    cache[c] = (cache[c]||[]).filter(x=>String(x.id)!==String(id));
    renderTabForColl(c);
    closeOverlay();
  }

  function renderTabForColl(c){
    if(c==='goals') renderGoals();
    else if(c==='risks') renderRisks();
    else if(c==='issues') renderIssues();
    else if(c==='plans') renderPlans();
    else if(c==='suggestions') renderSuggestions();
    else if(c==='questions') renderQuestions();
  }

  // ---------- Boomgrafiek ----------
  function renderTree(currentColl='', currentId=''){
    const t = $('#tree'); if(!t) return;
    const groups = [
      {key:'goals', label:'Goals', cls:'goal'},
      {key:'risks', label:'Risks', cls:'risk'},
      {key:'issues',label:'Issues',cls:'issue'},
      {key:'plans', label:'Plans', cls:'plan'},
      {key:'questions',label:'Questions',cls:'question'},
      {key:'suggestions',label:'Suggestions',cls:'suggestion'},
    ];
    t.innerHTML = groups.map(g=>{
      const rows = (cache[g.key]||[]).slice().sort(idSort).map(r=>{
        const isCurrent = (String(r.id)===String(currentId));
        const meta = (g.key==='plans' && r.goalId)? `<small>→ ${r.goalId}</small>` : (r.dateStamp? `<small>${r.dateStamp}</small>` : '');
        return `<li><span class="node ${g.cls} ${isCurrent?'current':''}" data-jump="${g.key}" data-id="${r.id}"><span class="id">${r.id}</span> ${meta}</span></li>`;
      }).join('');
      return `<ul><li><strong>${g.label}</strong><ul>${rows||''}</ul></li></ul>`;
    }).join('');

    // klik op node → open overlay edit
    t.querySelectorAll('.node').forEach(n=>{
      n.addEventListener('click',()=>{
        const c=n.getAttribute('data-jump'), id=n.getAttribute('data-id');
        openOverlay(c,'edit',id);
      });
    });
  }

  // ---------- Nav helpers ----------
  document.addEventListener('click', (e)=>{
    const tabBtn = e.target.closest('nav.tabs button'); if(tabBtn) return;
  });

  // ---------- Actions in tables open overlay ----------
  function actionsDelegation(){
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-menu]');
      if(!btn) return;
      const coll = btn.dataset.menu; const id = btn.dataset.id;
      openOverlay(coll, 'edit', id);
    });
  }
  actionsDelegation();

  // ---------- Open vanuit URL hash (optioneel) ----------
  function openFromHash(){
    if(location.hash && DATA_READY){
      const m = location.hash.match(/^#(G|R|I|P|Q|S)(\d+)/i);
      if(m){
        const map = {G:'goals',R:'risks',I:'issues',P:'plans',Q:'questions',S:'suggestions'};
        const coll = map[m[1].toUpperCase()]; const id = m[1].toUpperCase()+m[2];
        if(coll) openOverlay(coll,'edit',id);
      }
    }
  }
  window.addEventListener('hashchange', openFromHash);

</script>
</body>
</html>
