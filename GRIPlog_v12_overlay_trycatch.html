<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GRIPlog LINK GRAPH v2 – UNIQUE MIN (titleSync, colored, padded, no-tif fix, INVULKAART/BOOMGRAFIEK tweaks)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:#0b0f18;
  --bg2:#0f1524;
  --panel:#11182b;
  --panel2:#0d1322;
  --text:#e6eefb;
  --muted:#9ab0d1;
  --accent:#6aa0ff;
  --accent2:#4ecdc4;
  --warn:#ffcc00;
  --danger:#ff6b6b;
  --ok:#5dd39e;
  --line:#21304a;
  --chip:#1a2340;
  --chip2:#142038;
  --badge:#192442;
  --link:#9dd4ff;
  --shadow:rgba(0,0,0,.5);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; padding:0; background:linear-gradient(180deg, var(--bg), var(--bg2));
  color:var(--text); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
}
a{color:var(--link); text-decoration:none}
a:hover{text-decoration:underline}
header{
  position:sticky; top:0; z-index:100; background:linear-gradient(180deg, rgba(13,20,38,.9), rgba(13,20,38,.7));
  backdrop-filter: blur(10px);
  border-bottom:1px solid var(--line);
  box-shadow:0 8px 24px -12px var(--shadow);
}
.container{max-width:1300px; margin:0 auto; padding:16px 20px}
h1{font-size:18px; margin:0 0 6px}
.small{color:var(--muted); font-size:12px}
.badge{display:inline-block; font-size:12px; padding:5px 8px; background:var(--badge); border:1px solid var(--line); border-radius:8px; margin-left:8px}
nav.tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
nav.tabs button{
  background:var(--chip); color:var(--text); border:1px solid var(--line);
  padding:8px 12px; border-radius:10px; cursor:pointer
}
nav.tabs button.active{background:var(--accent); border-color:transparent; color:#081018; font-weight:600}
main{padding:16px 20px}
.panel{background:var(--panel); border:1px solid var(--line); border-radius:14px; box-shadow:0 10px 28px -16px var(--shadow)}
.sectionbar{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:var(--panel2); border-bottom:1px solid var(--line); border-radius:14px 14px 0 0}
.sectionbar h2{font-size:16px; margin:0}
.sectionbar .right{display:flex; gap:8px; align-items:center}
button.btn{
  background:var(--chip2); color:var(--text); border:1px solid var(--line);
  padding:8px 12px; border-radius:10px; cursor:pointer
}
button.btn.primary{background:var(--accent); color:#081018; border-color:transparent}
button.btn.danger{background:var(--danger); color:#081018; border-color:transparent}
button.btn:disabled{opacity:.5; cursor:not-allowed}
.card{padding:12px}
table{width:100%; border-collapse:collapse}
th,td{padding:8px 10px; border-bottom:1px solid var(--line); vertical-align:top}
tr.labels th{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.04em}
tr.filters th{background:rgba(255,255,255,.02); position:sticky; top:0}
tr.filters input, tr.filters select{width:100%; background:#0d1527; color:var(--text); border:1px solid var(--line); border-radius:8px; padding:6px 8px}
.actions{display:flex; gap:8px}
.chips{display:flex; flex-wrap:wrap; gap:6px}
.chip{background:var(--chip); border:1px solid var(--line); padding:4px 8px; border-radius:999px; font-size:12px}
footer{padding:30px; color:var(--muted); text-align:center}

/* overlay */
#overlay{position:fixed; inset:0; display:none}
#overlay.show{display:block}
.ov-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(6px)}
.ov-panel{position:absolute; right:0; top:0; height:100%; width:920px; max-width:min(92vw, 920px); background:var(--panel); border-left:1px solid var(--line); box-shadow:-16px 0 40px -20px var(--shadow); display:flex; flex-direction:column}
.ov-header{padding:12px 14px; background:var(--panel2); border-bottom:1px solid var(--line); display:flex; gap:8px; align-items:center; justify-content:space-between}
.ov-header .title{font-size:16px; font-weight:600}
.ov-header .sub{font-size:12px; color:var(--muted)}
.ov-body{padding:14px; overflow:auto; flex:1}
.ov-footer{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-top:1px solid var(--line); background:var(--panel2)}
.ov-actions{display:flex; gap:8px}
.ov-split{display:grid; grid-template-columns:1fr 360px; gap:12px}
@media (max-width: 1100px){ .ov-split{grid-template-columns:1fr} }

/* form blocks */
.block{margin-bottom:12px; border:1px solid var(--line); border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0))}
.block summary{cursor:pointer; user-select:none; padding:10px 12px; color:var(--muted)}
.block summary::-webkit-details-marker{display:none}
.block summary::after{content:'▾'; float:right; opacity:.6}
.block details[open] summary::after{content:'▴'}
.form-row{display:grid; grid-template-columns: 160px 1fr; gap:8px; padding:8px 12px}
.form-row label{color:var(--muted)}
input[type="text"], input[type="date"], select{width:100%; background:#0d1527; color:var(--text); border:1px solid var(--line); border-radius:8px; padding:8px 10px}
textarea{width:100%; min-height:92px; background:#0d1527; color:var(--text); border:1px solid var(--line); border-radius:8px; padding:8px 10px}
.help{font-size:12px; color:var(--muted)}

/* tree graph */
.tree{border:1px dashed var(--line); border-radius:12px; padding:10px}
.node{display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)); margin:6px 4px; font-size:12px; white-space:nowrap}
.node .id{opacity:.7; margin-right:6px}
.node.goal{border-color:#4ecdc4}
.node.risk{border-color:#ffcc00}
.node.issue{border-color:#ff6b6b}
.node.plan{border-color:#6aa0ff}
.node.question{border-color:#c792ea}
.node.suggestion{border-color:#8bd6ff}
.node.current{box-shadow:0 0 0 2px var(--accent) inset, 0 0 0 2px rgba(0,0,0,0);}

/* === OVERRIDE: Double size for current chain block === */
.node.current{ transform: scale(2) !important; z-index: 5 !important; transform-origin: center !important; }

/* misc */
.kv{display:grid; grid-template-columns: 140px 1fr; gap:6px}
.kv .k{color:var(--muted)}
hr.sep{border:0; border-top:1px solid var(--line); margin:12px 0}

/* small helper */
.hidden{display:none !important}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>GRIPlog – Link Graph v2</h1>
    <div class="small">Title sync • colored • padded • unique IDs • no notif autosave • INVULKAART: auto-edit • BOOMGRAFIEK: current 2×</div>
    <nav class="tabs">
      <button class="active" data-tab="goals">Goals</button>
      <button data-tab="risks">Risks</button>
      <button data-tab="issues">Issues</button>
      <button data-tab="plans">Plans</button>
      <button data-tab="questions">Questions</button>
      <button data-tab="suggestions">Suggestions</button>
      <button data-tab="notifications">Notifications</button>
      <button data-tab="account">Account</button>
      <button data-tab="help">Help</button>
    </nav>
  </div>
</header>

<main class="container panel">
  <section id="goals" class="active" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left"><h2>Goals</h2></div>
        <div class="right"><button class="btn" id="addGoalBtn" disabled>+ New Goal</button></div>
      </div>
      <table id="tblGoals">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Goal (SMART)</th>
            <th style="width:160px">Owner</th>
            <th style="width:130px">Start</th>
            <th style="width:130px">End</th>
            <th style="width:140px">Status</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="gSearch" class="search" placeholder="Search goals..."></th>
            <th><input type="text" id="gOwn" placeholder="Owner..."></th>
            <th><input type="date" id="gStart"></th>
            <th><input type="date" id="gEnd"></th>
            <th>
              <select id="gStatus">
                <option value="">– any –</option>
                <option>Open</option><option>In Progress</option><option>Closed</option>
              </select>
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody id="bodyGoals"></tbody>
      </table>
    </div>
  </section>

  <section id="risks" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left"><h2>Risks</h2></div>
        <div class="right"><button class="btn" id="addRiskBtn" disabled>+ New Risk</button></div>
      </div>
      <table id="tblRisks">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:160px">Owner</th>
            <th style="width:140px">Likelihood</th>
            <th style="width:140px">Status</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="rSearch" placeholder="Search risks..."></th>
            <th><input type="text" id="rOwn" placeholder="Owner..."></th>
            <th>
              <select id="rLik">
                <option value="">– any –</option>
                <option>Low</option><option>Medium</option><option>High</option>
              </select>
            </th>
            <th>
              <select id="rStatus">
                <option value="">– any –</option>
                <option>Open</option><option>In Progress</option><option>Closed</option>
              </select>
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody id="bodyRisks"></tbody>
      </table>
    </div>
  </section>

  <section id="issues" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left"><h2>Issues</h2></div>
        <div class="right"><button class="btn" id="addIssueBtn" disabled>+ New Issue</button></div>
      </div>
      <table id="tblIssues">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:160px">Owner</th>
            <th style="width:140px">Severity</th>
            <th style="width:140px">Status</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="iSearch" placeholder="Search issues..."></th>
            <th><input type="text" id="iOwn" placeholder="Owner..."></th>
            <th>
              <select id="iSev">
                <option value="">– any –</option>
                <option>Low</option><option>Medium</option><option>High</option>
              </select>
            </th>
            <th>
              <select id="iStatus">
                <option value="">– any –</option>
                <option>Open</option><option>In Progress</option><option>Closed</option>
              </select>
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody id="bodyIssues"></tbody>
      </table>
    </div>
  </section>

  <section id="plans" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left"><h2>Plans</h2></div>
        <div class="right"><button class="btn" id="addPlanBtn" disabled>+ New Plan</button></div>
      </div>
      <table id="tblPlans">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:160px">Owner</th>
            <th>Goal Link</th>
            <th style="width:130px">Start</th>
            <th style="width:130px">End</th>
            <th style="width:140px">Status</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="pSearch" placeholder="Search plans..."></th>
            <th><input type="text" id="pOwn" placeholder="Owner..."></th>
            <th><input type="text" id="pGoalId" placeholder="G..."></th>
            <th><input type="date" id="pStart"></th>
            <th><input type="date" id="pEnd"></th>
            <th>
              <select id="pStatus">
                <option value="">– any –</option>
                <option>Open</option><option>In Progress</option><option>Closed</option>
              </select>
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody id="bodyPlans"></tbody>
      </table>
    </div>
  </section>

  <section id="questions" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left"><h2>Questions</h2></div>
        <div class="right"><button class="btn" id="addQuestionBtn">+ New Question</button></div>
      </div>
      <table id="tblQuestions">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:150px">Subject</th>
            <th style="width:160px">Owner</th>
            <th style="width:130px">Submitted</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="qSearch" placeholder="Search questions..."></th>
            <th>
              <select id="qSubject">
                <option value="">– any –</option>
                <option>New Goal</option><option>New Risk</option><option>New Issue</option><option>New Plan</option>
              </select>
            </th>
            <th><input type="text" id="qOwn" placeholder="Owner..."></th>
            <th><input type="date" id="qSubm"></th>
            <th></th>
          </tr>
        </thead>
        <tbody id="bodyQuestions"></tbody>
      </table>
    </div>
  </section>

  <section id="suggestions" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left"><h2>Suggestions</h2></div>
        <div class="right"><button class="btn" id="addSuggestionBtn">+ New Suggestion</button></div>
      </div>
      <table id="tblSuggestions">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:150px">Subject</th>
            <th style="width:160px">Owner</th>
            <th style="width:130px">Submitted</th>
            <th style="width:110px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="sSearch" placeholder="Search suggestions..."></th>
            <th>
              <select id="sSubject">
                <option value="">– any –</option>
                <option>New Goal</option><option>New Risk</option><option>New Issue</option><option>New Plan</option>
              </select>
            </th>
            <th><input type="text" id="sOwn" placeholder="Owner..."></th>
            <th><input type="date" id="sSubm"></th>
            <th></th>
          </tr>
        </thead>
        <tbody id="bodySuggestions"></tbody>
      </table>
    </div>
  </section>

  <section id="notifications" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left"><h2>Notifications</h2></div>
        <div class="right"><button class="btn" id="btnRefreshNotif">Refresh</button></div>
      </div>
      <table id="tblNotifications">
        <thead>
          <tr class="labels">
            <th style="width:140px">Date</th>
            <th style="width:150px">Subject</th>
            <th style="width:100px">Status</th>
            <th style="width:120px">Related ID</th>
            <th>Description</th>
          </tr>
          <tr class="filters">
            <th><input type="date" id="nDate"></th>
            <th><input type="text" id="nSubject" placeholder="Subject..."></th>
            <th><input type="text" id="nStatus" placeholder="Status..."></th>
            <th><input type="text" id="nRelId" placeholder="ID..."></th>
            <th><input type="text" id="nDesc" placeholder="Search..."></th>
          </tr>
        </thead>
        <tbody id="bodyNotifications"></tbody>
      </table>
    </div>
  </section>

  <section id="account" role="tabpanel">
    <div class="card">
      <div class="sectionbar"><div class="left"><h2>Account</h2></div></div>
      <div class="card">
        <div class="kv">
          <div class="k">Name</div><div id="accName">–</div>
          <div class="k">Email</div><div id="accEmail">–</div>
          <div class="k">Role</div><div id="accRole">–</div>
        </div>
        <hr class="sep">
        <div class="actions">
          <input type="text" id="fullName" placeholder="Full name">
          <input type="email" id="email" placeholder="Email">
          <input type="password" id="password" placeholder="Password">
          <select id="role"><option>Viewer</option><option>Admin</option><option>Strategic Program Advisor</option><option>Thematic Expert</option><option>Projectmanager</option></select>
          <button class="btn" id="btnSignup">Sign up</button>
          <button class="btn" id="btnSignin">Sign in</button>
          <button class="btn danger" id="btnSignout">Sign out</button>
        </div>
      </div>
    </div>
  </section>

  <section id="help" role="tabpanel">
    <div class="card">
      <div class="sectionbar"><div class="left"><h2>Help</h2></div></div>
      <div class="card">
        <p>Quick tips:</p>
        <ul>
          <li>Klik op een rij → overlay (INVULKAART) opent direct in edit-modus.</li>
          <li>Autosave slaat stil op (geen notification). Handmatige Save maakt 1 notification “Edited”.</li>
          <li>“+ New” knoppen koppelen nieuwe items automatisch aan het huidige parent item (en aan Goal als ID met G… begint).</li>
          <li>In de Ketting-grafiek is het huidige item 2× zo groot.</li>
        </ul>
      </div>
    </div>
  </section>
</main>

<!-- Overlay -->
<div id="overlay">
  <div class="ov-backdrop"></div>
  <div class="ov-panel">
    <div class="ov-header">
      <div>
        <div id="ovTitle" class="title">–</div>
        <div id="ovSub" class="sub">–</div>
      </div>
      <button class="btn" id="ovClose">Close</button>
    </div>
    <div id="ovBody" class="ov-body"></div>
    <div class="ov-footer">
      <div class="ov-actions">
        <button id="ovEdit" class="btn">Edit</button>
        <button id="ovSave" class="btn primary" disabled>Save</button>
        <button id="ovDelete" class="btn danger">Delete</button>
      </div>
      <span class="badge" id="ovMeta"></span>
    </div>
  </div>
</div>

<script>
"use strict";

// tiny DOM helpers
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function fmtDate(s){ if(!s) return ''; return String(s); }
function typeClass(coll){ return {goals:'goal',risks:'risk',issues:'issue',plans:'plan',questions:'question',suggestions:'suggestion'}[coll]||''; }
function label(row){ return escapeHtml(row?.id||''); }
function pickTime(row){ return row?.submitted || row?.start || row?.end || row?.reviewed || ''; }

// auth / user context (mock-safe)
let CURRENT_UID = '';
let CURRENT_NAME = '';
let CURRENT_ROLE = 'Viewer';
// FIREBASE (assume loaded elsewhere); guard for no-internet demo
let db=null, auth=null;
try{
  // eslint-disable-next-line no-undef
  db = firebase.firestore ? getFirestore() : null;
  // eslint-disable-next-line no-undef
  auth = firebase.auth ? getAuth() : null;
}catch(_e){}

/* Data cache */
const cache = {
  goals:[], risks:[], issues:[], plans:[], questions:[], suggestions:[], notifications:[]
};
let DATA_READY=false;

/* fieldsets for overlay */
const FIELDSETS = {
  goals: [
    ['goal','text','Goal','content'],
    ['owner','text','Owner','meta'],
    ['start','date','Start','dates'],
    ['end','date','End','dates'],
    ['status','select','Status','meta',['Open','In Progress','Closed']],
    ['notes','text','Notes','content'],
    ['parentId','text','Parent ID','dates'],
  ],
  risks: [
    ['description','text','Description','content'],
    ['owner','text','Owner','meta'],
    ['likelihood','select','Likelihood','meta',['Low','Medium','High']],
    ['status','select','Status','meta',['Open','In Progress','Closed']],
    ['mitigation','text','Mitigation','content'],
    ['parentId','text','Parent ID','dates'],
    ['goalId','text','Goal Link','dates'],
  ],
  issues: [
    ['description','text','Description','content'],
    ['owner','text','Owner','meta'],
    ['severity','select','Severity','meta',['Low','Medium','High']],
    ['status','select','Status','meta',['Open','In Progress','Closed']],
    ['resolution','text','Resolution','content'],
    ['parentId','text','Parent ID','dates'],
    ['goalId','text','Goal Link','dates'],
  ],
  plans: [
    ['description','text','Description','content'],
    ['owner','text','Owner','meta'],
    ['goalId','text','Goal Link','dates'],
    ['start','date','Start','dates'],
    ['end','date','End','dates'],
    ['status','select','Status','meta',['Open','In Progress','Closed']],
    ['parentId','text','Parent ID','dates'],
  ],
  questions: [
    ['description','text','Description','content'],
    ['subject','select','Subject','meta',['New Goal','New Risk','New Issue','New Plan']],
    ['owner','text','Owner','meta'],
    ['submitted','date','Submitted','dates'],
    ['reviewer','text','Reviewer','meta'],
    ['reviewerRole','select','Reviewer Role', ["","Admin","Strategic Program Advisor","Thematic Expert","Projectmanager"],'meta'],
    ['reviewed','date','Reviewed','dates'],
    ['comments','text','Comments','content'],
    ['stars','text','Stars','meta'],
    ['parentId','text','Parent ID','dates'],
    ['goalId','text','Goal Link','dates'],
  ],
  suggestions: [
    ['description','text','Description','content'],
    ['subject','select','Subject','meta',['New Goal','New Risk','New Issue','New Plan']],
    ['owner','text','Owner','meta'],
    ['submitted','date','Submitted','dates'],
    ['reviewer','text','Reviewer','meta'],
    ['reviewerRole','select','Reviewer Role', ["","Admin","Strategic Program Advisor","Thematic Expert","Projectmanager"],'meta'],
    ['reviewed','date','Reviewed','dates'],
    ['comments','text','Comments','content'],
    ['stars','text','Stars','meta'],
    ['parentId','text','Parent ID','dates'],
    ['goalId','text','Goal Link','dates'],
  ],
};

let OV = { coll:null, id:null, row:null, edit:true };
let _autosaveTimer = null;

/* mock firestore helpers to allow offline demo */
function getFirestore(){ return {}; }
function getAuth(){ return {}; }
async function setDoc(){ /* no-op in demo */ }
async function addDoc(){ /* no-op in demo */ }
async function updateDoc(){ /* no-op in demo */ }
async function deleteDoc(){ /* no-op in demo */ }
function collection(){ return {}; }
function doc(){ return {}; }
function onAuthStateChanged(_a, cb){ cb(null); }
async function signOut(){ CURRENT_UID=''; CURRENT_NAME=''; CURRENT_ROLE='Viewer'; }

/* UI helpers */
function getRow(coll,id){
  const list = cache[coll]||[];
  return list.find(x => String(x.id).trim() === String(id).trim());
}
function sectionWrap(title,inner){
  return `<div class="block"><details open><summary>${title}</summary>${inner}</details></div>`;
}
function inputHtml(name,type,label,opts,value,disabled){
  if(type==='select'){
    const options = (opts||[]).map(v=>`<option ${String(v)===(value||'')?'selected':''}>${v}</option>`).join('');
    return `<div class="form-row"><label for="f_${name}">${label}</label><select id="f_${name}" name="${name}" ${disabled}>${options}</select></div>`;
  }
  return `<div class="form-row"><label for="f_${name}">${label}</label><input id="f_${name}" name="${name}" type="${type}" value="${value||''}" ${disabled} /></div>`;
}

/* Render tables (simple) */
function renderTab(tab){
  $$('.tabs button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
  $$('section[role="tabpanel"]').forEach(s=>s.classList.toggle('active', s.id===tab));
  const body = {
    goals:'#bodyGoals', risks:'#bodyRisks', issues:'#bodyIssues', plans:'#bodyPlans',
    questions:'#bodyQuestions', suggestions:'#bodySuggestions', notifications:'#bodyNotifications'
  }['#'+tab];
  if(!body) return;
  const mount = $(body); mount.innerHTML = '';

  const rows = cache[tab]||[];
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.id||'')}</td>
      <td>${escapeHtml(r.goal || r.description || r.status || r.subject || r.date || '')}</td>
      <td>${escapeHtml(r.owner || r.status || r.subject || r.reviewer || '')}</td>
      <td>${escapeHtml(r.start || r.submitted || r.likelihood || r.severity || '')}</td>
      <td>${escapeHtml(r.end || r.reviewed || r.status || '')}</td>
      <td class="actions">
        <button class="btn" data-menu="${tab}">Open</button>
      </td>`;
    tr.addEventListener('click', (e)=>{
      if(e.target.closest('button[data-menu]')) return; // use button
      renderOverlay(tab, r.id);
    });
    const btn = tr.querySelector('button[data-menu]');
    btn.addEventListener('click', ()=>renderOverlay(tab, r.id));
    mount.appendChild(tr);
  });
}

/* Overlay render */
function renderOverlay(coll,id){
  const row = getRow(coll,id);
  if(!row){ alert('Item not found'); return;}
  OV = { coll, id, row: JSON.parse(JSON.stringify(row)), edit:true };
  $('#ovTitle').textContent = `${coll.slice(0,1).toUpperCase()+coll.slice(1,-1)} – ${id}`;
  $('#ovSub').textContent = `Type: ${coll} • ID: ${id}`;
  $('#ovMeta').textContent = 'editor';

  const cfg = FIELDSETS[coll]||[];
  const pieces = {content:'',meta:'',dates:''};
  cfg.forEach(f=>{
    const [name,type,label,group,opts] = f;
    const dis = !OV.edit ? 'disabled' : '';
    const val = row[name]||'';
    if(type==='select'){
      const options = (opts||[]).map(v=>`<option ${String(v)===(val||'')?'selected':''}>${v}</option>`).join('');
      pieces[group||'content'] += `<div class="form-row"><label for="f_${name}">${label}</label><select id="f_${name}" name="${name}" ${dis}>${options}</select></div>`;
    }else{
      pieces[group||'content'] += `<div class="form-row"><label for="f_${name}">${label}</label><input id="f_${name}" name="${name}" type="${type}" value="${val||''}" ${dis} /></div>`;
    }
  });

  let html = '';
  if(pieces.content) html += sectionWrap('Content', pieces.content);
  if(pieces.meta)    html += sectionWrap('Meta', pieces.meta);
  if(pieces.dates)   html += sectionWrap('Dates / Links', pieces.dates);
  html += renderHistory(id);

  $('#ovBody').innerHTML = `<div class="ov-split"><div class="ov-left">${html}</div><div class="ov-right"><h4>Ketting / Relaties</h4><div id="ovGraph" class="tree"></div></div></div>`;
  $('#overlay').classList.add('show');
  try{ annotateOverlayNextIds(); }catch(_e){}
  try{ renderLinkGraph(); }catch(_e){}
  $('#ovSave').disabled = !OV.edit;
  try{ setHash(Object.assign(parseHash(), {tab: document.querySelector('nav.tabs button.active')?.dataset.tab, item:id })); }catch(_e){}
  try{ setOverlayEdit(true); }catch(_e){}
}

/* Enable/disable inputs */
function setOverlayEdit(on){
  OV.edit = !!on;
  $$('#ovBody [name]').forEach(el=>{ el.disabled = !OV.edit; });
  $('#ovSave').disabled = !OV.edit;
}

/* Collect overlay updates */
function collectOverlayUpdates(){
  const cfg = FIELDSETS[OV.coll]||[];
  const updates = {};
  cfg.forEach(f=>{
    const name = f[0]; const el = document.querySelector(`#ovBody [name="${name}"]`);
    if(!el) return;
    const v = (el.tagName==='SELECT') ? el.value : el.value;
    if(OV.row[name] !== v){ updates[name] = v; }
  });
  return updates;
}

/* Save overlay: notifications ONLY on manual save (Edited). Autosave: none. */
async function saveOverlay(updates, opts={}){
  if(!OV.coll || !OV.id) return;
  if(OV.coll==='goals' && 'goal' in updates && (updates.goal||'').trim()===''){ alert('Goal is required'); return; }
  if(OV.coll==='plans' && 'goalId' in updates && updates.goalId && !/^G\d+$/i.test(String(updates.goalId||'').trim())){ alert('Goal Link must look like G1, G2, ...'); return; }
  try{
    if(Object.keys(updates).length){
      await updateDoc(doc(db, OV.coll, OV.id), updates);
      Object.assign(getRow(OV.coll,OV.id), updates);
      if (opts.source==='manual') {
        await addDoc(collection(db,'notifications'), makeNote({
          subject: OV.coll==='suggestions'?'Suggestion' : (OV.coll==='questions'?'Question' : OV.coll.slice(0,1).toUpperCase()+OV.coll.slice(1,-1)),
          status:'Edited',
          relatedId:OV.id,
          description: pickDesc(OV.coll==='suggestions'?'Suggestion' : (OV.coll==='questions'?'Question' : OV.coll.slice(0,1).toUpperCase()+OV.coll.slice(1,-1)), getRow(OV.coll,OV.id))
        }));
      }
      renderTab(document.querySelector('nav.tabs button.active')?.dataset.tab);
    }
    setOverlayEdit(false);
  }catch(err){ alert('save failed: '+err.message); }
}

/* Overlay events */
document.addEventListener('click', (e)=>{
  const menuBtn = e.target.closest('[data-menu]');
  if(menuBtn){
    const coll = menuBtn.dataset.menu;
    const tr = menuBtn.closest('tr');
    const id = tr?.querySelector('td:first-child')?.innerText.trim();
    if(coll && id) renderOverlay(coll,id);
  }
});
$('#ovClose')?.addEventListener('click', closeOverlay);
$('#overlay')?.addEventListener('click', (e)=>{ if(e.target.classList.contains('ov-backdrop')) closeOverlay(); });
$('#ovEdit')?.addEventListener('click', ()=> setOverlayEdit(true));
$('#ovSave')?.addEventListener('click', async ()=>{
  const updates = collectOverlayUpdates();
  await saveOverlay(updates, {source:'manual'});
});
$('#ovDelete')?.addEventListener('click', async ()=>{
  const coll = OV.coll, id = OV.id;
  if(!confirm(`Delete ${id}?`)) return;
  try{
    await deleteDoc(doc(db, coll, id));
    cache[coll] = (cache[coll]||[]).filter(x=>x.id!==id);
    await addDoc(collection(db,'notifications'), makeNote({
      subject: coll==='suggestions'?'Suggestion' : (coll==='questions'?'Question' : coll.slice(0,1).toUpperCase()+coll.slice(1,-1)),
      status:'Deleted', relatedId:id, description:''
    }));
    renderTab(document.querySelector('nav.tabs button.active')?.dataset.tab);
    closeOverlay();
  }catch(err){ alert('delete failed: '+err.message); }
});
function closeOverlay(){ $('#overlay').classList.remove('show'); OV=null; try{ const h=parseHash(); delete h.item; setHash(h);}catch(_e){} }

/* Autosave (no notifications) */
$('#ovBody')?.addEventListener('input', ()=>{
  if(!OV?.edit) return;
  clearTimeout(_autosaveTimer);
  _autosaveTimer = setTimeout(()=>{ const updates = collectOverlayUpdates(); if(Object.keys(updates).length) saveOverlay(updates, {source:'auto'}); }, 120000);
});

/* + New (from overlay header). Links to parent. No notification on add. */
const PREFIX = {goals:'G',risks:'R',issues:'I',plans:'P',questions:'Q',suggestions:'S'};
function nextId(list, prefix){
  const nums = (list||[]).map(x=>parseInt(String(x.id||'').replace(/\D/g,''),10)).filter(n=>!isNaN(n));
  const max = nums.length? Math.max(...nums) : 0;
  return prefix + (max+1);
}
async function addNew(coll, forcedId){
  if(!DATA_READY){ alert('Data wordt geladen. Probeer zo nogmaals.'); return; }

  const prefix = PREFIX[coll];
  const id = (forcedId && String(forcedId).trim()) || nextId(cache[coll]||[], prefix);
  const defaults = {
    goals:       (id)=>({id, goal:'', owner:'', start:'', end:'', status:'Open', notes:'', parentId:''}),
    risks:       (id)=>({id, description:'', owner:'', likelihood:'Medium', status:'Open', mitigation:'', parentId:'', goalId:''}),
    issues:      (id)=>({id, description:'', owner:'', severity:'Medium', status:'Open', resolution:'', parentId:'', goalId:''}),
    plans:       (id)=>({id, description:'', owner:'', goalId:'', start:'', end:'', status:'Open', parentId:''}),
    questions:   (id)=>({id, description:'', subject:'New Goal', owner:CURRENT_ROLE||'Viewer', submitted:new Date().toISOString().slice(0,10), reviewer:'', reviewerRole:'', reviewed:'', comments:'', stars:0, starredBy:{}, parentId:'', goalId:''}),
    suggestions: (id)=>({id, description:'', subject:'New Goal', owner:CURRENT_ROLE||'Viewer', submitted:new Date().toISOString().slice(0,10), reviewer:'', reviewerRole:'', reviewed:'', comments:'', stars:0, starredBy:{}, parentId:'', goalId:''}),
  };
  const row = defaults[coll](id);
  if(OV && OV.id){ row.parentId = OV.id; }
  if(OV && OV.coll==='goals' && coll!=='goals'){ row.goalId = OV.id; }
  await setDoc(doc(db, coll, id), row);
  cache[coll].push(row);
  renderTab(coll);
  renderOverlay(coll,id);
}

/* Render History in overlay (reads from cache.notifications) */
function renderHistory(id){
  let list = (cache.notifications||[]).filter(n=> String(n.relatedId||n.id||'')===String(id));
  list.sort((a,b)=> String(a.date||'').localeCompare(String(b.date||'')));
  if(!list.length) return '';
  const items = list.slice(-10).map(n=>`<div class="form-row"><label>Date</label><div>${escapeHtml(n.date||'')} – <b>${escapeHtml(n.subject||'')}</b> – ${escapeHtml(n.status||'')}</div><label>Description</label><div>${escapeHtml(n.description||'')}</div></div>`).join('');
  return sectionWrap('History (last 10)', items);
}

/* Build and render the chain graph for the current overlay item */
function renderLinkGraph(){
  const mount = $('#ovGraph'); if(!mount) return;
  const hasOV = (typeof OV !== 'undefined' && OV && OV.id && OV.coll);
  const nodes = {};
  ['goals','risks','issues','plans','questions','suggestions'].forEach(coll=>{
    (cache[coll]||[]).forEach(row=>{ nodes[row.id] = {id:row.id, coll, data:row}; });
  });
  let current = hasOV ? nodes[OV.id] : null;

  function nodeHtml(n){
    const isCurrent = hasOV && n.id===OV.id && n.coll===OV.coll;
    const t = fmtDate(pickTime(n.data));
    const cls = `node ${typeClass(n.coll)}${isCurrent?' current':''}`;
    let timeHtml = t ? `<span class="time">• ${t}</span>` : '';
    return `<div class="${cls}" data-id="${n.id}" data-coll="${n.coll}"><span class="id">${escapeHtml(n.id)}</span>${timeHtml}</div>`;
  }

  let html = '';
  if(current){
    html += `<div>${nodeHtml(current)}</div>`;
    // simple neighbors by parent/goalId
    const kids = Object.values(nodes).filter(n=> (n.data.parentId===current.id) || (n.data.goalId===current.id));
    if(kids.length){
      html += `<div>${kids.map(nodeHtml).join('')}</div>`;
    }
    const parent = nodes[current.data.parentId]; if(parent){ html = `<div>${nodeHtml(parent)}</div>` + html; }
    const g = nodes[current.data.goalId]; if(g && g.id!==current.id){ html += `<div>${nodeHtml(g)}</div>`; }
  }
  mount.innerHTML = html;
  // click handler
  mount.addEventListener('click', (e)=>{
    const n = e.target.closest('.node'); if(!n) return;
    const id = n.dataset.id; const coll = n.dataset.coll;
    renderOverlay(coll,id);
  }, {once:true});
}

/* Suggestions / Questions quick add (prompt) – now link to parent & no notif */
$('#addSuggestionBtn').onclick = async ()=>{ const id = await nextUniqueId('suggestions','S');
  let description = (prompt('Describe your suggestion (required):','')||'').trim();
  if(!description){ alert('description required'); return; }
  const subject = prompt('Subject (New Goal / New Risk / New Issue / New Plan):','New Goal') || 'New Goal';
  const owner = CURRENT_ROLE || 'Viewer';
  const today = new Date().toISOString().slice(0,10);
  const suggestion = { id, description, subject, owner, submitted: today, reviewer:'', reviewerRole: '', reviewed: '', comments: '', stars:0, starredBy:{} };
  // link to parent if available (overlay or #item)
  const _h = (typeof parseHash==='function') ? parseHash() : {};
  const _parent = (OV && OV.id) || (_h && _h.item) || '';
  if(_parent){ suggestion.parentId = _parent; if(String(_parent).charAt(0).toUpperCase()==='G'){ suggestion.goalId = _parent; } }
  try{
    await setDoc(doc(db,'suggestions', id), suggestion);
    cache.suggestions.push(suggestion);
    renderSuggestions();
  }catch(err){ alert('Could not add: '+err.message); }
};

$('#addQuestionBtn').onclick = async ()=>{ const id = await nextUniqueId('questions','Q');
  let description = (prompt('Describe your question (required):','')||'').trim();
  if(!description){ alert('description required'); return; }
  const subject = prompt('Subject (New Goal / New Risk / New Issue / New Plan):','New Goal') || 'New Goal';
  const owner = CURRENT_ROLE || 'Viewer';
  const today = new Date().toISOString().slice(0,10);
  const qdoc = { id, description, subject, owner, submitted: today, reviewer:'', reviewerRole: '', reviewed: '', comments: '', stars:0, starredBy:{} };
  // link to parent if available (overlay or #item)
  const _h = (typeof parseHash==='function') ? parseHash() : {};
  const _parent = (OV && OV.id) || (_h && _h.item) || '';
  if(_parent){ qdoc.parentId = _parent; if(String(_parent).charAt(0).toUpperCase()==='G'){ qdoc.goalId = _parent; } }
  try{
    await setDoc(doc(db,'questions', id), qdoc);
    cache.questions.push(qdoc);
    renderQuestions();
  }catch(err){ alert('Could not add: '+err.message); }
};

/* Rendering lists */
function renderGoals(){ renderTab('goals'); }
function renderRisks(){ renderTab('risks'); }
function renderIssues(){ renderTab('issues'); }
function renderPlans(){ renderTab('plans'); }
function renderQuestions(){ renderTab('questions'); }
function renderSuggestions(){ renderTab('suggestions'); }
function renderNotifications(){
  const mount = $('#bodyNotifications'); mount.innerHTML='';
  (cache.notifications||[]).forEach(n=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(n.date||'')}</td><td>${escapeHtml(n.subject||'')}</td><td>${escapeHtml(n.status||'')}</td><td>${escapeHtml(n.relatedId||'')}</td><td>${escapeHtml(n.description||'')}</td>`;
    mount.appendChild(tr);
  });
}

/* Tabs click */
document.querySelector('nav.tabs')?.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-tab]'); if(!btn) return;
  renderTab(btn.dataset.tab);
  const h = parseHash(); h.tab = btn.dataset.tab; setHash(h);
});

/* Basic filtering wiring (no-op demo) */
$$('tr.filters input, tr.filters select').forEach(el=> el.addEventListener('input', ()=>{
  const tab = document.querySelector('nav.tabs button.active')?.dataset.tab;
  if(tab) renderTab(tab);
}));

/* Notifications – helper to craft note */
function makeNote({subject,status,relatedId,description}){
  return {date:new Date().toISOString().slice(0,10), subject,status, relatedId, description};
}

/* Bulk Save (other tabs) keeps their notification behavior – as in original */
async function saveAll(){
  const tasks = [];
  const notes = [];
  const prevCache = JSON.parse(JSON.stringify(cache));

  function upserts(prev, next, coll, subj){
    const map = Object.fromEntries((prev||[]).map(x=>[x.id, x]));
    (next||[]).forEach(row=>{
      const was = map[row.id];
      if(!was){ notes.push(makeNote({subject:`New ${subj}`, status:'Added', relatedId:row.id, description: row.goal||row.description||''})); }
      else if(JSON.stringify(was)!==JSON.stringify(row)){
        notes.push(makeNote({subject:subj, status:'Edited', relatedId:row.id, description: row.goal||row.description||''}));
      }
    });
  }

  // Example: compare sets (goals/risks/issues/plans)
  const newGoals = cache.goals; const newRisks = cache.risks; const newIssues = cache.issues; const newPlans = cache.plans;
  upserts(prevCache.goals,newGoals,'goals','Goal');
  upserts(prevCache.risks,newRisks,'risks','Risk');
  upserts(prevCache.issues,newIssues,'issues','Issue');
  upserts(prevCache.plans, newPlans, 'plans', 'Plan');

  await Promise.all(tasks);
  if(notes.length) await Promise.all(notes.map(n=>addDoc(collection(db,'notifications'), n)));
  alert('saved to firestore');
  await loadAll();
}

/* Quick ID helpers for S/Q */
async function nextUniqueId(coll,prefix){
  const list = cache[coll]||[]; return nextId(list, prefix);
}

/* Hash & Query deep linking */
function parseHash(){ const h=location.hash.replace(/^#/,''); if(!h) return {}; const sp=new URLSearchParams(h); const o={}; for(const [k,v] of sp) o[k]=v; return o; }
function setHash(obj){ const h=new URLSearchParams(obj).toString(); history.replaceState(null,'', '#'+h); }
function openFromHash(){
  const h = parseHash();
  if(h.tab){
    const btn = document.querySelector(`.tabs button[data-tab="${h.tab}"]`);
    if(btn){ btn.click(); }
  }
  const urlItem = new URL(location.href).searchParams.get('item');
  if(!h.item && urlItem){ h.item = urlItem; }
  if(h.item){
    const id = h.item.trim();
    const prefix = id[0].toUpperCase();
    const coll = {G:'goals',R:'risks',I:'issues',P:'plans',Q:'questions',S:'suggestions'}[prefix];
    if(coll){ renderOverlay(coll,id); }
  }
}
window.addEventListener('hashchange', openFromHash);

/* Close overlay */
function closeOverlay(){ $('#overlay').classList.remove('show'); OV=null; try{ const h=parseHash(); delete h.item; setHash(h);}catch(_e){} }

/* Init dummy data (for offline demo) */
function seed(){
  cache.goals = [
    {id:'G1', goal:'Launch pilot', owner:'Anna', start:'2025-01-01', end:'2025-03-31', status:'Open', notes:'', parentId:''},
    {id:'G2', goal:'Scale program', owner:'Ben', start:'2025-04-01', end:'2025-06-30', status:'In Progress', notes:'', parentId:''},
  ];
  cache.risks = [
    {id:'R1', description:'Budget risk', owner:'Anna', likelihood:'Medium', status:'Open', mitigation:'', parentId:'G1', goalId:'G1'},
  ];
  cache.issues = [
    {id:'I1', description:'Supplier delay', owner:'Ben', severity:'High', status:'Open', resolution:'', parentId:'G2', goalId:'G2'},
  ];
  cache.plans = [
    {id:'P1', description:'Outreach plan', owner:'Anna', goalId:'G1', start:'2025-01-15', end:'2025-02-28', status:'Open', parentId:'G1'},
  ];
  cache.questions = [
    {id:'Q1', description:'Do we need extra budget?', subject:'New Goal', owner:'Viewer', submitted:'2025-01-10', reviewer:'', reviewerRole:'', reviewed:'', comments:'', stars:0, starredBy:{}, parentId:'G1', goalId:'G1'},
  ];
  cache.suggestions = [
    {id:'S1', description:'Consider a phased rollout', subject:'New Plan', owner:'Viewer', submitted:'2025-01-12', reviewer:'', reviewerRole:'', reviewed:'', comments:'', stars:0, starredBy:{}, parentId:'G1', goalId:'G1'},
  ];
  cache.notifications = [
    {date:'2025-01-12', subject:'Goal', status:'Edited', relatedId:'G1', description:'Updated details'},
  ];
  DATA_READY=true;
}

/* Wire up */
document.addEventListener('DOMContentLoaded', ()=>{
  seed();
  renderTab('goals');
  openFromHash();
  // enable add buttons if needed (demo keeps disabled except S/Q)
});

/* Simple overlay next-id annotator (optional) */
function annotateOverlayNextIds(){
  // could compute and place next IDs on +New buttons if present
}
/* Renderers for each list – thin wrappers used earlier */
function buildRowHtml(coll, r){
  const fields = {
    goals:[r.id, r.goal, r.owner, r.start, r.end, r.status],
    risks:[r.id, r.description, r.owner, r.likelihood, r.status],
    issues:[r.id, r.description, r.owner, r.severity, r.status],
    plans:[r.id, r.description, r.owner, r.goalId, r.start],
    questions:[r.id, r.description, r.subject, r.owner, r.submitted],
    suggestions:[r.id, r.description, r.subject, r.owner, r.submitted],
  }[coll]||[];
  return fields.map(x=>`<td>${escapeHtml(x||'')}</td>`).join('');
}

// Additional UI events
document.addEventListener('click', (e)=>{
  const menuBtn = e.target.closest('[data-menu]');
  if(menuBtn){
    const coll = menuBtn.dataset.menu;
    const tr = menuBtn.closest('tr');
    const id = tr?.querySelector('td:first-child')?.innerText.trim();
    if(coll && id) renderOverlay(coll,id);
  }
});

// Account actions (mock)
$('#btnSignup').onclick=async ()=>{
  const fullName=$('#fullName').value.trim(); const email=($('#email').value||'').trim(); const role=$('#role').value; const pass=$('#password').value;
  if(!fullName||!email||!pass){ alert('Fill all fields'); return; }
  try{
    CURRENT_UID = 'uid_demo'; CURRENT_NAME=fullName; CURRENT_ROLE=role;
    $('#accName').textContent = fullName; $('#accEmail').textContent=email; $('#accRole').textContent=role;
    alert('signed up (demo)');
  }catch(e){ alert(e.message); }
};
$('#btnSignin').onclick=async ()=>{
  const fullName=$('#fullName').value.trim(); const email=($('#email').value||'').trim(); const rolePick=$('#role').value; const pass=$('#password').value;
  if(!fullName||!email||!pass){ alert('Fill all fields'); return; }
  try{
    CURRENT_UID = 'uid_demo'; CURRENT_NAME=fullName; CURRENT_ROLE=rolePick;
    $('#accName').textContent = fullName; $('#accEmail').textContent=email; $('#accRole').textContent=rolePick;
    alert('signed in (demo)');
  }catch(e){ alert('login failed: '+e.message); }
};
$('#btnSignout').onclick=()=>{ CURRENT_UID=''; CURRENT_NAME=''; CURRENT_ROLE='Viewer'; $('#accName').textContent='–'; $('#accEmail').textContent='–'; $('#accRole').textContent='–'; alert('signed out'); };

// Click handlers to open overlay from table button
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-menu]'); if(!btn) return;
  const tr = btn.closest('tr'); const id = tr?.querySelector('td:first-child')?.innerText.trim();
  const coll = btn.dataset.menu;
  if(coll && id){ renderOverlay(coll,id); }
});

// Close overlay via backdrop already wired
// End of script
</script>

</body>
</html>

