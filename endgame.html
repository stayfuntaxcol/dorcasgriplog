<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRIPlog – Honey Value Chain</title>
  <link rel="icon" href="assets/dorcas-logo.svg" />
  <style>
    :root{ --bg:#f6f7fb;--card:#ffffff;--ink:#111827;--muted:#6b7280;--line:#e5e7eb; --brand:#0ea5a3;--danger:#ef4444;--ok:#10b981; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
    header img{height:34px;width:auto}
    header .title{font-weight:800;font-size:18px}
    header .sub{color:var(--muted);font-size:12px}

    .toolbar{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:10px 16px;background:#f0f5f5;border-bottom:1px solid var(--line)}
    .leftbar{display:flex;gap:8px;align-items:center}
    .rightbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}

    .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:14px}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .btn.danger{background:#fee2e2;border-color:#fecaca}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .input, select, input[type="text"], input[type="password"], input[type="email"]{border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff;font-size:14px}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:#bbb}
    .ok{background:var(--ok)}
    .user-info{font-size:12px;color:var(--ink);margin-left:8px;text-transform:lowercase}

    nav.tabs{display:flex;gap:8px;padding:10px 16px;background:var(--card);border-bottom:1px solid var(--line)}
    nav.tabs button{border:none;background:#eaf6f6;color:#065a59;padding:8px 10px;border-radius:10px;font-weight:700;cursor:pointer}
    nav.tabs button.active{background:#0ea5a3;color:#fff}
    nav.tabs .push-right{margin-left:auto}

    section{display:none;padding:14px 16px}
    section.active{display:block}

    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    h2{margin:0 0 6px 0;font-size:18px}
    p.help{margin:0 0 10px 0;color:var(--muted);font-size:12px}

    .sectionbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:6px 0}
    .sectionbar .left{display:flex;gap:8px;align-items:center}
    .sectionbar .right{display:flex;gap:8px;align-items:center}

    table{width:100%;border-collapse:collapse}
    th, td{border:1px solid var(--line);padding:6px 8px;vertical-align:top;font-size:14px;background:#fff}
    th{background:#f9fbfb;text-align:left}
    thead tr.filters th{background:#fff}

    .row-actions{display:flex;gap:6px}

    footer{padding:16px;color:var(--muted);font-size:12px}
    @media (max-width: 880px){ th, td{font-size:13px} }
  </style>
</head>
<body>
  <header>
    <img src="assets/dorcas-logo.svg" alt="Dorcas" onerror="this.style.display='none'">
    <div>
      <div class="title">GRIPlog – Honey Value Chain (Kitui)</div>
      <div class="sub">Get a GRIP: Goals • Risks • Issues • Plans • Suggestions • Notifications</div>
    </div>
  </header>

  <div class="toolbar">
    <div class="leftbar">
      <button id="btnLoad" class="btn">Load from Firestore</button>
      <button id="btnSaveAll" class="btn primary" disabled>Save all</button>
    </div>

    <div class="rightbar">
      <input id="fullName" class="input" placeholder="full name *" />
      <input id="email" class="input" type="email" placeholder="email (required for editors)" />
      <input id="org" class="input" placeholder="organization *" />
      <select id="role" class="input">
        <option value="Viewer" selected>Viewer (read-only)</option>
        <option>Admin</option>
        <option>Projectmanager</option>
        <option>Strategic Program Advisor</option>
        <option>Thematic Expert</option>
      </select>
      <input id="password" class="input" type="password" placeholder="password *" />
      <button id="btnSignup" class="btn">register</button>
      <button id="btnSignin" class="btn primary">login</button>
      <button id="btnSignout" class="btn" style="display:none">logout</button>
      <span class="chip"><span id="authDot" class="dot"></span><span id="authTxt">not signed in</span></span>
      <span id="userInfo" class="user-info"></span>
    </div>
  </div>

  <!-- Tabs -->
  <nav class="tabs" role="tablist">
    <button class="active" data-tab="goals">G – Goals</button>
    <button data-tab="risks">R – Risks</button>
    <button data-tab="issues">I – Issues</button>
    <button data-tab="plans">P – Plans</button>
    <button class="push-right" data-tab="suggestions">S – Suggestions</button>
    <button data-tab="notifications">N – Notifications</button>
  </nav>

  <!-- Suggestions -->
  <section id="suggestions" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left"><h2>Suggestions</h2></div>
        <div class="right"><button class="btn" id="addSuggestionBtn">+ New Suggestion</button></div>
      </div>
      <table id="tblSuggestions">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:150px">Subject</th>
            <th style="width:180px">Owner</th>
            <th style="width:140px">Submitted</th>
            <th style="width:140px">Status</th>
            <th style="width:180px">Reviewer Role</th>
            <th style="width:140px">Reviewed</th>
            <th>Comments</th>
            <th style="width:140px">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Notifications -->
  <section id="notifications" role="tabpanel">
    <div class="card">
      <div class="sectionbar">
        <div class="left"><h2>Notifications</h2></div>
        <div class="right">
          <!-- alleen Admin kan een losse (handmatige) notification toevoegen, verstoppen we via JS -->
          <button class="btn" id="addNotifBtn" style="display:none">+ New Notification</button>
        </div>
      </div>
      <table id="tblNotifications">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:150px">Subject</th>
            <th style="width:150px">Status</th>
            <th style="width:180px">Role</th>
            <th style="width:140px">Date</th>
            <th>Comments</th>
            <th style="width:110px">Stars</th>
            <th style="width:160px">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="help">Everyone can ⭐ a notification. Only <strong>Admin</strong> can edit or delete notifications.</p>
    </div>
  </section>

  <!-- Simple placeholders for the 4 main tabs so the file stays self-contained -->
  <section id="goals" class="active" role="tabpanel"><div class="card"><h2>Goals</h2><p class="help">Placeholder table (wire into your existing Goals UI if needed).</p></div></section>
  <section id="risks" role="tabpanel"><div class="card"><h2>Risks</h2><p class="help">Placeholder table.</p></div></section>
  <section id="issues" role="tabpanel"><div class="card"><h2>Issues</h2><p class="help">Placeholder table.</p></div></section>
  <section id="plans" role="tabpanel"><div class="card"><h2>Plans</h2><p class="help">Placeholder table.</p></div></section>

  <footer>© <span id="yr"></span> Dorcas / GRIPlog – role-based viewer/editor.</footer>

<script type="module"> import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"; import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"; import { getFirestore, collection, getDocs, setDoc, doc, serverTimestamp, getDoc, deleteDoc, updateDoc, increment, query, where } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"; const firebaseConfig = { apiKey: "AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps", authDomain: "griplog.firebaseapp.com", projectId: "griplog", storageBucket: "griplog.appspot.com", messagingSenderId: "1097061844582", appId: "1:1097061844582:web:5fc1c25e320af9c9384fa7" }; const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app); const $ = (q,root=document)=>root.querySelector(q); const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q)); $('#yr').textContent = new Date().getFullYear(); // ------- Auth minimal (ongewijzigd t.o.v. jouw versie) ------- const EDIT_ROLES = new Set(['Admin','Projectmanager','Strategic Program Advisor','Thematic Expert']); let CURRENT_UID = null; let CURRENT_ROLE = 'Viewer'; function slugEmailFromName(name){ return name.trim().toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,40)+"@griplog.local"; } async function upsertUserDoc(uid, data){ const ref=doc(db,'users',uid); const snap=await getDoc(ref); await setDoc(ref, snap.exists()? {...snap.data(), ...data} : data, {merge:true}); } $('#btnSignup').onclick=async ()=>{ const fullName=$('#fullName').value.trim(); const email=($('#email').value||'').trim(); const org=$('#org').value.trim(); const role=$('#role').value; const pass=$('#password').value; if(!fullName||!org||!pass){ alert('fill required fields'); return; } if(EDIT_ROLES.has(role) && !email){ alert('email required for editors'); return; } const used=email||slugEmailFromName(fullName); try{ const cred=await createUserWithEmailAndPassword(auth, used, pass); await updateProfile(cred.user,{displayName:fullName}); await upsertUserDoc(cred.user.uid,{ fullName, email: email||'', org, role, createdAt: serverTimestamp() }); alert('registered. please login.'); await signOut(auth); }catch(e){ alert(e.code==='auth/email-already-in-use' ? 'account exists. login.' : e.message); } }; $('#btnSignin').onclick=async ()=>{ const fullName=$('#fullName').value.trim(); const email=($('#email').value||'').trim(); const rolePick=$('#role').value; const pass=$('#password').value; if(!fullName||!pass){ alert('fill required fields'); return; } if(EDIT_ROLES.has(rolePick) && !email){ alert('email required for editors'); return; } const used=email||slugEmailFromName(fullName); try{ const cred=await signInWithEmailAndPassword(auth, used, pass); if(EDIT_ROLES.has(rolePick) && email){ await upsertUserDoc(cred.user.uid,{ role: rolePick, email, fullName }); } }catch(e){ alert('login failed: '+e.message); } }; $('#btnSignout').onclick=()=>signOut(auth); onAuthStateChanged(auth, async (user)=>{ const authDot=$('#authDot'), authTxt=$('#authTxt'), userInfo=$('#userInfo'); if(!user){ CURRENT_UID=null; CURRENT_ROLE='Viewer'; authDot.classList.remove('ok'); authTxt.textContent='not signed in'; userInfo.textContent=''; $('#btnSignout').style.display='none'; renderAll(); return; } $('#btnSignout').style.display='inline-block'; authDot.classList.add('ok'); CURRENT_UID = user.uid; CURRENT_ROLE = 'Viewer'; let full=user.displayName||user.email||''; try{ const snap=await getDoc(doc(db,'users',user.uid)); if(snap.exists()){ const d=snap.data(); CURRENT_ROLE=d.role||'Viewer'; full=d.fullName||full; } else{ await upsertUserDoc(user.uid,{ fullName: full, email: user.email||'', role: 'Viewer' }); } }catch(_){} authTxt.textContent = CURRENT_ROLE.toLowerCase(); userInfo.textContent = `${(full||'').toLowerCase()} – ${CURRENT_ROLE.toLowerCase()}`; await loadAll(); }); // ================== ⭐ STAR SYSTEM (generic) ================== // Storage-model per document: // - stars: number (totaal) // - starredBy: map { "<uid>": timestamp true|ISO|string } -> we zetten serverTimestamp(), rules kunnen true vereisen. // // Helpers: function hasStar(data, uid){ return !!(data?.starredBy && data.starredBy[uid]); } function starCellHTML(coll, id, data){ const count = data?.stars || 0; const already = (CURRENT_UID && hasStar(data, CURRENT_UID)); const title = already ? 'You starred this' : 'Add star'; return ` <button class="btn ghost" title="${title}" data-star="${coll}:${id}" ${already?'disabled':''}>⭐</button> <span data-stars="${coll}:${id}">${count}</span> `; } async function starDoc(coll, id){ if(!CURRENT_UID){ alert('sign in to star'); return; } const ref = doc(db, coll, id); const snap = await getDoc(ref); if(!snap.exists()) return; const data = snap.data(); if(hasStar(data, CURRENT_UID)) return; // dubbel voorkomen aan clientzijde // patch: +1 en markeer uid const patch = { stars: increment(1) }; patch[`starredBy.${CURRENT_UID}`] = new Date().toISOString(); // of true; zorg dat je rules dit toestaan await updateDoc(ref, patch); // UI bijwerken als de cel aanwezig is const cnt = document.querySelector(`[data-stars="${coll}:${id}"]`); if(cnt) cnt.textContent = String((data.stars||0)+1); const btn = document.querySelector(`[data-star="${coll}:${id}"]`); if(btn) btn.disabled = true; } function wireStarClicks(){ document.addEventListener('click', async (e)=>{ const key = e.target?.dataset?.star; if(!key) return; const [coll, id] = key.split(':'); try{ await starDoc(coll, id); } catch(err){ alert('star failed: '+err.message); } }); } // Overzicht: items die IK heb gestarred (per collectie) async function listMyStars(){ if(!CURRENT_UID){ alert('sign in first'); return; } const cols = ['goals','risks','issues','plans','suggestions','notifications']; const results = []; for(const c of cols){ // Firestore ondersteunt map-query: where("starredBy.<uid>", "==", true|<value>) // We zoeken op niet-null; hier gebruiken we "== true" als je rules true opslaan. const qy = query(collection(db, c), where(`starredBy.${CURRENT_UID}`, '!=', null)); try{ const snap = await getDocs(qy); snap.docs.forEach(d=>results.push({coll:c, id:d.id, ...d.data()})); }catch(_){ /* collectie kan ontbreken → negeren */ } } if(results.length===0){ alert('No stars yet.'); return; } const lines = results .sort((a,b)=>(a.coll+a.id).localeCompare(b.coll+b.id)) .map(r=>`${r.coll.toUpperCase()} • ${r.id} • ${r.subject||r.description||r.goal||''}`); alert(`Your starred items:\n\n${lines.join('\n')}`); } // Voeg knopje toe in toolbar (rechts) om eigen sterren te bekijken (function addMyStarsButton(){ const btn = document.createElement('button'); btn.className='btn'; btn.textContent='My ⭐'; btn.title='Show items you starred'; btn.id='btnMyStars'; $('.rightbar')?.prepend(btn); btn.onclick = listMyStars; })(); // ================== NOTIFICATIONS (met ⭐) ================== async function loadNotifications(){ const snap = await getDocs(collection(db,'notifications')); const rows = snap.docs.map(d=>({id:d.id,...d.data()})); renderNotifications(rows); } function renderNotifications(rows){ const tbody=$('#tblNotifications tbody'); tbody.innerHTML=''; rows.sort((a,b)=> (b.date||'').localeCompare(a.date||'')); // nieuwste eerst rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=` <td>${r.id}</td> <td>${escapeHtml(r.description||'')}</td> <td>${escapeHtml(r.subject||'')}</td> <td>${escapeHtml(r.status||'')}</td> <td>${escapeHtml(r.role||'')}</td> <td>${escapeHtml(r.date||'')}</td> <td>${escapeHtml(r.comments||'')}</td> <td>${starCellHTML('notifications', r.id, r)}</td> <td>${(CURRENT_ROLE==='Admin')?('<button class="btn danger" data-del-notif="'+r.id+'">Del</button>'):'—'}</td>`; tbody.appendChild(tr); }); } // Delete (Admin) document.addEventListener('click', async (e)=>{ if(e.target?.dataset?.delNotif){ if(CURRENT_ROLE!=='Admin'){ alert('Admin only'); return; } const id=e.target.dataset.delNotif; if(!confirm(`Delete notification ${id}?`)) return; await deleteDoc(doc(db,'notifications',id)); loadNotifications(); } }); // ---------- Utilities ---------- function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); } async function loadAll(){ await loadNotifications(); } function renderAll(){ const active = document.querySelector('nav.tabs button.active')?.dataset.tab || 'notifications'; if(active==='notifications') loadNotifications(); } // Init $('#btnLoad').onclick = loadAll; $('#btnSaveAll').onclick = ()=> alert('Hook your bulk save here.'); wireStarClicks(); loadAll(); </script> Hoe voeg je ⭐ toe aan Goals/Risks/Issues/Plans/Suggestions? 

In jouw rij-renderfunctie (waar je <td>…</td> opbouwt), voeg een extra kolom toe met:

// voorbeeld voor Goals: <td>${starCellHTML('goals', row.id, row)}</td> 

En zorg dat het document de velden heeft (bij save/seed):

{ id:'G1', goal:'…', /* … */ stars: 0, starredBy: {} } 

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
    $('#yr').textContent = new Date().getFullYear();

    // ---------- Roles / rights ----------
    const EDIT_ROLES = new Set(['Admin','Projectmanager','Strategic Program Advisor','Thematic Expert']);
    let CAN_ADMIN = false;  // only Admin can edit/delete notifications
    let CURRENT_UID = null;

    function slugEmailFromName(name){ return name.trim().toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,40)+"@griplog.local"; }
    async function upsertUserDoc(uid, data){ const ref=doc(db,'users',uid); const snap=await getDoc(ref); await setDoc(ref, snap.exists()? {...snap.data(), ...data} : data, {merge:true}); }

    // ---------- Auth UI ----------
    $('#btnSignup').onclick=async ()=>{
      const fullName=$('#fullName').value.trim(); const email=($('#email').value||'').trim(); const org=$('#org').value.trim(); const role=$('#role').value; const pass=$('#password').value;
      if(!fullName||!org||!pass){ alert('fill required fields'); return; }
      if(EDIT_ROLES.has(role) && !email){ alert('email required for editors'); return; }
      const used=email||slugEmailFromName(fullName);
      try{
        const cred=await createUserWithEmailAndPassword(auth, used, pass);
        await updateProfile(cred.user,{displayName:fullName});
        await upsertUserDoc(cred.user.uid,{ fullName, email: email||'', org, role, createdAt: serverTimestamp() });
        alert('registered. please login.');
        await signOut(auth);
      }catch(e){ alert(e.code==='auth/email-already-in-use' ? 'account exists. login.' : e.message); }
    };
    $('#btnSignin').onclick=async ()=>{
      const fullName=$('#fullName').value.trim(); const email=($('#email').value||'').trim(); const rolePick=$('#role').value; const pass=$('#password').value;
      if(!fullName||!pass){ alert('fill required fields'); return; }
      if(EDIT_ROLES.has(rolePick) && !email){ alert('email required for editors'); return; }
      const used=email||slugEmailFromName(fullName);
      try{
        const cred=await signInWithEmailAndPassword(auth, used, pass);
        // Optional: update chosen role at login
        if(EDIT_ROLES.has(rolePick) && email){ await upsertUserDoc(cred.user.uid,{ role: rolePick, email, fullName }); }
      }catch(e){ alert('login failed: '+e.message); }
    };
    $('#btnSignout').onclick=()=>signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      const authDot=$('#authDot'), authTxt=$('#authTxt'), userInfo=$('#userInfo');
      if(!user){ CURRENT_UID=null; CAN_ADMIN=false; authDot.classList.remove('ok'); authTxt.textContent='not signed in'; userInfo.textContent=''; $('#btnSignout').style.display='none'; $('#addNotifBtn').style.display='none'; renderAll(); return; }
      $('#btnSignout').style.display='inline-block'; authDot.classList.add('ok');

      CURRENT_UID=user.uid;
      let role='Viewer', full=user.displayName||user.email||'';
      try{
        const snap=await getDoc(doc(db,'users',user.uid));
        if(snap.exists()){ const d=snap.data(); role=d.role||role; full=d.fullName||full; }
        else{ await upsertUserDoc(user.uid,{ fullName: full, email: user.email||'', role: 'Viewer' }); }
      }catch(err){ console.warn('role load failed', err); }

      CAN_ADMIN = (role === 'Admin') && !!user.email;
      authTxt.textContent = CAN_ADMIN ? 'admin' : 'viewer';
      userInfo.textContent = `${(full||'').toLowerCase()} – ${role.toLowerCase()}`;
      // show add notification button only to Admin
      $('#addNotifBtn').style.display = CAN_ADMIN ? 'inline-block' : 'none';

      await loadAll();
    });

    // ---------- Tabs ----------
    $$('.tabs button').forEach(btn=>btn.addEventListener('click',()=>{
      $$('.tabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      const tab=btn.dataset.tab; $$('section').forEach(s=>s.classList.remove('active')); $('#'+tab).classList.add('active');
      renderTab(tab);
    }));

    function renderAll(){
      const active = document.querySelector('nav.tabs button.active')?.dataset.tab || 'goals';
      renderTab(active);
    }
    function renderTab(kind){
      if(kind==='notifications') loadNotifications();
      else if(kind==='suggestions') loadSuggestions();
      // other tabs are placeholders in this file
    }

    // ---------- Suggestions (minimal) ----------
    const suggestionSubjects = ["","New Goal","New Risk","New Issue","New Plan","New Suggestion","Goal","Risk","Issue","Plan","Suggestion"];
    const suggestionStatus   = ["","Added","Edited","Deleted","Reviewed","Approved","Dismissed","Considered"];
    const suggestionReviewer = ["","Admin","Strategic Program Advisor","Thematic Expert","Projectmanager"];

    async function loadSuggestions(){
      const snap = await getDocs(collection(db,'suggestions'));
      const rows = snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>num(a.id)-num(b.id));
      renderSuggestions(rows);
    }

    function rowSuggestion(r, editable){
      const subjectSel = `<select ${editable?'' : 'disabled'}>${suggestionSubjects.map(s=>`<option ${s===r.subject?'selected':''}>${s}</option>`).join('')}</select>`;
      const ownerSel   = `<input type="text" value="${r.owner||''}" ${editable?'' : 'disabled'} />`;
      const statusSel  = `<select ${editable?'' : 'disabled'}>${suggestionStatus.map(s=>`<option ${s===r.status?'selected':''}>${s}</option>`).join('')}</select>`;
      const revRoleSel = `<select ${editable?'' : 'disabled'}>${suggestionReviewer.map(o=>`<option ${o===r.reviewerRole?'selected':''}>${o}</option>`).join('')}</select>`;
      const subDate    = `<input type="date" value="${r.submitted||''}" ${editable?'' : 'disabled'} />`;
      const revDate    = `<input type="date" value="${r.reviewed||''}" ${editable?'' : 'disabled'} />`;
      const actions    = `<div class="row-actions">
        <button class="btn" data-save-sug="${r.id}">Save</button>
        <button class="btn danger" data-del-sug="${r.id}">Del</button>
      </div>`;
      return `
        <td contenteditable="false">${escapeHtml(r.id||'')}</td>
        <td>${editable? `<textarea>${escapeHtml(r.description||'')}</textarea>` : `<div>${escapeHtml(r.description||'')}</div>`}</td>
        <td>${subjectSel}</td>
        <td>${ownerSel}</td>
        <td>${subDate}</td>
        <td>${statusSel}</td>
        <td>${revRoleSel}</td>
        <td>${revDate}</td>
        <td>${editable? `<textarea>${escapeHtml(r.comments||'')}</textarea>` : `<div>${escapeHtml(r.comments||'')}</div>`}</td>
        <td>${actions}</td>`;
    }

    function renderSuggestions(rows){
      const tbody=$('#tblSuggestions tbody'); tbody.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = rowSuggestion(r, true);
        tbody.appendChild(tr);
      });
    }

    // Add / Save / Delete suggestions (and create notifications accordingly)
    $('#addSuggestionBtn').onclick = async ()=>{
      const id = await nextIdFromCollection('suggestions','S');
      const today = new Date().toISOString().slice(0,10);
      const payload = { id, description:'', subject:'New Suggestion', owner:'', submitted: today, status:'Added', reviewerRole:'', reviewed:'', comments:'' };
      await setDoc(doc(db,'suggestions',id), payload);
      await createNotification({ description:`${id} created`, subject:'New Suggestion', status:'Added', role:'Projectmanager', comments:'' });
      await loadSuggestions();
    };

    document.addEventListener('click', async (e)=>{
      // save suggestion
      if(e.target.dataset.saveSug){
        const tr = e.target.closest('tr'); const id=e.target.dataset.saveSug;
        const tds=Array.from(tr.querySelectorAll('td'));
        const updated = {
          id,
          description: (tds[1].querySelector('textarea,div').value || tds[1].querySelector('textarea,div').innerText || '').trim(),
          subject: tds[2].querySelector('select').value,
          owner: tds[3].querySelector('input').value,
          submitted: tds[4].querySelector('input').value||'',
          status: tds[5].querySelector('select').value,
          reviewerRole: tds[6].querySelector('select').value,
          reviewed: tds[7].querySelector('input').value||'',
          comments: (tds[8].querySelector('textarea,div').value || tds[8].querySelector('textarea,div').innerText || '').trim()
        };
        await setDoc(doc(db,'suggestions',id), updated);
        const notifStatus = updated.reviewed ? 'Reviewed' : 'Edited';
        await createNotification({ description:`${id} ${notifStatus.toLowerCase()}`, subject:'Suggestion', status:notifStatus, role: updated.reviewerRole||'Projectmanager', comments: updated.comments||'' });
        alert('Suggestion saved');
      }
      // delete suggestion
      if(e.target.dataset.delSug){
        const id=e.target.dataset.delSug;
        if(!confirm(`Delete ${id}?`)) return;
        await deleteDoc(doc(db,'suggestions',id));
        await createNotification({ description:`${id} deleted`, subject:'Suggestion', status:'Deleted', role:'Admin', comments:'' });
        await loadSuggestions();
      }
    });

    // ---------- Notifications ----------
    const notifSubjects = ["New Goal","New Risk","New Issue","New Plan","New Suggestion","Goal","Risk","Issue","Plan","Suggestion"];
    const notifStatus   = ["Added","Edited","Deleted","Reviewed","Approved","Dismissed","Considered"];
    const notifRoles    = ["Admin","Strategic Program Advisor","Thematic Expert","Projectmanager"];

    async function loadNotifications(){
      const snap = await getDocs(collection(db,'notifications'));
      const rows = snap.docs.map(d=>({id:d.id,...d.data()}))
        .sort((a,b)=> (b.date||'').localeCompare(a.date||'')); // newest first
      renderNotifications(rows);
    }

    function renderNotifications(rows){
      const tbody=$('#tblNotifications tbody');
      tbody.innerHTML='';
      rows.forEach(r=>{
        const editableRow = CAN_ADMIN; // only Admin can edit
        const subjSel  = `<select ${editableRow?'' : 'disabled'}>${notifSubjects.map(s=>`<option ${s===r.subject?'selected':''}>${s}</option>`).join('')}</select>`;
        const statusSel= `<select ${editableRow?'' : 'disabled'}>${notifStatus.map(s=>`<option ${s===r.status?'selected':''}>${s}</option>`).join('')}</select>`;
        const roleSel  = `<select ${editableRow?'' : 'disabled'}>${notifRoles.map(s=>`<option ${s===r.role?'selected':''}>${s}</option>`).join('')}</select>`;
        const dateInp  = `<input type="date" value="${(r.date||'').slice(0,10)}" ${editableRow?'' : 'disabled'} />`;
        const descCell = editableRow? `<textarea>${escapeHtml(r.description||'')}</textarea>` : `<div>${escapeHtml(r.description||'')}</div>`;
        const commCell = editableRow? `<textarea>${escapeHtml(r.comments||'')}</textarea>` : `<div>${escapeHtml(r.comments||'')}</div>`;
        const starBtn  = `<button class="btn ghost" data-star="${r.id}">⭐</button> <span data-stars="${r.id}">${r.stars||0}</span>`;
        const actions  = CAN_ADMIN
          ? `<div class="row-actions">
               <button class="btn" data-save-notif="${r.id}">Save</button>
               <button class="btn danger" data-del-notif="${r.id}">Del</button>
             </div>`
          : '—';

        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.id}</td>
          <td>${descCell}</td>
          <td>${subjSel}</td>
          <td>${statusSel}</td>
          <td>${roleSel}</td>
          <td>${dateInp}</td>
          <td>${commCell}</td>
          <td>${starBtn}</td>
          <td>${actions}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Create notification (anywhere in app)
    async function createNotification({description, subject, status, role, comments}){
      const id = crypto.randomUUID();            // doc id
      const date = new Date().toISOString().slice(0,10);
      const docData = {
        id, description: description||'',
        subject: subject||'Suggestion',
        status: status||'Added',
        role: role||'Projectmanager',
        date, comments: comments||'',
        stars: 0, starredBy: {}
      };
      await setDoc(doc(db,'notifications', id), docData);
    }
    // Expose helper (optioneel voor je Goals/Risks/Issues/Plans pagina-logica)
    window.createNotification = createNotification;

    // Star & Admin actions
    document.addEventListener('click', async (e)=>{
      // ⭐
      if(e.target.dataset.star){
        const id = e.target.dataset.star;
        const ref=doc(db,'notifications',id);
        const snap=await getDoc(ref);
        if(!snap.exists()) return;
        const data=snap.data();
        if(data.starredBy && data.starredBy[CURRENT_UID]) return; // al gestemd
        const newStars = (data.stars||0)+1;
        const patch = { stars: newStars };
        patch[`starredBy.${CURRENT_UID}`] = true;
        try{
          await updateDoc(ref, patch);
          // update UI count
          const cnt = document.querySelector(`[data-stars="${id}"]`);
          if(cnt) cnt.textContent = String(newStars);
        }catch(err){ alert('star failed: '+err.message); }
      }

      // Save notif (Admin only)
      if(e.target.dataset.saveNotif){
        if(!CAN_ADMIN){ alert('Admin only'); return; }
        const id = e.target.dataset.saveNotif;
        const tr = e.target.closest('tr');
        const tds=Array.from(tr.querySelectorAll('td'));
        const updated = {
          id,
          description: (tds[1].querySelector('textarea,div').value || tds[1].querySelector('textarea,div').innerText || '').trim(),
          subject: tds[2].querySelector('select').value,
          status: tds[3].querySelector('select').value,
          role: tds[4].querySelector('select').value,
          date: tds[5].querySelector('input').value || new Date().toISOString().slice(0,10),
          comments: (tds[6].querySelector('textarea,div').value || tds[6].querySelector('textarea,div').innerText || '').trim(),
        };
        try{
          await setDoc(doc(db,'notifications',id), updated, {merge:true});
          alert('notification saved');
        }catch(err){ alert('save failed: '+err.message); }
      }

      // Delete notif (Admin only)
      if(e.target.dataset.delNotif){
        if(!CAN_ADMIN){ alert('Admin only'); return; }
        const id = e.target.dataset.delNotif;
        if(!confirm(`Delete notification ${id}?`)) return;
        try{
          await deleteDoc(doc(db,'notifications',id));
          await loadNotifications();
        }catch(err){ alert('delete failed: '+err.message); }
      }
    });

    // Manual add (Admin)
    $('#addNotifBtn').onclick = async ()=>{
      if(!CAN_ADMIN) return;
      await createNotification({ description:'manual notification', subject:'Suggestion', status:'Added', role:'Admin', comments:'' });
      await loadNotifications();
    };

    // ---------- Load all first ----------
    async function loadAll(){ await Promise.all([loadSuggestions(), loadNotifications()]); }
    $('#btnLoad').onclick = loadAll;
    // Save-all knop blijft hier zonder implementatie (je oude CRUD kan hieraan koppelen)
    $('#btnSaveAll').onclick = ()=> alert('Hook your bulk save logic here.');

    // ---------- Utils ----------
    function num(id){ const n=parseInt(String(id||'').replace(/\D+/g,''),10); return isNaN(n)?0:n; }
    function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    async function nextIdFromCollection(coll,prefix){
      const snap=await getDocs(collection(db,coll));
      let max=0; snap.docs.forEach(d=>{ const n=parseInt(String(d.id||'').replace(/\D+/g,''))||0; if(n>max) max=n; });
      return `${prefix}${max+1}`;
    }

    // Initial view
    renderAll();
  </script>
</body>
</html>
