<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GRIPlog • Admin Users</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#131825; --panel2:#0f1420; --muted:#9aa7bf; --text:#e8eefc;
      --accent:#6ea8fe; --ok:#29c48a; --warn:#ffcc66; --bad:#ff6b6b; --line:#243049;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(180deg,#070911,#0b0d12); color:var(--text)}
    header{padding:18px 16px;border-bottom:1px solid var(--line);background:rgba(10,12,18,.85);position:sticky;top:0;backdrop-filter: blur(8px);}
    h1{margin:0;font-size:18px}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){ .grid{grid-template-columns: 420px 1fr;} }
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input, select, textarea{
      width:100%; background:#0b1020; border:1px solid #263252; color:var(--text);
      border-radius:10px; padding:10px 10px; outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(110,168,254,.15)}
    button{
      border:1px solid #2a3a60; background:#0f1629; color:var(--text);
      padding:9px 12px; border-radius:10px; cursor:pointer;
    }
    button:hover{border-color:#3a5190}
    button.primary{background:rgba(110,168,254,.12); border-color:rgba(110,168,254,.45)}
    button.good{background:rgba(41,196,138,.12); border-color:rgba(41,196,138,.45)}
    button.bad{background:rgba(255,107,107,.12); border-color:rgba(255,107,107,.45)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .pill b{color:var(--text);font-weight:600}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .muted{color:var(--muted)}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th, td{padding:10px 8px; border-bottom:1px solid var(--line); vertical-align:top}
    th{color:var(--muted); text-align:left; font-weight:600}
    tr:hover td{background:rgba(255,255,255,.02)}
    .right{margin-left:auto}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .small{font-size:12px}
    .notice{border:1px dashed #3a4a74; padding:10px 12px; border-radius:12px; background:rgba(110,168,254,.06); color:var(--muted)}
    .hidden{display:none!important}
    .divider{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>
<body>
<header>
  <div class="wrap row">
    <h1>GRIPlog • Admin Users</h1>
    <span class="pill right">Status: <b id="status">niet ingelogd</b></span>
  </div>
</header>

<div class="wrap grid">
  <section class="card" id="cardAuth">
    <h2 style="margin:0 0 8px;font-size:15px">Login (admin)</h2>
    <div class="notice small">
      Alleen jouw admin-account kan hier users beheren. Dit scherm werkt met Firestore <span class="mono">users/{uid}</span> docs + de rules.
    </div>

    <label>Email</label>
    <input id="loginEmail" type="email" placeholder="jij@domein.nl" autocomplete="username"/>

    <label>Wachtwoord</label>
    <input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password"/>

    <div class="row" style="margin-top:12px">
      <button class="primary" id="btnLogin">Inloggen</button>
      <button id="btnLogout" class="hidden">Uitloggen</button>
      <button id="btnResetSelf">Wachtwoord vergeten</button>
    </div>

    <div class="divider"></div>

    <div class="kpi">
      <span class="pill">Admin email: <b class="mono" id="adminEmail"></b></span>
      <span class="pill">App login link: <b class="mono" id="appUrl"></b></span>
      <button id="btnCopyAppUrl" class="small">Copy link</button>
    </div>

    <div class="divider"></div>

    <div id="noAccess" class="notice hidden">
      Je bent wel ingelogd, maar je account is niet admin volgens <span class="mono">ADMIN_EMAIL</span>.
    </div>
  </section>

  <section class="card hidden" id="cardAdmin">
    <div class="row">
      <h2 style="margin:0;font-size:15px">Gebruikers beheren</h2>
      <span class="pill right">Users: <b id="countUsers">0</b></span>
      <button id="btnRefresh">Refresh</button>
    </div>

    <div class="divider"></div>

    <h3 style="margin:0 0 8px;font-size:14px">Nieuwe gebruiker aanmaken</h3>
    <div class="row">
      <div style="flex:1 1 240px">
        <label>Email (verplicht)</label>
        <input id="newEmail" type="email" placeholder="naam@bedrijf.nl" autocomplete="off"/>
      </div>
      <div style="flex:1 1 180px">
        <label>Naam</label>
        <input id="newName" type="text" placeholder="Voornaam Achternaam"/>
      </div>
      <div style="flex:1 1 180px">
        <label>Organisatie</label>
        <input id="newOrg" type="text" placeholder="Bedrijf / Team"/>
      </div>
    </div>

    <div class="row">
      <div style="flex:1 1 220px">
        <label>Rol</label>
        <select id="newRole">
          <option value="User">User (Q+S schrijven/wijzigen, geen delete)</option>
          <option value="Viewer">Viewer (alleen ster in Q+S)</option>
          <option value="Project Manager">Project Manager (alles in GRIP + Q/S)</option>
          <option value="Strategic Program Advisor">Strategic Program Advisor (alles in GRIP + Q/S)</option>
          <option value="Thematic Expert">Thematic Expert (alles in GRIP + Q/S)</option>
        </select>
      </div>
      <div style="flex:1 1 220px">
        <label>Tijdelijk wachtwoord</label>
        <input id="newPass" type="text" placeholder="Laat leeg voor auto-generate"/>
      </div>
      <div style="flex:1 1 220px">
        <label>&nbsp;</label>
        <button id="btnGenPass">Genereer</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <label style="margin:0;display:flex;gap:10px;align-items:center">
        <input id="chkSendReset" type="checkbox" style="width:auto;margin:0"/>
        Stuur meteen een “set password” mail (wachtwoord-reset) naar deze gebruiker
      </label>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="good" id="btnCreateUser">Create user</button>
      <button id="btnCopyInvite">Copy uitnodigingstekst</button>
    </div>

    <label>Uitnodigingstekst (copy/paste)</label>
    <textarea id="inviteText" readonly></textarea>

    <div class="divider"></div>

    <div class="row" style="margin-top:6px">
      <h3 style="margin:0;font-size:14px">Bestaande users</h3>
      <input id="filter" type="text" placeholder="Filter op naam/email/org/rol" style="max-width:320px" class="right"/>
    </div>

    <div style="overflow:auto;border:1px solid var(--line);border-radius:12px;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>UID</th>
            <th>Naam</th>
            <th>Email</th>
            <th>Org</th>
            <th>Rol</th>
            <th class="small">Acties</th>
          </tr>
        </thead>
        <tbody id="usersTbody"></tbody>
      </table>
    </div>

    <div class="divider"></div>

    <div class="notice small">
      Let op: “Delete” verwijdert alleen het <span class="mono">users/{uid}</span> document, niet het account in Firebase Authentication.
      Account echt verwijderen/disable kan alleen via Admin SDK of handmatig in Firebase Console.
    </div>
  </section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged,
    sendPasswordResetEmail, createUserWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // ==== CONFIG (pas dit aan) ====
  const firebaseConfig = {
    apiKey: "AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps",
    authDomain: "griplog.firebaseapp.com",
    projectId: "griplog",
    storageBucket: "griplog.appspot.com",
    messagingSenderId: "1097061844582",
    appId: "1:1097061844582:web:5fc1c25e320af9c9384fa7"
  };

  // Deze email moet exact overeenkomen met je Firebase Auth email (Stephan)
  const ADMIN_EMAIL = "s.tollenaar@dorcas.nl";

  // Link naar jouw GRIPlog app (waar gebruikers moeten inloggen)
  const APP_LOGIN_URL = (location.origin + location.pathname).replace(/\/[^\/]*$/, "/GRIPlog_Kitui_WASH_import.html");

  // ==== init ====
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Secondary app/auth om users aan te maken zonder dat jij uitlogt
  const secondaryApp = initializeApp(firebaseConfig, "secondary");
  const secondaryAuth = getAuth(secondaryApp);

  // ==== ui helpers ====
  const $ = (s) => document.querySelector(s);
  const el = {
    status: $("#status"),
    adminEmail: $("#adminEmail"),
    appUrl: $("#appUrl"),
    btnCopyAppUrl: $("#btnCopyAppUrl"),
    btnLogin: $("#btnLogin"),
    btnLogout: $("#btnLogout"),
    btnResetSelf: $("#btnResetSelf"),
    noAccess: $("#noAccess"),
    cardAdmin: $("#cardAdmin"),
    countUsers: $("#countUsers"),
    btnRefresh: $("#btnRefresh"),
    usersTbody: $("#usersTbody"),
    filter: $("#filter"),

    newEmail: $("#newEmail"),
    newName: $("#newName"),
    newOrg: $("#newOrg"),
    newRole: $("#newRole"),
    newPass: $("#newPass"),
    btnGenPass: $("#btnGenPass"),
    chkSendReset: $("#chkSendReset"),
    btnCreateUser: $("#btnCreateUser"),
    btnCopyInvite: $("#btnCopyInvite"),
    inviteText: $("#inviteText"),
  };

  el.adminEmail.textContent = ADMIN_EMAIL;
  el.appUrl.textContent = APP_LOGIN_URL;

  function isAdminUser(user){
    const email = (user?.email || "").toLowerCase();
    return email && email === ADMIN_EMAIL.toLowerCase();
  }

  function genPass(len=12){
    const a="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@$%";
    let out="";
    crypto.getRandomValues(new Uint32Array(len)).forEach(n=> out += a[n % a.length]);
    return out;
  }

  async function copyText(text){
    try { await navigator.clipboard.writeText(text); alert("Copied"); }
    catch { prompt("Copy:", text); }
  }

  function buildInviteText({name,email,role,pass}){
    const lines = [];
    lines.push(`Hi ${name||""}`.trim() || "Hi");
    lines.push("");
    lines.push("Je account voor GRIPlog is aangemaakt.");
    lines.push(`Login: ${APP_LOGIN_URL}`);
    lines.push(`Email: ${email}`);
    if(pass) lines.push(`Tijdelijk wachtwoord: ${pass}`);
    lines.push("");
    lines.push("Na inloggen: kies 'Wachtwoord vergeten' om je eigen wachtwoord te zetten (of gebruik de reset mail).");
    lines.push(`Rol: ${role}`);
    return lines.join("\\n");
  }

  // ==== Auth UI ====
  el.btnLogin.onclick = async () => {
    const email = $("#loginEmail").value.trim();
    const pass = $("#loginPass").value;
    if(!email || !pass) return alert("Vul email + wachtwoord.");
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      console.error(e);
      alert(e?.message || String(e));
    }
  };

  el.btnLogout.onclick = async () => {
    await signOut(auth);
  };

  el.btnResetSelf.onclick = async () => {
    const email = $("#loginEmail").value.trim();
    if(!email) return alert("Vul je email in en klik opnieuw.");
    try{
      await sendPasswordResetEmail(auth, email);
      alert("Reset mail verstuurd (check inbox/spam).");
    }catch(e){
      console.error(e);
      alert(e?.message || String(e));
    }
  };

  el.btnCopyAppUrl.onclick = () => copyText(APP_LOGIN_URL);

  // ==== Users table ====
  let USERS = [];

  function roleOptionsHtml(selected){
    const roles = [
      "User",
      "Viewer",
      "Project Manager",
      "Strategic Program Advisor",
      "Thematic Expert"
    ];
    return roles.map(r => `<option value="${r}" ${r===selected?"selected":""}>${r}</option>`).join("");
  }

  function rowHtml(u){
    const uid = u.__id;
    const name = u.fullName || "";
    const email = u.email || "";
    const org = u.org || "";
    const role = u.role || "User";
    return `
      <tr data-uid="${uid}">
        <td class="mono small">${uid}</td>
        <td><input data-k="fullName" value="${escapeHtml(name)}"></td>
        <td><input data-k="email" value="${escapeHtml(email)}"></td>
        <td><input data-k="org" value="${escapeHtml(org)}"></td>
        <td>
          <select data-k="role">${roleOptionsHtml(role)}</select>
        </td>
        <td class="small">
          <div class="row" style="gap:8px">
            <button class="good" data-act="save">Save</button>
            <button data-act="reset">Reset</button>
            <button class="bad" data-act="del">Delete doc</button>
          </div>
        </td>
      </tr>`;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderUsers(){
    const q = (el.filter.value || "").trim().toLowerCase();
    const list = !q ? USERS : USERS.filter(u => {
      const s = `${u.__id} ${u.fullName||""} ${u.email||""} ${u.org||""} ${u.role||""}`.toLowerCase();
      return s.includes(q);
    });

    el.countUsers.textContent = String(list.length);
    el.usersTbody.innerHTML = list.map(rowHtml).join("") || `<tr><td colspan="6" class="muted">Geen users gevonden.</td></tr>`;
  }

  async function loadUsers(){
    const snap = await getDocs(collection(db, "users"));
    USERS = snap.docs.map(d => ({__id: d.id, ...d.data()}))
      .sort((a,b) => (a.role||"").localeCompare(b.role||"") || (a.email||"").localeCompare(b.email||""));
    renderUsers();
  }

  el.filter.oninput = renderUsers;
  el.btnRefresh.onclick = async ()=> {
    try { await loadUsers(); }
    catch(e){ console.error(e); alert(e?.message || String(e)); }
  };

  el.usersTbody.onclick = async (ev) => {
    const btn = ev.target.closest("button[data-act]");
    if(!btn) return;
    const tr = ev.target.closest("tr[data-uid]");
    const uid = tr?.dataset?.uid;
    if(!uid) return;

    const data = {};
    tr.querySelectorAll("[data-k]").forEach(inp => {
      const k = inp.dataset.k;
      data[k] = inp.value.trim();
    });

    const ref = doc(db, "users", uid);
    const act = btn.dataset.act;

    try{
      if(act === "save"){
        data.updatedAt = serverTimestamp();
        await updateDoc(ref, data);
        alert("Saved");
        await loadUsers();
      }
      if(act === "del"){
        if(!confirm("Zeker? Dit verwijdert alleen het users/{uid} document.")) return;
        await deleteDoc(ref);
        alert("Deleted doc");
        await loadUsers();
      }
      if(act === "reset"){
        if(!data.email) return alert("Geen email ingevuld.");
        await sendPasswordResetEmail(auth, data.email);
        alert("Reset mail verstuurd.");
      }
    }catch(e){
      console.error(e);
      alert(e?.message || String(e));
    }
  };

  // ==== Create user flow ====
  el.btnGenPass.onclick = ()=> {
    el.newPass.value = genPass();
  };

  function updateInvitePreview(){
    const email = el.newEmail.value.trim();
    const name = el.newName.value.trim();
    const role = el.newRole.value;
    const pass = el.newPass.value.trim();
    el.inviteText.value = buildInviteText({name,email,role,pass});
  }

  ["input","change"].forEach(evt=>{
    el.newEmail.addEventListener(evt, updateInvitePreview);
    el.newName.addEventListener(evt, updateInvitePreview);
    el.newOrg.addEventListener(evt, updateInvitePreview);
    el.newRole.addEventListener(evt, updateInvitePreview);
    el.newPass.addEventListener(evt, updateInvitePreview);
  });

  el.btnCopyInvite.onclick = ()=> copyText(el.inviteText.value || "");

  el.btnCreateUser.onclick = async ()=> {
    const email = el.newEmail.value.trim();
    const fullName = el.newName.value.trim();
    const org = el.newOrg.value.trim();
    const role = el.newRole.value;
    let pass = el.newPass.value.trim();

    if(!email) return alert("Email is verplicht.");
    if(!pass) { pass = genPass(); el.newPass.value = pass; }

    try{
      // 1) Create auth user in secondary auth
      const cred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);
      const uid = cred.user.uid;

      // 2) Create users/{uid} doc (role + profile)
      await setDoc(doc(db, "users", uid), {
        email,
        fullName,
        org,
        role,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge: true });

      // 3) Optional: send password reset mail so user can set their own password
      if(el.chkSendReset.checked){
        await sendPasswordResetEmail(auth, email);
      }

      // 4) Sign out secondary auth (cleanup)
      await signOut(secondaryAuth);

      // 5) Show summary + refresh list
      el.inviteText.value = buildInviteText({name:fullName,email,role,pass});
      await loadUsers();
      alert(`User created.\nUID: ${uid}`);

    }catch(e){
      console.error(e);
      alert(e?.message || String(e));
      try{ await signOut(secondaryAuth); }catch{}
    }
  };

  // ==== State handling ====
  onAuthStateChanged(auth, async (user) => {
    if(!user){
      el.status.textContent = "niet ingelogd";
      el.btnLogout.classList.add("hidden");
      el.cardAdmin.classList.add("hidden");
      el.noAccess.classList.add("hidden");
      return;
    }

    el.status.textContent = user.email || user.uid;
    el.btnLogout.classList.remove("hidden");

    if(!isAdminUser(user)){
      el.cardAdmin.classList.add("hidden");
      el.noAccess.classList.remove("hidden");
      return;
    }

    el.noAccess.classList.add("hidden");
    el.cardAdmin.classList.remove("hidden");

    // preload
    try{ await loadUsers(); }catch(e){ console.error(e); alert(e?.message || String(e)); }
  });

  // init preview
  updateInvitePreview();
</script>
</body>
</html>
