<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRIPlog – Honey Value Chain</title>
  <link rel="icon" href="assets/dorcas-logo.svg" />
  <style>
    :root{ --bg:#f6f7fb;--card:#ffffff;--ink:#111827;--muted:#6b7280;--line:#e5e7eb; --brand:#0ea5a3;--danger:#ef4444;--ok:#10b981; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
    header img{height:34px;width:auto}
    header .title{font-weight:800;font-size:18px}
    header .sub{color:var(--muted);font-size:12px}

    .toolbar{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:10px 16px;background:#f0f5f5;border-bottom:1px solid var(--line)}
    .leftbar{display:flex;gap:8px;align-items:center}
    .rightbar{display:flex;gap:8px;align-items:center;justify-content:flex-end}

    .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:14px}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .btn.danger{background:#fee2e2;border-color:#fecaca}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .input, select, input[type="text"], input[type="password"], input[type="email"]{border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff;font-size:14px}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:#bbb}
    .ok{background:var(--ok)}
    .user-info{font-size:12px;color:var(--ink);margin-left:8px;text-transform:lowercase}

    nav.tabs{display:flex;gap:8px;padding:10px 16px;background:var(--card);border-bottom:1px solid var(--line)}
    nav.tabs button{border:none;background:#eaf6f6;color:#065a59;padding:8px 10px;border-radius:10px;font-weight:700;cursor:pointer}
    nav.tabs button.active{background:#0ea5a3;color:#fff}

    section{display:none;padding:14px 16px}
    section.active{display:block}

    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    h2{margin:0 0 6px 0;font-size:18px}

    table{width:100%;border-collapse:collapse}
    th, td{border:1px solid var(--line);padding:6px 8px;vertical-align:top;font-size:14px;background:#fff}
    th{background:#f9fbfb;text-align:left}
    thead tr.filters th{background:#fff}

    .row-actions{display:flex;gap:6px}

    footer{padding:16px;color:var(--muted);font-size:12px}
    @media (max-width: 880px){ th, td{font-size:13px} }
  </style>
</head>
<body>
  <header>
    <img src="assets/dorcas-logo.svg" alt="Dorcas" onerror="this.style.display='none'">
    <div>
      <div class="title">GRIPlog – Honey Value Chain (Kitui)</div>
      <div class="sub">Get a GRIP: Goals • Risks • Issues • Plans • Notifications</div>
    </div>
  </header>

  <div class="toolbar">
    <div class="leftbar">
      <button id="btnLoad" class="btn">Load from Firestore</button>
      <button id="btnSaveAll" class="btn primary">Save all</button>
      <button id="btnAddRow" class="btn ghost" style="display:none">+ New (current tab)</button>
    </div>

    <div class="rightbar">
      <input id="fullName" class="input" placeholder="full name *" />
      <input id="email" class="input" type="email" placeholder="email (required for editors)" />
      <input id="org" class="input" placeholder="organization *" />
      <select id="role" class="input">
        <option value="Viewer" selected>Viewer (read-only)</option>
        <option>Sponsor/ Partner</option>
        <option>Account manager</option>
        <option>Admin</option>
        <option>Projectmanager</option>
        <option>Strategic Program Advisor</option>
        <option>Thematic Expert</option>
        <option>Strategic Partnership & Resource Advisor</option>
        <option>Program Knowledge Support</option>
        <option>Engagement & Fundraising</option>
        <option>Public Engagement</option>
        <option>Finance Officer</option>
        <option>IT specialist</option>
        <option>HR Officer</option>
        <option>Corporate Positioning</option>
        <option>Other</option>
      </select>
      <input id="password" class="input" type="password" placeholder="password *" />
      <button id="btnSignup" class="btn">register</button>
      <button id="btnSignin" class="btn primary">login</button>
      <button id="btnSignout" class="btn" style="display:none">logout</button>
      <span class="chip"><span id="authDot" class="dot"></span><span id="authTxt">not signed in</span></span>
      <span id="userInfo" class="user-info"></span>
    </div>
  </div>

  <nav class="tabs" role="tablist">
    <button class="active" data-tab="goals">G – Goals</button>
    <button data-tab="risks">R – Risks</button>
    <button data-tab="issues">I – Issues</button>
    <button data-tab="plans">P – Plans</button>
    <button data-tab="notifications">N – Notifications</button>
  </nav>

  <!-- Goals -->
  <section id="goals" class="active" role="tabpanel">
    <div class="card">
      <h2>Goals</h2>
      <table id="tblGoals">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Goal (SMART)</th>
            <th style="width:160px">Owner</th>
            <th style="width:130px">Start</th>
            <th style="width:130px">End</th>
            <th style="width:140px">Status</th>
            <th>Notes</th>
            <th style="width:140px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="gSearch" class="input" placeholder="search goal/notes" /></th>
            <th><select id="gOwner" class="input"></select></th>
            <th><input type="date" id="gStartFrom" class="input" /></th>
            <th><input type="date" id="gEndTo" class="input" /></th>
            <th><select id="gStatus" class="input"></select></th>
            <th></th>
            <th><button id="gReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Risks -->
  <section id="risks" role="tabpanel">
    <div class="card">
      <h2>Risks</h2>
      <table id="tblRisks">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:160px">Owner</th>
            <th style="width:120px">Likelihood</th>
            <th style="width:120px">Impact</th>
            <th style="width:140px">Status</th>
            <th>Mitigation</th>
            <th style="width:140px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="rSearch" class="input" placeholder="search description/mitigation" /></th>
            <th><select id="rOwner" class="input"></select></th>
            <th><select id="rLikelihood" class="input"></select></th>
            <th><select id="rImpact" class="input"></select></th>
            <th><select id="rStatus" class="input"></select></th>
            <th></th>
            <th><button id="rReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Issues -->
  <section id="issues" role="tabpanel">
    <div class="card">
      <h2>Issues</h2>
      <table id="tblIssues">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:160px">Owner</th>
            <th style="width:120px">Severity</th>
            <th style="width:140px">Status</th>
            <th>Resolution</th>
            <th style="width:140px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="iSearch" class="input" placeholder="search description/resolution" /></th>
            <th><select id="iOwner" class="input"></select></th>
            <th><select id="iSeverity" class="input"></select></th>
            <th><select id="iStatus" class="input"></select></th>
            <th></th>
            <th><button id="iReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Plans -->
  <section id="plans" role="tabpanel">
    <div class="card">
      <h2>Plans</h2>
      <table id="tblPlans">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:160px">Owner</th>
            <th style="width:140px">Goal Link</th>
            <th style="width:130px">Start</th>
            <th style="width:130px">End</th>
            <th style="width:140px">Status</th>
            <th style="width:140px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="pSearch" class="input" placeholder="search description" /></th>
            <th><select id="pOwner" class="input"></select></th>
            <th><input type="text" id="pGoalId" class="input" placeholder="G1, G2…" /></th>
            <th></th>
            <th></th>
            <th><select id="pStatus" class="input"></select></th>
            <th><button id="pReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Notifications -->
  <section id="notifications" role="tabpanel">
    <div class="card">
      <h2>Notifications</h2>
      <table id="tblNotifications">
        <thead>
          <tr class="labels">
            <th style="width:70px">ID</th>
            <th>Description</th>
            <th style="width:140px">Subject</th>
            <th style="width:140px">Status</th>
            <th style="width:180px">Role</th>
            <th style="width:140px">Date</th>
            <th>Comments</th>
            <th style="width:90px">Stars</th>
            <th style="width:140px">Actions</th>
          </tr>
          <tr class="filters">
            <th></th>
            <th><input type="text" id="nSearch" class="input" placeholder="search description/comments" /></th>
            <th><select id="nSubject" class="input"></select></th>
            <th><select id="nStatus" class="input"></select></th>
            <th><select id="nRole" class="input"></select></th>
            <th></th>
            <th></th>
            <th></th>
            <th><button id="nReset" class="btn">Reset</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <footer>© <span id="yr"></span> Dorcas / GRIPlog – role-based viewer/editor with notifications.</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, getDocs, setDoc, doc, serverTimestamp, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps",
      authDomain: "griplog.firebaseapp.com",
      projectId: "griplog",
      storageBucket: "griplog.appspot.com",
      messagingSenderId: "1097061844582",
      appId: "1:1097061844582:web:5fc1c25e320af9c9384fa7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
    $('#yr').textContent = new Date().getFullYear();

    // ---- Roles & helpers ----
    const EDIT_ROLES = new Set(['Admin','Projectmanager','Strategic Program Advisor','Thematic Expert']);
    function hasEditorRights(role, user){ return EDIT_ROLES.has(role) && !!(user?.email); }
    async function upsertUserDoc(uid, data){ const ref=doc(db,'users',uid); const snap=await getDoc(ref); await setDoc(ref, snap.exists()? {...snap.data(), ...data} : data, {merge:true}); }
    function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // ---- Owners & statuses ---- (owner bevat alle rollen + bestaande teams)
    const owners=[
      "", "Viewer (read-only)","Sponsor/ Partner","Account manager","Admin","Projectmanager",
      "Strategic Program Advisor","Thematic Expert","Strategic Partnership & Resource Advisor",
      "Program Knowledge Support","Engagement & Fundraising","Public Engagement","Finance Officer",
      "IT specialist","HR Officer","Corporate Positioning","Other",
      "Coop Board","Finance Lead","QA Manager","Operations Lead","Value Add Manager",
      "MRDP Field Coord.","Dorcas","PM","Procurement","FFS Coordinator"
    ];
    const statuses={ goals:["","Open","In progress","Closed"], risks:["","Open","In progress","Closed"], issues:["","Open","In progress","Blocked","Done"], plans:["","Open","In progress","Done"] };
    const tri=["","Low","Medium","High"];

    // ---- Notifications enums ----
    const notifSubjects = ["","New Goal","New Risk","New Issue","New Plan","New Suggestion","Goal","Risk","Issue","Plan","Suggestion"];
    const notifStatuses = ["","Added","Edited","Deleted","Reviewed","Approved","Dismissed","Considered"];
    const notifRoles    = ["","Admin","Strategic Program Advisor","Thematic Expert","Projectmanager"];

    // ---- State ----
    let CAN_EDIT=false, IS_ADMIN=false, CURRENT_ROLE='Viewer', CURRENT_UID='';
    let cache={goals:[],risks:[],issues:[],plans:[],notifications:[]};
    const editing={goals:new Set(),risks:new Set(),issues:new Set(),plans:new Set()};

    // ---- Auth UI ----
    const authDot=$('#authDot'), authTxt=$('#authTxt'), userInfo=$('#userInfo');
    function slugEmailFromName(name){ return name.trim().toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,40)+"@griplog.local"; }
    function firstNameOf(full){ return (full||'').trim().split(/\s+/)[0]||''; }

    $('#btnSignup').onclick=async ()=>{
      const fullName=$('#fullName').value.trim(); const email=($('#email').value||'').trim(); const org=$('#org').value.trim(); const role=$('#role').value; const pass=$('#password').value;
      if(!fullName||!org||!pass){ alert('fill required fields'); return; }
      if(EDIT_ROLES.has(role) && !email){ alert('email required for editors'); return; }
      const used=email||slugEmailFromName(fullName);
      try{
        const cred=await createUserWithEmailAndPassword(auth, used, pass);
        await updateProfile(cred.user,{displayName:fullName});
        await upsertUserDoc(cred.user.uid,{ fullName, firstName:firstNameOf(fullName), email: email||'', org, role, createdAt: serverTimestamp() });
        alert('registered. please login.');
        await signOut(auth);
      }catch(e){ alert(e.code==='auth/email-already-in-use' ? 'account exists. login.' : e.message); }
    };

    $('#btnSignin').onclick=async ()=>{
      const fullName=$('#fullName').value.trim(); const email=($('#email').value||'').trim(); const pass=$('#password').value; const rolePick=$('#role').value;
      if(!fullName||!pass){ alert('fill required fields'); return; }
      if(EDIT_ROLES.has(rolePick) && !email){ alert('email required for editors'); return; }
      const used=email||slugEmailFromName(fullName);
      try{
        const cred=await signInWithEmailAndPassword(auth, used, pass);
        if(EDIT_ROLES.has(rolePick) && email){ await upsertUserDoc(cred.user.uid,{ role: rolePick, email, fullName }); }
      }catch(e){ alert('login failed: '+e.message); }
    };

    $('#btnSignout').onclick=()=>signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ authDot.classList.remove('ok'); authTxt.textContent='not signed in'; userInfo.textContent=''; CAN_EDIT=false; IS_ADMIN=false; CURRENT_ROLE='Viewer'; CURRENT_UID=''; toggleEditorUI(); return; }
      authDot.classList.add('ok');
      CURRENT_UID = user.uid;
      const snap=await getDoc(doc(db,'users',user.uid));
      const profile=snap.exists()? snap.data() : { fullName: user.displayName||user.email, role:'Viewer', email: user.email||'' };
      const role= EDIT_ROLES.has(profile.role) && !user.email ? 'Viewer' : (profile.role||'Viewer');
      CURRENT_ROLE = role;
      CAN_EDIT = hasEditorRights(role, user);
      IS_ADMIN = (role === 'Admin');
      authTxt.textContent = CAN_EDIT? 'editor' : 'viewer';
      userInfo.textContent = `${(profile.fullName||'').toLowerCase()} – ${role.toLowerCase()}`;
      toggleEditorUI();
      await loadAll();
    });

    function toggleEditorUI(){
      $('#btnSaveAll').disabled = !CAN_EDIT;
      $('#btnAddRow').style.display = CAN_EDIT ? 'inline-block' : 'none';
    }

    // ---- Tabs ----
    $$('.tabs button').forEach(btn=>btn.addEventListener('click',()=>{
      $$('.tabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      const tab=btn.dataset.tab; $$('section').forEach(s=>s.classList.remove('active')); $('#'+tab).classList.add('active');
    }));

    // ---- Filters ----
    function fillSelect(sel, arr, ph){ const el=$(sel); if(!el) return; el.innerHTML = arr.map((v,i)=>`<option value="${v}">${i===0? (ph||'Any') : v}</option>`).join(''); }
    function buildFilterOptions(){
      fillSelect('#gOwner', owners, 'Owner'); fillSelect('#gStatus', statuses.goals, 'Status');
      fillSelect('#rOwner', owners, 'Owner'); fillSelect('#rLikelihood', tri, 'Likelihood'); fillSelect('#rImpact', tri, 'Impact'); fillSelect('#rStatus', statuses.risks, 'Status');
      fillSelect('#iOwner', owners, 'Owner'); fillSelect('#iSeverity', tri, 'Severity'); fillSelect('#iStatus', statuses.issues, 'Status');
      fillSelect('#pOwner', owners, 'Owner'); fillSelect('#pStatus', statuses.plans, 'Status');

      // notifications
      fillSelect('#nSubject', notifSubjects, 'Subject');
      fillSelect('#nStatus', notifStatuses, 'Status');
      fillSelect('#nRole', notifRoles, 'Role');

      ['gOwner','gStatus','gStartFrom','gEndTo','gSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderGoals));
      ['rOwner','rLikelihood','rImpact','rStatus','rSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderRisks));
      ['iOwner','iSeverity','iStatus','iSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderIssues));
      ['pOwner','pStatus','pGoalId','pSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderPlans));
      ['nSubject','nStatus','nRole','nSearch'].forEach(id=> $('#'+id)?.addEventListener('input', renderNotifications));

      $('#gReset')?.addEventListener('click', ()=>{ ['gOwner','gStatus','gStartFrom','gEndTo','gSearch'].forEach(i=>$('#'+i).value=''); renderGoals(); });
      $('#rReset')?.addEventListener('click', ()=>{ ['rOwner','rLikelihood','rImpact','rStatus','rSearch'].forEach(i=>$('#'+i).value=''); renderRisks(); });
      $('#iReset')?.addEventListener('click', ()=>{ ['iOwner','iSeverity','iStatus','iSearch'].forEach(i=>$('#'+i).value=''); renderIssues(); });
      $('#pReset')?.addEventListener('click', ()=>{ ['pOwner','pStatus','pGoalId','pSearch'].forEach(i=>$('#'+i).value=''); renderPlans(); });
      $('#nReset')?.addEventListener('click', ()=>{ ['nSubject','nStatus','nRole','nSearch'].forEach(i=>$('#'+i).value=''); renderNotifications(); });
    }

    // ---- I/O ----
    async function loadAll(){
      const [g,r,i,p,n] = await Promise.all([
        getDocs(collection(db,'goals')),
        getDocs(collection(db,'risks')),
        getDocs(collection(db,'issues')),
        getDocs(collection(db,'plans')),
        getDocs(collection(db,'notifications')),
      ]);
      cache.goals = g.docs.map(d=>({id:d.id,...d.data()}));
      cache.risks = r.docs.map(d=>({id:d.id,...d.data()}));
      cache.issues= i.docs.map(d=>({id:d.id,...d.data()}));
      cache.plans = p.docs.map(d=>({id:d.id,...d.data()}));
      cache.notifications = n.docs.map(d=>({id:d.id,...d.data()}));
      cache.goals.sort((a,b)=>num(a.id)-num(b.id));
      cache.risks.sort((a,b)=>num(a.id)-num(b.id));
      cache.issues.sort((a,b)=>num(a.id)-num(b.id));
      cache.plans.sort((a,b)=>num(a.id)-num(b.id));
      cache.notifications.sort((a,b)=>num(b.id)-num(a.id)); // newest first
      buildFilterOptions();
      renderAll();
    }

    async function saveAll(){
      if(!CAN_EDIT){ alert('no edit rights'); return; }
      const tasks=[];
      const prev={ goals:new Map(cache.goals.map(x=>[x.id,x])), risks:new Map(cache.risks.map(x=>[x.id,x])), issues:new Map(cache.issues.map(x=>[x.id,x])), plans:new Map(cache.plans.map(x=>[x.id,x])) };
      const nowG = rowsFromTable('goals');
      const nowR = rowsFromTable('risks');
      const nowI = rowsFromTable('issues');
      const nowP = rowsFromTable('plans');

      for(const r of nowG){ const existed=prev.goals.has(r.id); tasks.push(setDoc(doc(db,'goals',r.id), r)); tasks.push(createNotificationDoc(existed?'Goal':'New Goal', existed?'Edited':'Added', `${existed?'Edited':'Created'} ${r.id}`, r.id)); }
      for(const r of nowR){ const existed=prev.risks.has(r.id); tasks.push(setDoc(doc(db,'risks',r.id), r)); tasks.push(createNotificationDoc(existed?'Risk':'New Risk', existed?'Edited':'Added', `${existed?'Edited':'Created'} ${r.id}`, r.id)); }
      for(const r of nowI){ const existed=prev.issues.has(r.id); tasks.push(setDoc(doc(db,'issues',r.id), r)); tasks.push(createNotificationDoc(existed?'Issue':'New Issue', existed?'Edited':'Added', `${existed?'Edited':'Created'} ${r.id}`, r.id)); }
      for(const r of nowP){ const existed=prev.plans.has(r.id); tasks.push(setDoc(doc(db,'plans',r.id), r)); tasks.push(createNotificationDoc(existed?'Plan':'New Plan', existed?'Edited':'Added', `${existed?'Edited':'Created'} ${r.id}`, r.id)); }

      await Promise.all(tasks);
      alert('saved to firestore');
      await loadAll();
    }

    $('#btnLoad').onclick = loadAll;
    $('#btnSaveAll').onclick = saveAll;

    // ---- Notification helpers ----
    function num(id){ const n=parseInt(String(id).replace(/\D+/g,'')||'0',10); return isNaN(n)?0:n; }
    function notifNextId(){ let m=0; cache.notifications.forEach(n=>{const k=num(n.id); if(k>m) m=k;}); return 'N'+(m+1); }
    function nowISO(){ return new Date().toISOString().slice(0,10); }
    function kindLabel(k){ return ({goals:'Goal',risks:'Risk',issues:'Issue',plans:'Plan'})[k] || 'Item'; }

    function createNotificationDoc(subject,status,description, refId, comments=''){
      const id=notifNextId();
      const n={ id, description, subject, status, role: CURRENT_ROLE, date: nowISO(), comments, stars: 0, starredBy: {} };
      return setDoc(doc(db,'notifications', id), n);
    }

    async function starNotification(id){
      const ref=doc(db,'notifications', id);
      const snap=await getDoc(ref);
      if(!snap.exists()) throw new Error('notification not found');
      const n=snap.data();
      if(n.starredBy && n.starredBy[CURRENT_UID]) return; // 1 per user
      await setDoc(ref, { stars: Number(n.stars||0)+1, starredBy: { ...(n.starredBy||{}), [CURRENT_UID]: true } }, {merge:true});
    }

    // ---- Table extract & cells ----
    function rowsFromTable(kind){
      const t = {goals:'#tblGoals', risks:'#tblRisks', issues:'#tblIssues', plans:'#tblPlans'}[kind];
      return Array.from(document.querySelectorAll(`${t} tbody tr`)).map(tr=>{
        const td=(i)=>tr.children[i];
        if(kind==='goals') return { id: td(0).innerText.trim(), goal: getCellText(td(1)), owner: td(2).querySelector('select').value, start: td(3).querySelector('input').value, end: td(4).querySelector('input').value, status: td(5).querySelector('select').value, notes: getCellText(td(6)) };
        if(kind==='risks') return { id: td(0).innerText.trim(), description: getCellText(td(1)), owner: td(2).querySelector('select').value, likelihood: td(3).querySelector('select').value, impact: td(4).querySelector('select').value, status: td(5).querySelector('select').value, mitigation: getCellText(td(6)) };
        if(kind==='issues') return { id: td(0).innerText.trim(), description: getCellText(td(1)), owner: td(2).querySelector('select').value, severity: td(3).querySelector('select').value, status: td(4).querySelector('select').value, resolution: getCellText(td(5)) };
        if(kind==='plans') return { id: td(0).innerText.trim(), description: getCellText(td(1)), owner: td(2).querySelector('select').value, goalId: td(3).querySelector('input').value.trim(), start: td(4).querySelector('input').value, end: td(5).querySelector('input').value, status: td(6).querySelector('select').value };
      }).filter(x=>x && x.id);
    }
    function getCellText(td){ const el=td.querySelector('textarea,div'); return (el?.value ?? el?.innerText ?? '').trim(); }
    function textCell(text, editable){ return editable ? `<textarea>${escapeHtml(text||'')}</textarea>` : `<div>${escapeHtml(text||'')}</div>`; }
    function ownerCell(val, editable){ return `<select ${editable?'' : 'disabled'}>${owners.map(o=>`<option ${o===val?'selected':''}>${o}</option>`).join('')}</select>`; }
    function statusCell(kind, val, editable){ const opts=statuses[kind]; return `<select ${editable?'' : 'disabled'}>${opts.map(o=>`<option ${o===val?'selected':''}>${o}</option>`).join('')}</select>`; }
    function triCell(val, editable){ return `<select ${editable?'' : 'disabled'}>${tri.map(o=>`<option ${o===val?'selected':''}>${o}</option>`).join('')}</select>`; }
    function dateCell(val, editable){ return `<input type="date" value="${val||''}" ${editable?'' : 'disabled'} />`; }

    // ---- Renderers ----
    function renderAll(){ renderGoals(); renderRisks(); renderIssues(); renderPlans(); renderNotifications(); }

    function renderGoals(){
      const tbody=$('#tblGoals tbody'); tbody.innerHTML='';
      let rows=[...cache.goals];
      const fOwner=$('#gOwner').value; if(fOwner) rows=rows.filter(r=> (r.owner||'')===fOwner);
      const fStatus=$('#gStatus').value; if(fStatus) rows=rows.filter(r=> (r.status||'')===fStatus);
      const fStart=$('#gStartFrom').value; if(fStart) rows=rows.filter(r=> (r.start||'')>=fStart);
      const fEnd=$('#gEndTo').value; if(fEnd) rows=rows.filter(r=> (r.end||'')<=fEnd);
      const q=$('#gSearch').value?.toLowerCase()||''; if(q) rows=rows.filter(r=> ((r.goal||'')+' '+(r.notes||'')).toLowerCase().includes(q));
      rows.sort((a,b)=>num(a.id)-num(b.id));
      rows.forEach(r=>{
        const edit=editing.goals.has(r.id);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHtml(r.id)}</td>
          <td>${textCell(r.goal, edit)}</td>
          <td>${ownerCell(r.owner, edit)}</td>
          <td>${dateCell(r.start, edit)}</td>
          <td>${dateCell(r.end, edit)}</td>
          <td>${statusCell('goals', r.status, edit)}</td>
          <td>${textCell(r.notes, edit)}</td>
          <td>${rowActions('goals', r.id)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderRisks(){
      const tbody=$('#tblRisks tbody'); tbody.innerHTML='';
      let rows=[...cache.risks];
      const fOwner=$('#rOwner').value; if(fOwner) rows=rows.filter(r=> (r.owner||'')===fOwner);
      const fL=$('#rLikelihood').value; if(fL) rows=rows.filter(r=> (r.likelihood||'')===fL);
      const fI=$('#rImpact').value; if(fI) rows=rows.filter(r=> (r.impact||'')===fI);
      const fS=$('#rStatus').value; if(fS) rows=rows.filter(r=> (r.status||'')===fS);
      const q=$('#rSearch').value?.toLowerCase()||''; if(q) rows=rows.filter(r=> ((r.description||'')+' '+(r.mitigation||'')).toLowerCase().includes(q));
      rows.sort((a,b)=>num(a.id)-num(b.id));
      rows.forEach(r=>{
        const edit=editing.risks.has(r.id);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHtml(r.id)}</td>
          <td>${textCell(r.description, edit)}</td>
          <td>${ownerCell(r.owner, edit)}</td>
          <td>${triCell(r.likelihood, edit)}</td>
          <td>${triCell(r.impact, edit)}</td>
          <td>${statusCell('risks', r.status, edit)}</td>
          <td>${textCell(r.mitigation, edit)}</td>
          <td>${rowActions('risks', r.id)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderIssues(){
      const tbody=$('#tblIssues tbody'); tbody.innerHTML='';
      let rows=[...cache.issues];
      const fOwner=$('#iOwner').value; if(fOwner) rows=rows.filter(r=> (r.owner||'')===fOwner);
      const fV=$('#iSeverity').value; if(fV) rows=rows.filter(r=> (r.severity||'')===fV);
      const fS=$('#iStatus').value; if(fS) rows=rows.filter(r=> (r.status||'')===fS);
      const q=$('#iSearch').value?.toLowerCase()||''; if(q) rows=rows.filter(r=> ((r.description||'')+' '+(r.resolution||'')).toLowerCase().includes(q));
      rows.sort((a,b)=>num(a.id)-num(b.id));
      rows.forEach(r=>{
        const edit=editing.issues.has(r.id);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHtml(r.id)}</td>
          <td>${textCell(r.description, edit)}</td>
          <td>${ownerCell(r.owner, edit)}</td>
          <td>${triCell(r.severity, edit)}</td>
          <td>${statusCell('issues', r.status, edit)}</td>
          <td>${textCell(r.resolution, edit)}</td>
          <td>${rowActions('issues', r.id)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderPlans(){
      const tbody=$('#tblPlans tbody'); tbody.innerHTML='';
      let rows=[...cache.plans];
      const fOwner=$('#pOwner').value; if(fOwner) rows=rows.filter(r=> (r.owner||'')===fOwner);
      const fS=$('#pStatus').value; if(fS) rows=rows.filter(r=> (r.status||'')===fS);
      const fG=$('#pGoalId').value.trim().toLowerCase(); if(fG) rows=rows.filter(r=> (r.goalId||'').toLowerCase().includes(fG));
      const q=$('#pSearch').value?.toLowerCase()||''; if(q) rows=rows.filter(r=> ((r.description||'')).toLowerCase().includes(q));
      rows.sort((a,b)=>num(a.id)-num(b.id));
      rows.forEach(r=>{
        const edit=editing.plans.has(r.id);
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHtml(r.id)}</td>
          <td>${textCell(r.description, edit)}</td>
          <td>${ownerCell(r.owner, edit)}</td>
          <td><input type="text" value="${escapeHtml(r.goalId||'')}" ${edit?'' : 'disabled'} /></td>
          <td>${dateCell(r.start, edit)}</td>
          <td>${dateCell(r.end, edit)}</td>
          <td>${statusCell('plans', r.status, edit)}</td>
          <td>${rowActions('plans', r.id)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderNotifications(){
      const tbody=$('#tblNotifications tbody'); tbody.innerHTML='';
      let rows=[...cache.notifications];
      const s=$('#nSubject')?.value||''; if(s) rows=rows.filter(r=> (r.subject||'')===s);
      const st=$('#nStatus')?.value||''; if(st) rows=rows.filter(r=> (r.status||'')===st);
      const rl=$('#nRole')?.value||''; if(rl) rows=rows.filter(r=> (r.role||'')===rl);
      const q=$('#nSearch')?.value?.toLowerCase()||''; if(q) rows=rows.filter(r=> ((r.description||'')+' '+(r.comments||'')).toLowerCase().includes(q));
      rows.sort((a,b)=>num(b.id)-num(a.id));
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        const starCount = Number(r.stars||0);
        tr.innerHTML=`
          <td>${escapeHtml(r.id)}</td>
          <td>${escapeHtml(r.description||'')}</td>
          <td>${escapeHtml(r.subject||'')}</td>
          <td>${escapeHtml(r.status||'')}</td>
          <td>${escapeHtml(r.role||'')}</td>
          <td>${escapeHtml(r.date||'')}</td>
          <td>${escapeHtml(r.comments||'')}</td>
          <td><strong>${starCount}</strong></td>
          <td>${notifActionsCell(r.id)}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ---- Actions (Edit/Del/Star/Del Notification) ----
    document.addEventListener('click', async (e)=>{
      const editBtn = e.target.closest('button[data-edit]');
      const delBtn  = e.target.closest('button[data-del]');
      const starBtn = e.target.closest('button[data-star]');
      const delNotifBtn = e.target.closest('button[data-del-notif]');

      if(editBtn){
        if(!CAN_EDIT){ alert('no edit rights'); return; }
        const kind=editBtn.dataset.kind; const id=editBtn.dataset.id;
        if(editing[kind].has(id)){ editing[kind].delete(id); await createNotificationDoc(kindLabel(kind),'Edited',`Edited ${id}`, id); }
        else { editing[kind].add(id); }
        renderAll();
        return;
      }

      if(delBtn){
        if(!CAN_EDIT){ alert('no edit rights'); return; }
        const kind=delBtn.dataset.kind; const id=delBtn.dataset.id;
        if(!confirm(`Delete ${id} from ${kind}?`)) return;
        try{
          await deleteDoc(doc(db, kind, id));
          cache[kind]=cache[kind].filter(x=>x.id!==id);
          await createNotificationDoc(kindLabel(kind),'Deleted',`Deleted ${id}`, id);
          renderAll();
        } catch(err){ alert('delete failed: '+err.message); }
        return;
      }

      if(starBtn){
        const id=starBtn.dataset.id;
        try{ await starNotification(id); await loadAll(); }catch(err){ alert('star failed: '+err.message); }
        return;
      }

      if(delNotifBtn){
        if(!IS_ADMIN){ alert('only admin can delete notifications'); return; }
        const id=delNotifBtn.dataset.id; if(!confirm(`Delete notification ${id}?`)) return;
        try{ await deleteDoc(doc(db,'notifications', id)); await loadAll(); }catch(err){ alert('delete failed: '+err.message); }
        return;
      }
    });

    function notifActionsCell(id){
      const delBtn = IS_ADMIN ? `<button class="btn danger" data-del-notif data-id="${id}">Del</button>` : '';
      return `<div class="row-actions">
        <button class="btn" data-star data-id="${id}">★ Star</button>
        ${delBtn}
      </div>`;
    }

    // ---- Build filters & initial render ----
    buildFilterOptions();
    function renderAll(){ renderGoals(); renderRisks(); renderIssues(); renderPlans(); renderNotifications(); }
    renderAll();
  </script>
</body>
</html>
