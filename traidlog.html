<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRAIDlog – Honey Value Chain</title>
  <link rel="icon" href="assets/dorcas-logo.svg" />
  <style>
    :root{ --bg:#f6f7fb;--card:#ffffff;--ink:#111827;--muted:#6b7280;--line:#e5e7eb; --brand:#0ea5a3;--danger:#ef4444;--ok:#10b981; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--line)}
    header img{height:34px;width:auto}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:10px 16px;background:#f0f5f5;border-bottom:1px solid var(--line)}
    .btn{border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:14px}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .input{border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff;font-size:14px}
    table{width:100%;border-collapse:collapse;margin:16px 0}
    th, td{border:1px solid var(--line);padding:6px 8px;vertical-align:top;font-size:14px;background:#fff}
    th{background:#f9fbfb;text-align:left}
    .row-actions button{margin-right:4px}
  </style>
</head>
<body>
  <header>
    <img src="assets/dorcas-logo.svg" alt="Dorcas">
    <div>
      <div class="title">TRAIDlog – Honey Value Chain (Kitui)</div>
      <div class="sub">Targets • Risks • Actions • Issues • Decisions</div>
    </div>
  </header>

  <div class="toolbar">
    <input id="fullName" class="input" placeholder="Full name *" />
    <input id="email" class="input" type="email" placeholder="Email (required for editors)" />
    <input id="org" class="input" placeholder="Organization *" />
    <select id="role" class="input">
      <option value="Viewer" selected>Viewer (read-only)</option>
      <option>Account manager</option>
      <option>Projectmanager</option>
      <option>Strategic Program Advisor</option>
      <option>Thematic Expert</option>
      <option>Strategic Partnership & Resource Advisor</option>
      <option>Program Knowledge Support</option>
      <option>Engagement & Fundraising</option>
      <option>Public Engagement</option>
      <option>Finance Officer</option>
      <option>IT specialist</option>
      <option>HR Officer</option>
      <option>Corporate Positioning</option>
      <option>Other</option>
    </select>
    <input id="password" class="input" type="password" placeholder="Password *" />
    <button id="signupBtn" class="btn">Register</button>
    <button id="signinBtn" class="btn primary">Login</button>
    <button id="signoutBtn" class="btn" style="display:none">Logout</button>
    <span id="authTxt">Not signed in</span>
    <span id="userInfo"></span>
  </div>

  <main style="padding:16px">
    <h2>Targets</h2>
    <table id="tblTargets"><thead><tr><th>ID</th><th>Description</th><th>Owner</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>

    <h2>Risks</h2>
    <table id="tblRisks"><thead><tr><th>ID</th><th>Description</th><th>Likelihood</th><th>Impact</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>

    <h2>Actions</h2>
    <table id="tblActions"><thead><tr><th>ID</th><th>Description</th><th>Owner</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>

    <h2>Issues</h2>
    <table id="tblIssues"><thead><tr><th>ID</th><th>Description</th><th>Severity</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>

    <h2>Decisions</h2>
    <table id="tblDecisions"><thead><tr><th>ID</th><th>Decision</th><th>Owner</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, setDoc, doc, serverTimestamp, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps", authDomain: "griplog.firebaseapp.com", projectId: "griplog" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const editableRoles = new Set(['Account manager','Projectmanager','Strategic Program Advisor','Thematic Expert','Strategic Partnership & Resource Advisor','Program Knowledge Support','Engagement & Fundraising','Public Engagement','Finance Officer','IT specialist','HR Officer','Corporate Positioning']);

    function slugEmailFromName(name){ return name.trim().toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,40) + '@traidlog.local'; }

    document.getElementById('signupBtn').onclick = async ()=>{
      const fullName=document.getElementById('fullName').value.trim();
      const email=(document.getElementById('email').value||'').trim();
      const org=document.getElementById('org').value.trim();
      const role=document.getElementById('role').value;
      const pass=document.getElementById('password').value;
      if(!fullName||!org||!pass){ alert('Fill required fields'); return; }
      if(editableRoles.has(role)&&!email){ alert('Editors must supply email'); return; }
      const usedEmail=email||slugEmailFromName(fullName);
      try{
        const cred=await createUserWithEmailAndPassword(auth,usedEmail,pass);
        await setDoc(doc(db,'users',cred.user.uid),{fullName,org,role,email,createdAt:serverTimestamp()});
        alert('Registered');
      }catch(e){
        if(e.code==='auth/email-already-in-use') alert('This account already exists. Please login.'); else alert(e.message);
      }
    };

    document.getElementById('signinBtn').onclick = async ()=>{
      const fullName=document.getElementById('fullName').value.trim();
      const email=(document.getElementById('email').value||'').trim();
      const role=document.getElementById('role').value;
      const pass=document.getElementById('password').value;
      if(!fullName||!pass){ alert('Fill required fields'); return; }
      if(editableRoles.has(role)&&!email){ alert('Editors must supply email'); return; }
      const usedEmail=email||slugEmailFromName(fullName);
      try{ await signInWithEmailAndPassword(auth,usedEmail,pass); }catch(e){ alert('Login failed: '+e.message); }
    };

    document.getElementById('signoutBtn').onclick = ()=>signOut(auth);

    let CAN_EDIT=false;

    onAuthStateChanged(auth,async(user)=>{
      if(user){
        document.getElementById('authTxt').textContent='Signed in';
        const snap=await getDoc(doc(db,'users',user.uid));
        if(snap.exists()){
          const p=snap.data();
          document.getElementById('userInfo').textContent=`${p.fullName} – ${p.role}`;
          CAN_EDIT=editableRoles.has(p.role);
        } else {
          document.getElementById('userInfo').textContent=user.email;
          CAN_EDIT=false;
        }
        document.getElementById('signoutBtn').style.display='inline-block';
        loadTables();
      } else {
        document.getElementById('authTxt').textContent='Not signed in';
        document.getElementById('userInfo').textContent='';
        document.getElementById('signoutBtn').style.display='none';
      }
    });

    async function loadTables(){
      await loadTable('targets','tblTargets',['id','description','owner','status']);
      await loadTable('risks','tblRisks',['id','description','likelihood','impact','status']);
      await loadTable('actions','tblActions',['id','description','owner','status']);
      await loadTable('issues','tblIssues',['id','description','severity','status']);
      await loadTable('decisions','tblDecisions',['id','decision','owner','status']);
    }

    async function loadTable(coll, tableId, fields){
      const snap=await getDocs(collection(db,coll));
      const tbody=document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML='';
      snap.forEach(docSnap=>{
        const data=docSnap.data();
        const tr=document.createElement('tr');
        fields.forEach(f=>{
          const td=document.createElement('td');
          td.textContent=data[f]||'';
          tr.appendChild(td);
        });
        const tdAct=document.createElement('td');
        if(CAN_EDIT){
          const btnE=document.createElement('button');btnE.textContent='Edit';
          const btnD=document.createElement('button');btnD.textContent='Del';
          tdAct.appendChild(btnE);tdAct.appendChild(btnD);
        } else tdAct.textContent='—';
        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
