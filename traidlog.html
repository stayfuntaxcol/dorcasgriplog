<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRAID → GRIP Importer + Editor (Kitui Honey Value Chain)</title>
  <style>
    :root{ --bg:#f7faf9;--card:#fff;--ink:#1f2937;--muted:#6b7280;--brand:#0ea5a3;--accent:#0b8d8b;--line:#e5e7eb;--warn:#ef4444;--ok:#10b981; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{padding:16px 18px;border-bottom:1px solid var(--line);background:var(--card)}
    h1{margin:0 0 4px 0;font-size:20px}
    p{margin:6px 0}
    .wrap{max-width:1100px;margin:16px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:#bbb}
    .ok{background:var(--ok)} .warn{background:var(--warn)}
    .input, input, select, textarea{border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:14px;background:#fff}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid var(--line);padding:6px 8px;font-size:13px;vertical-align:top}
    th{background:#f4faf9;text-align:left}
    code.small{font-size:12px;background:#f3f4f6;padding:2px 4px;border-radius:6px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .kpi{border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff}
    .kpi .lab{font-size:12px;color:var(--muted)}
    .kpi .val{font-weight:800;font-size:20px}
    @media (max-width:820px){.kpis{grid-template-columns:repeat(2,1fr)}}
    footer{padding:16px;color:var(--muted);font-size:12px;text-align:center}
    .note{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<header class="wrap">
  <h1>TRAID → GRIP Importer + Editor</h1>
  <p>Log in met rol. Upload je (T)RAID-bestand naar GRIP (Firestore) en beheer data (CRUD).</p>
</header>

<main class="wrap">
  <!-- AUTH -->
  <div class="card">
    <h3 style="margin:0 0 8px 0">Inloggen / Registreren</h3>
    <div class="row">
      <input id="fullName" class="input" placeholder="Volledige naam *" />
      <input id="email" class="input" type="email" placeholder="Email (verplicht voor editors)" />
      <input id="org" class="input" placeholder="Organisatie *" />
      <select id="role" class="input">
        <option value="Viewer" selected>Viewer (read-only)</option>
        <option>Sponsor/ Partner</option>
        <option>Account manager</option>
        <option>Projectmanager</option>
        <option>Strategic Program Advisor</option>
        <option>Thematic Expert</option>
        <option>Strategic Partnership & Resource Advisor</option>
        <option>Program Knowledge Support</option>
        <option>Engagement & Fundraising</option>
        <option>Public Engagement</option>
        <option>Finance Officer</option>
        <option>IT specialist</option>
        <option>HR Officer</option>
        <option>Corporate Positioning</option>
        <option>Other</option>
      </select>
      <input id="password" class="input" type="password" placeholder="Wachtwoord *" />
      <button id="btnSignup" class="btn">Register</button>
      <button id="btnSignin" class="btn primary">Login</button>
      <button id="btnSignout" class="btn" style="display:none">Logout</button>
      <span class="pill"><span id="authDot" class="dot"></span><span id="authTxt">Niet aangemeld</span></span>
      <span id="who" class="pill"></span>
    </div>
    <p class="note">Editor-rollen kunnen **uploaden** en **CRUD**. Viewers alleen lezen.</p>
  </div>

  <!-- IMPORTER -->
  <div class="card">
    <h3 style="margin:0 0 8px 0">Importeer (T)RAID → GRIP</h3>
    <div class="row">
      <input id="filePick" type="file" accept=".html,.json" hidden />
      <button id="btnPick" class="btn">Kies TRAID bestand</button>
      <button id="btnUpload" class="btn primary" disabled>Upload naar Firestore</button>
      <span class="pill">Upload-toegang: <strong id="perm">Viewer</strong></span>
    </div>
    <p class="note">Beslissingen (D) worden niet geüpload. Project: <code class="small">griplog</code></p>

    <div class="kpis" style="margin-top:8px">
      <div class="kpi"><div class="lab">Goals (Targets)</div><div id="nGoals" class="val">0</div></div>
      <div class="kpi"><div class="lab">Risks</div><div id="nRisks" class="val">0</div></div>
      <div class="kpi"><div class="lab">Issues</div><div id="nIssues" class="val">0</div></div>
      <div class="kpi"><div class="lab">Plans (Actions)</div><div id="nPlans" class="val">0</div></div>
    </div>

    <table id="prevTbl" style="display:none">
      <thead><tr>
        <th>Type</th><th>ID</th><th>Omschrijving</th><th>Owner</th><th>Extra</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- SIMPLE CRUD -->
  <div class="card">
    <h3 style="margin:0 0 8px 0">Beheer data (CRUD)</h3>
    <div class="row">
      <select id="crudColl" class="input">
        <option value="goals">goals</option>
        <option value="risks">risks</option>
        <option value="issues">issues</option>
        <option value="plans">plans</option>
      </select>
      <input id="crudId" class="input" placeholder="Document ID (bijv. G1/R1/I1/P1)" />
      <button id="btnCreate" class="btn" disabled>Create</button>
      <button id="btnUpdate" class="btn" disabled>Update</button>
      <button id="btnDelete" class="btn" disabled>Delete</button>
      <span class="pill">Rechten: <strong id="crudPerm">Viewer</strong></span>
    </div>
    <p class="note">Plak hier geldige JSON voor het document:</p>
    <textarea id="crudJson" rows="10" style="width:100%" placeholder='{"id":"G1","goal":"...","owner":"...","start":"YYYY-MM-DD","end":"YYYY-MM-DD","status":"Open","notes":"..."}'></textarea>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">Firebase configuratie</h3>
    <ul style="margin:6px 0 0 18px">
      <li>Project: <code class="small">griplog</code></li>
      <li>API Key: <code class="small">AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps</code></li>
      <li>App ID: <code class="small">1:1097061844582:web:5fc1c25e320af9c9384fa7</code></li>
    </ul>
  </div>
</main>

<footer>© <span id="yr"></span> Dorcas / GRIPlog Importer + Editor</footer>

<script type="module">
  // ---- Firebase (modular) ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps",
    authDomain: "griplog.firebaseapp.com",
    projectId: "griplog",
    storageBucket: "griplog.appspot.com",
    messagingSenderId: "1097061844582",
    appId: "1:1097061844582:web:5fc1c25e320af9c9384fa7"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (q,root=document)=>root.querySelector(q);
  $('#yr').textContent = new Date().getFullYear();

  // ---- Rollen met bewerkrechten ----
  const EDIT_ROLES = new Set([
    'Account manager','Projectmanager','Strategic Program Advisor','Thematic Expert',
    'Strategic Partnership & Resource Advisor','Program Knowledge Support',
    'Engagement & Fundraising','Public Engagement','Finance Officer','IT specialist',
    'HR Officer','Corporate Positioning'
  ]);

  function firstName(full){ return (full||'').trim().split(/\s+/)[0]||''; }
  function slugEmailFromName(name){ return name.trim().toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,40) + '@griplog.local'; }

  let CAN_EDIT = false; // client-flag

  // ---- Auth handlers ----
  $('#btnSignup').onclick = async ()=>{
    const fullName=$('#fullName').value.trim();
    const email=($('#email').value||'').trim();
    const org=$('#org').value.trim();
    const role=$('#role').value;
    const pass=$('#password').value;
    if(!fullName||!org||!pass){ alert('Vul verplichte velden in'); return; }
    if(EDIT_ROLES.has(role) && !email){ alert('Email is verplicht voor editor-rollen'); return; }
    const usedEmail = email || slugEmailFromName(fullName);
    try{
      const cred = await createUserWithEmailAndPassword(auth, usedEmail, pass);
      await updateProfile(cred.user, { displayName: fullName });
      await setDoc(doc(db,'users',cred.user.uid), { fullName, firstName:firstName(fullName), email, org, role, createdAt: (new Date()).toISOString() });
      alert('Geregistreerd. Je bent nu ingelogd.');
    }catch(e){ alert(e.code==='auth/email-already-in-use' ? 'Account bestaat al. Log in.' : e.message); }
  };

  $('#btnSignin').onclick = async ()=>{
    const fullName=$('#fullName').value.trim();
    const email=($('#email').value||'').trim();
    const role=$('#role').value;
    const pass=$('#password').value;
    if(!fullName||!pass){ alert('Vul verplichte velden in'); return; }
    if(EDIT_ROLES.has(role) && !email){ alert('Email is verplicht voor editor-rollen'); return; }
    const usedEmail = email || slugEmailFromName(fullName);
    try{ await signInWithEmailAndPassword(auth, usedEmail, pass); }
    catch(e){ alert('Login mislukt: '+e.message); }
  };

  $('#btnSignout').onclick = ()=> signOut(auth);

  onAuthStateChanged(auth, async (user)=>{
    const authDot = $('#authDot'), authTxt = $('#authTxt'), who=$('#who');
    if(!user){
      CAN_EDIT=false; authDot.classList.remove('ok'); authTxt.textContent='Niet aangemeld';
      $('#btnSignout').style.display='none';
      who.textContent='';
      setEditPermissions();
      return;
    }
    authDot.classList.add('ok'); authTxt.textContent='Aangemeld'; $('#btnSignout').style.display='inline-block';
    try {
      // lees profiel (role)
      const resp = await fetch(`https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/users/${user.uid}`);
      let role = 'Viewer', fullName = user.displayName || user.email || '';
      if(resp.ok){ const json = await resp.json();
        const fields = json.fields || {};
        role = fields.role?.stringValue || 'Viewer';
        fullName = fields.fullName?.stringValue || fullName;
      }
      CAN_EDIT = EDIT_ROLES.has(role);
      $('#perm').textContent = CAN_EDIT? 'Editor' : 'Viewer';
      $('#crudPerm').textContent = CAN_EDIT? 'Editor' : 'Viewer';
      who.textContent = `${fullName} – ${role}`;
      setEditPermissions();
    } catch(err){ console.warn('Kon rol niet laden', err); setEditPermissions(); }
  });

  function setEditPermissions(){
    $('#btnUpload').disabled = !CAN_EDIT || !window.__GRIP;
    $('#btnCreate').disabled = !CAN_EDIT;
    $('#btnUpdate').disabled = !CAN_EDIT;
    $('#btnDelete').disabled = !CAN_EDIT;
  }

  // ---------- IMPORTER ----------
  let parsed = { targets:[], risks:[], actions:[], issues:[], decisions:[] };
  $('#btnPick').onclick = ()=> $('#filePick').click();
  $('#filePick').onchange = async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const text = await f.text();
    try{
      if(f.name.toLowerCase().endsWith('.json')) parsed = JSON.parse(text); else parsed = parseTraidHtml(text);
      resequenceIds(parsed);
      const grip = mapToGrip(parsed);
      preview(grip);
      window.__GRIP = grip;
      setEditPermissions();
    }catch(err){ console.error(err); alert('Kon bestand niet parseren: '+ err.message); }
  };

  function parseTraidHtml(html){
    const docEl = new DOMParser().parseFromString(html, 'text/html');
    const readTable = (id, cols)=>{
      const rows = []; const tbody = docEl.querySelector('#'+id+' tbody'); if(!tbody) return rows;
      tbody.querySelectorAll('tr').forEach(tr=>{
        const obj = {}; cols.forEach((c,idx)=>{ const td = tr.children[idx]; if(!td){ obj[c]=''; return; }
          const sel = td.querySelector('select'); let v = sel? (sel.value||sel.selectedOptions?.[0]?.value||'') : (td.textContent||''); obj[c] = v.trim(); }); rows.push(obj);
      }); return rows;
    };
    return {
      targets:   readTable('targetsTable',  ["id","desc","owner","start","end","status","detail","added"]),
      risks:     readTable('risksTable',    ["id","desc","owner","chance","impact","status","mitigation","added"]),
      actions:   readTable('actionsTable',  ["id","desc","owner","target","start","end","status","added"]),
      issues:    readTable('issuesTable',   ["id","desc","owner","location","deadline","impact","status","added"]),
      decisions: readTable('decisionsTable',["id","desc","owner","why","date","impact","status","added"])
    };
  }
  function resequenceIds(data){ const maps = {targets:'T', risks:'R', actions:'A', issues:'I', decisions:'D'}; Object.keys(maps).forEach(k=>{ let c=1; (data[k]||[]).forEach(it=>{ it.id = maps[k]+(c++); }); }); }

  function mapToGrip(src){
    const goals = (src.targets||[]).map(t=>({ id:t.id.replace(/^T/,'G'), goal:t.desc||'', owner:t.owner||'', start:t.start||'', end:t.end||'', status:mapStatus(t.status), notes:t.detail||'' }));
    const risks = (src.risks||[]).map(r=>({ id:r.id, description:r.desc||'', owner:r.owner||'', likelihood:normalizeTri(r.chance), impact:normalizeTri(r.impact), status:mapStatus(r.status), mitigation:r.mitigation||'' }));
    const issues= (src.issues||[]).map(i=>({ id:i.id, description:i.desc||'', owner:i.owner||'', severity:normalizeTri(i.impact), status:mapStatusIssue(i.status), resolution:(i.location?('Locatie: '+i.location+'. '):'')+(i.deadline?('Deadline: '+i.deadline+'. '):'') }));
    const plans = (src.actions||[]).map(a=>({ id:a.id.replace(/^A/,'P'), description:a.desc||'', owner:a.owner||'', goalId:(a.target||'').replace(/^T/,'G'), start:a.start||'', end:a.end||'', status:mapStatusPlan(a.status) }));
    return {goals,risks,issues,plans};
  }
  function normalizeTri(v){ if(!v) return 'Middel'; const s=(v||'').toLowerCase(); if(s.startsWith('laag')) return 'Laag'; if(s.startsWith('hoog')) return 'Hoog'; return 'Middel'; }
  function mapStatus(v){ const s=(v||'').toLowerCase(); if(s.includes('progress')) return 'In progress'; if(s.includes('closed')||s.includes('done')) return 'Closed'; return 'Open'; }
  function mapStatusPlan(v){ const s=(v||'').toLowerCase(); if(s.includes('progress')) return 'In progress'; if(s.includes('closed')||s.includes('done')) return 'Done'; return 'Open'; }
  function mapStatusIssue(v){ const s=(v||'').toLowerCase(); if(s.includes('blocked')) return 'Blocked'; if(s.includes('progress')) return 'In progress'; if(s.includes('closed')||s.includes('done')) return 'Done'; return 'Open'; }

  function preview(grip){
    const n = (id,val)=> document.querySelector(id).textContent = String(val);
    n('#nGoals', grip.goals.length); n('#nRisks', grip.risks.length); n('#nIssues', grip.issues.length); n('#nPlans', grip.plans.length);
    const tbl = document.querySelector('#prevTbl'); tbl.style.display = ''; const tbody = tbl.querySelector('tbody'); tbody.innerHTML='';
    const add = (type,row,idKey,descKey,ownerKey,extra)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${type}</td><td>${row[idKey]||''}</td><td>${escapeHtml(row[descKey]||'')}</td><td>${escapeHtml(row[ownerKey]||'')}</td><td>${escapeHtml(extra||'')}</td>`; tbody.appendChild(tr); };
    grip.goals.forEach(g=>add('Goal', g, 'id','goal','owner', (g.start?g.start+' → ':'')+(g.end||'')));
    grip.risks.forEach(r=>add('Risk', r, 'id','description','owner', `Kans:${r.likelihood}, Impact:${r.impact}`));
    grip.issues.forEach(i=>add('Issue', i, 'id','description','owner', `Ernst:${i.severity}, Status:${i.status}`));
    grip.plans.forEach(p=>add('Plan', p, 'id','description','owner', `Goal:${p.goalId}, ${p.start}→${p.end}`));
  }
  function escapeHtml(s){return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

  // Upload (alleen editors)
  document.getElementById('btnUpload').onclick = async ()=>{
    if(!CAN_EDIT){ alert('Geen editor-rechten. Kies een editor-rol en log in.'); return; }
    const g = window.__GRIP; if(!g){ alert('Geen data geladen.'); return; }
    try{
      const tasks=[]; g.goals.forEach(row=>tasks.push(setDoc(doc(db,'goals',row.id),row))); g.risks.forEach(row=>tasks.push(setDoc(doc(db,'risks',row.id),row))); g.issues.forEach(row=>tasks.push(setDoc(doc(db,'issues',row.id),row))); g.plans.forEach(row=>tasks.push(setDoc(doc(db,'plans',row.id),row)));
      await Promise.all(tasks);
      alert('Upload voltooid: '+(g.goals.length+g.risks.length+g.issues.length+g.plans.length)+' records.');
    }catch(err){ alert('Upload fout: '+err.message+'\nControleer Firestore rules en je rol.'); }
  };

  // ---------- SIMPLE CRUD (alleen editors) ----------
  async function crudWrite(kind){
    if(!CAN_EDIT){ alert('Geen editor-rechten.'); return; }
    const coll = $('#crudColl').value; const id=$('#crudId').value.trim(); if(!id){ alert('Voer een ID in.'); return; }
    let data; try{ data = JSON.parse($('#crudJson').value||'{}'); }catch{ alert('JSON ongeldig.'); return; }
    if(kind==='delete'){
      // Soft-delete door lege setDoc (of vervang met echte delete via REST/extra import)
      data = { __deleted:true };
    }
    try{
      await setDoc(doc(db, coll, id), data, { merge: (kind==='update') });
      alert(kind==='delete' ? 'Gemarkeerd als verwijderd.' : 'Opgeslagen.');
    }catch(err){ alert('Schrijffout: '+err.message); }
  }
  document.getElementById('btnCreate').onclick = ()=> crudWrite('create');
  document.getElementById('btnUpdate').onclick = ()=> crudWrite('update');
  document.getElementById('btnDelete').onclick = ()=> crudWrite('delete');

</script>
</body>
</html>
