<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRIPlog – Honey Value Chain (Kitui, Kenya)</title>
  <link rel="icon" href="assets/dorcas-logo.svg" />
  <style>
    :root{ --bg:#f6f7fb;--card:#ffffff;--ink:#1f2937;--muted:#6b7280;--brand:#0ea5a3;--brand-ink:#064e4a;--line:#e5e7eb;--tab:#0b8d8b;--warn:#ef4444;--ok:#10b981;}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header{display:flex;align-items:center;gap:14px;padding:14px 18px;border-bottom:1px solid var(--line);background:var(--card);position:sticky;top:0;z-index:10}
    header img{height:34px;width:auto}
    header .title{font-weight:700;font-size:20px}
    header .sub{color:var(--muted);font-size:12px}
    /* Auth bar */
    #authbar{display:flex;flex-wrap:wrap;gap:8px;padding:10px 18px;border-bottom:1px solid var(--line);background:#f0f5f5}
    .input, select, input, textarea{border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:14px;background:#fff}
    .btn{appearance:none;border:1px solid var(--line);background:var(--card);padding:8px 12px;border-radius:8px;cursor:pointer;font-size:14px}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .loginNote{margin-left:auto;color:var(--muted);font-size:12px}
    #who{font-size:12px;color:var(--muted);display:flex;flex-direction:column;text-transform:lowercase}
    /* Tabs */
    nav.tabs{display:flex;gap:8px;padding:10px 18px;border-bottom:1px solid var(--line);background:var(--card)}
    nav.tabs button{border:none;background:#eaf6f6;color:#065a59;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    nav.tabs button.active{background:var(--tab);color:#fff}
    section{display:none;padding:16px 18px}
    section.active{display:block}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .card + .card{margin-top:16px}
    h2{margin:0 0 6px 0;font-size:18px}
    p.help{margin:0 0 10px 0;color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:collapse}
    th, td{border:1px solid var(--line);padding:6px 8px;vertical-align:top}
    th{background:#f9fbfb;text-align:left;font-size:13px}
    td{background:#fff}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .val{font-weight:800;font-size:20px}
    .row-actions{display:flex;gap:6px}
    .filters input, .filters select{width:100%}
    .filters .resetCell{display:flex;justify-content:flex-start}
    .filters .resetCell button{border:1px solid var(--line);border-radius:8px;padding:6px 10px;background:#fff}
  </style>
</head>
<body>
  <header>
    <img src="assets/dorcas-logo.svg" alt="Dorcas" onerror="this.style.display='none'"/>
    <div>
      <div class="title">GRIPlog – Honey Value Chain (Kitui)</div>
      <div class="sub">Get a GRIP: Goals • Risks • Issues • Plans</div>
    </div>
  </header>

  <div id="authbar">
    <input id="fullName" class="input" placeholder="Full name *" />
    <input id="email" class="input" type="email" placeholder="Email (required for editors)" />
    <input id="org" class="input" placeholder="Organization *" />
    <select id="role" class="input">
      <option value="Viewer" selected>Viewer (read-only)</option>
      <option>Sponsor/ Partner</option>
      <option>Account manager</option>
      <option>Admin</option>
      <option>Projectmanager</option>
      <option>Strategic Program Advisor</option>
      <option>Thematic Expert</option>
      <option>Strategic Partnership & Resource Advisor</option>
      <option>Program Knowledge Support</option>
      <option>Engagement & Fundraising</option>
      <option>Public Engagement</option>
      <option>Finance Officer</option>
      <option>IT specialist</option>
      <option>HR Officer</option>
      <option>Corporate Positioning</option>
      <option>Other</option>
    </select>
    <input id="password" class="input" type="password" placeholder="Password *" />
    <button id="btnSignup" class="btn">Register</button>
    <button id="btnSignin" class="btn primary">Login</button>
    <button id="btnSignout" class="btn" style="display:none">Logout</button>
    <div id="who"></div>
    <div class="loginNote">anonymous login is disabled</div>
  </div>

  <nav class="tabs" role="tablist">
    <button class="active" data-tab="goals" role="tab">G – Goals</button>
    <button data-tab="risks" role="tab">R – Risks</button>
    <button data-tab="issues" role="tab">I – Issues</button>
    <button data-tab="plans" role="tab">P – Plans</button>
  </nav>

  <!-- Goals -->
  <section id="goals" class="active" role="tabpanel">
    <div class="card">
      <h2>Goals (SMART)</h2>
      <p class="help">Specific, Measurable, Achievable, Relevant, Time-bound.</p>
      <div class="kpis" id="kpiGoals">
        <div class="kpi"><div class="label">Total goals</div><div class="val" id="kpiGoalsTotal">0</div></div>
        <div class="kpi"><div class="label">In progress</div><div class="val" id="kpiGoalsIn">0</div></div>
        <div class="kpi"><div class="label">Done</div><div class="val" id="kpiGoalsDone">0</div></div>
      </div>
      <div class="tableWrap">
        <table id="tblGoals">
          <thead>
            <tr>
              <th style="width:70px">ID</th>
              <th>Goal</th>
              <th style="width:160px">Owner</th>
              <th style="width:130px">Start</th>
              <th style="width:130px">End</th>
              <th style="width:140px">Status</th>
              <th>Notes</th>
              <th style="width:140px">Actions</th>
            </tr>
            <tr class="filters">
              <th><!-- id sort asc by default --></th>
              <th><input id="fGoalsDesc" placeholder="Search description" /></th>
              <th>
                <select id="fGoalsOwner"><option value="">All</option></select>
              </th>
              <th><input id="fGoalsStart" type="date"></th>
              <th><input id="fGoalsEnd" type="date"></th>
              <th>
                <select id="fGoalsStatus">
                  <option value="">All</option><option>Open</option><option>In progress</option><option>Done</option>
                </select>
              </th>
              <th></th>
              <th class="resetCell"><button id="resetGoals">Reset</button></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button class="btn" id="addGoal" style="margin-top:10px;display:none">+ New Goal</button>
    </div>
  </section>

  <!-- Risks -->
  <section id="risks" role="tabpanel">
    <div class="card">
      <h2>Risks</h2>
      <p class="help">Likelihood • Impact • Mitigation.</p>
      <div class="kpis" id="kpiRisks">
        <div class="kpi"><div class="label">Total risks</div><div class="val" id="kpiRisksTotal">0</div></div>
        <div class="kpi"><div class="label">High priority</div><div class="val" id="kpiRisksHigh">0</div></div>
        <div class="kpi"><div class="label">Open</div><div class="val" id="kpiRisksOpen">0</div></div>
      </div>
      <div class="tableWrap">
        <table id="tblRisks">
          <thead>
            <tr>
              <th style="width:70px">ID</th>
              <th>Description</th>
              <th style="width:160px">Owner</th>
              <th style="width:120px">Likelihood</th>
              <th style="width:120px">Impact</th>
              <th style="width:140px">Status</th>
              <th>Mitigation</th>
              <th style="width:140px">Actions</th>
            </tr>
            <tr class="filters">
              <th></th>
              <th><input id="fRisksDesc" placeholder="Search description" /></th>
              <th><select id="fRisksOwner"><option value="">All</option></select></th>
              <th>
                <select id="fRisksLik"><option value="">All</option><option>Low</option><option>Medium</option><option>High</option></select>
              </th>
              <th>
                <select id="fRisksImp"><option value="">All</option><option>Low</option><option>Medium</option><option>High</option></select>
              </th>
              <th>
                <select id="fRisksStatus"><option value="">All</option><option>Open</option><option>In progress</option><option>Done</option><option>Closed</option></select>
              </th>
              <th></th>
              <th class="resetCell"><button id="resetRisks">Reset</button></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button class="btn" id="addRisk" style="margin-top:10px;display:none">+ New Risk</button>
    </div>
  </section>

  <!-- Issues -->
  <section id="issues" role="tabpanel">
    <div class="card">
      <h2>Issues</h2>
      <p class="help">Open problems and resolution.</p>
      <div class="kpis" id="kpiIssues">
        <div class="kpi"><div class="label">Total issues</div><div class="val" id="kpiIssuesTotal">0</div></div>
        <div class="kpi"><div class="label">Blocked</div><div class="val" id="kpiIssuesBlocked">0</div></div>
        <div class="kpi"><div class="label">Done</div><div class="val" id="kpiIssuesDone">0</div></div>
      </div>
      <div class="tableWrap">
        <table id="tblIssues">
          <thead>
            <tr>
              <th style="width:70px">ID</th>
              <th>Description</th>
              <th style="width:160px">Owner</th>
              <th style="width:120px">Severity</th>
              <th style="width:140px">Status</th>
              <th>Resolution / Note</th>
              <th style="width:140px">Actions</th>
            </tr>
            <tr class="filters">
              <th></th>
              <th><input id="fIssuesDesc" placeholder="Search description" /></th>
              <th><select id="fIssuesOwner"><option value="">All</option></select></th>
              <th><select id="fIssuesSev"><option value="">All</option><option>Low</option><option>Medium</option><option>High</option></select></th>
              <th><select id="fIssuesStatus"><option value="">All</option><option>Open</option><option>In progress</option><option>Blocked</option><option>Done</option></select></th>
              <th></th>
              <th class="resetCell"><button id="resetIssues">Reset</button></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button class="btn" id="addIssue" style="margin-top:10px;display:none">+ New Issue</button>
    </div>
  </section>

  <!-- Plans -->
  <section id="plans" role="tabpanel">
    <div class="card">
      <h2>Plans</h2>
      <p class="help">Concrete steps to reach goals.</p>
      <div class="kpis" id="kpiPlans">
        <div class="kpi"><div class="label">Total plans</div><div class="val" id="kpiPlansTotal">0</div></div>
        <div class="kpi"><div class="label">In progress</div><div class="val" id="kpiPlansIn">0</div></div>
        <div class="kpi"><div class="label">Done</div><div class="val" id="kpiPlansDone">0</div></div>
      </div>
      <div class="tableWrap">
        <table id="tblPlans">
          <thead>
            <tr>
              <th style="width:70px">ID</th>
              <th>Description</th>
              <th style="width:160px">Owner</th>
              <th style="width:160px">Goal link</th>
              <th style="width:130px">Start</th>
              <th style="width:130px">End</th>
              <th style="width:140px">Status</th>
              <th style="width:140px">Actions</th>
            </tr>
            <tr class="filters">
              <th></th>
              <th><input id="fPlansDesc" placeholder="Search description" /></th>
              <th><select id="fPlansOwner"><option value="">All</option></select></th>
              <th><input id="fPlansGoal" placeholder="Goal ID" /></th>
              <th><input id="fPlansStart" type="date"></th>
              <th><input id="fPlansEnd" type="date"></th>
              <th><select id="fPlansStatus"><option value="">All</option><option>Open</option><option>In progress</option><option>Done</option></select></th>
              <th class="resetCell"><button id="resetPlans">Reset</button></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button class="btn" id="addPlan" style="margin-top:10px;display:none">+ New Plan</button>
    </div>
  </section>

  <div class="card" style="margin: 16px 18px">
    <h2>Data sync</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="loadBtn">Load from Firestore</button>
      <button class="btn primary" id="saveBtn">Save to Firestore</button>
      <button class="btn" id="exportBtn">Export JSON</button>
      <button class="btn" id="importBtn">Import JSON</button>
      <input type="file" id="fileInput" accept="application/json" hidden>
    </div>
  </div>

  <footer style="padding:14px 18px;color:var(--muted);font-size:12px">© <span id="yr"></span> Dorcas / GRIPlog</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps",
      authDomain: "griplog.firebaseapp.com",
      projectId: "griplog",
      storageBucket: "griplog.appspot.com",
      messagingSenderId: "1097061844582",
      appId: "1:1097061844582:web:5fc1c25e320af9c9384fa7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
    $('#yr').textContent = new Date().getFullYear();

    const EDIT_ROLES = new Set(['Admin','Projectmanager','Strategic Program Advisor','Thematic Expert']);
    const owners = ["Coop Board","Finance Lead","QA Manager","Operations Lead","Value Add Manager","MRDP Field Coord.","Dorcas","PM","Procurement","FFS Coordinator"]; 

    function ownerSelect(val=''){ return `<select>${owners.map(o=>`<option${o===val?' selected':''}>${o}</option>`).join('')}</select>`; }
    function statusSelect(kind, val='Open'){
      const m = { goals:['Open','In progress','Done'], risks:['Open','In progress','Done','Closed'], issues:['Open','In progress','Blocked','Done'], plans:['Open','In progress','Done'] };
      return `<select>${m[kind].map(s=>`<option${s===val?' selected':''}>${s}</option>`).join('')}</select>`;
    }
    const tri = ['Low','Medium','High'];
    function triSelect(val='Medium'){ return `<select>${tri.map(x=>`<option${x===val?' selected':''}>${x}</option>`).join('')}</select>`; }

    function slugEmailFromName(name){ return name.trim().toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,40) + '@griplog.local'; }
    function firstName(full){ return (full||'').trim().split(/\s+/)[0]||''; }

    let CAN_EDIT = false;

    // Tabs
    $$('.tabs button').forEach(btn=>btn.addEventListener('click',()=>{ $$('.tabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const tab=btn.dataset.tab; $$('section').forEach(s=>s.classList.remove('active')); $('#'+tab).classList.add('active'); }));

    // Auth
    $('#btnSignup').onclick = async ()=>{
      const fullName=$('#fullName').value.trim();
      const email=($('#email').value||'').trim();
      const org=$('#org').value.trim();
      const role=$('#role').value;
      const pass=$('#password').value;
      if(!fullName||!org||!pass){ alert('Fill required fields'); return; }
      if(EDIT_ROLES.has(role) && !email){ alert('Editors must provide an email'); return; }
      const usedEmail = email || slugEmailFromName(fullName);
      try{
        const cred = await createUserWithEmailAndPassword(auth, usedEmail, pass);
        await updateProfile(cred.user,{ displayName: fullName });
        await setDoc(doc(db,'users',cred.user.uid), { fullName, firstName:firstName(fullName), email, org, role, createdAt: new Date().toISOString() });
        alert('Registered. You are now logged in.');
      }catch(e){ alert(e.code==='auth/email-already-in-use' ? 'Account exists. Please login.' : e.message); }
    };

    $('#btnSignin').onclick = async ()=>{
      const fullName=$('#fullName').value.trim();
      const email=($('#email').value||'').trim();
      const role=$('#role').value;
      const pass=$('#password').value;
      if(!fullName||!pass){ alert('Fill required fields'); return; }
      if(EDIT_ROLES.has(role) && !email){ alert('Editors must provide an email'); return; }
      const usedEmail = email || slugEmailFromName(fullName);
      try{ await signInWithEmailAndPassword(auth, usedEmail, pass); }
      catch(e){ alert('Login failed: '+e.message); }
    };

    $('#btnSignout').onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      const who=$('#who');
      if(!user){ CAN_EDIT=false; $('#btnSignout').style.display='none'; who.innerHTML=''; toggleEditUI(false); return; }
      $('#btnSignout').style.display='inline-block';
      try{
        const resp = await fetch(`https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/users/${user.uid}`);
        let role='Viewer', fullName=user.displayName||user.email||'';
        if(resp.ok){ const json=await resp.json(); const f=json.fields||{}; role=f.role?.stringValue||role; fullName=f.fullName?.stringValue||fullName; }
        CAN_EDIT = EDIT_ROLES.has(role);
        who.innerHTML = `<span>${fullName}</span><span>${role}</span>`; // stacked, lowercase via CSS
        toggleEditUI(CAN_EDIT);
      }catch(err){ console.warn(err); toggleEditUI(false); }
    });

    function toggleEditUI(can){
      $('#addGoal').style.display = can? 'inline-block':'none';
      $('#addRisk').style.display = can? 'inline-block':'none';
      $('#addIssue').style.display = can? 'inline-block':'none';
      $('#addPlan').style.display = can? 'inline-block':'none';
      $('#saveBtn').disabled = !can;
    }

    // Add row
    $('#addGoal').onclick = ()=> addRow('goals');
    $('#addRisk').onclick = ()=> addRow('risks');
    $('#addIssue').onclick = ()=> addRow('issues');
    $('#addPlan').onclick = ()=> addRow('plans');

    function addRow(kind){
      const tbody = {goals:'#tblGoals',risks:'#tblRisks',issues:'#tblIssues',plans:'#tblPlans'}[kind];
      const tb = document.querySelector(tbody+ ' tbody');
      const nextId = generateNextId(tb, kind.charAt(0).toUpperCase());
      const tr = document.createElement('tr');
      tr.innerHTML = rowTemplate(kind, nextId);
      tb.appendChild(tr); computeKpis();
    }

    function rowTemplate(kind, id){
      if(kind==='goals'){
        return `
          <td contenteditable="true">${id}</td>
          <td contenteditable="true"></td>
          <td>${ownerSelect()}</td>
          <td><input type="date"/></td>
          <td><input type="date"/></td>
          <td>${statusSelect('goals','Open')}</td>
          <td contenteditable="true"></td>
          <td class="row-actions">
            <button class="btn" data-edit>Edit</button>
            <button class="btn" data-del>Del</button>
          </td>`;
      }
      if(kind==='risks'){
        return `
          <td contenteditable="true">R0</td>
          <td contenteditable="true"></td>
          <td>${ownerSelect()}</td>
          <td>${triSelect('Medium')}</td>
          <td>${triSelect('Medium')}</td>
          <td>${statusSelect('risks','Open')}</td>
          <td contenteditable="true"></td>
          <td class="row-actions"><button class="btn" data-edit>Edit</button><button class="btn" data-del>Del</button></td>`;
      }
      if(kind==='issues'){
        return `
          <td contenteditable="true">I0</td>
          <td contenteditable="true"></td>
          <td>${ownerSelect()}</td>
          <td>${triSelect('Medium')}</td>
          <td>${statusSelect('issues','Open')}</td>
          <td contenteditable="true"></td>
          <td class="row-actions"><button class="btn" data-edit>Edit</button><button class="btn" data-del>Del</button></td>`;
      }
      if(kind==='plans'){
        return `
          <td contenteditable="true">P0</td>
          <td contenteditable="true"></td>
          <td>${ownerSelect()}</td>
          <td><input type="text" placeholder="Goal ID (e.g. G1)"/></td>
          <td><input type="date"/></td>
          <td><input type="date"/></td>
          <td>${statusSelect('plans','Open')}</td>
          <td class="row-actions"><button class="btn" data-edit>Edit</button><button class="btn" data-del>Del</button></td>`;
      }
      return '';
    }

    // Delete (with confirm) and simple edit toggle (cells are always editable for editors, but we keep button for UX)
    document.body.addEventListener('click', (e)=>{
      if(e.target.matches('button[data-del]')){
        if(!CAN_EDIT){ alert('No edit rights'); return; }
        const tr=e.target.closest('tr'); if(confirm('Delete this row?')){ tr.remove(); computeKpis(); }
      }
    });

    function generateNextId(tbody, prefix){
      const ids = Array.from(tbody.querySelectorAll('tr td:first-child')).map(td=>td.textContent.trim()).filter(Boolean);
      let max=0; ids.forEach(id=>{ const n=parseInt(id.replace(/\D/g,''))||0; if(n>max) max=n; });
      return `${prefix}${max+1}`;
    }

    // Table extract/render
    function tableToArray(kind){
      const map={goals:'#tblGoals',risks:'#tblRisks',issues:'#tblIssues',plans:'#tblPlans'}[kind];
      const rows = Array.from(document.querySelectorAll(`${map} tbody tr`));
      return rows.map(tr=>{
        const tds = Array.from(tr.querySelectorAll('td'));
        if(kind==='goals') return { id:tds[0].innerText.trim(), goal:tds[1].innerText.trim(), owner:tds[2].querySelector('select').value, start:tds[3].querySelector('input').value||'', end:tds[4].querySelector('input').value||'', status:tds[5].querySelector('select').value, notes:tds[6].innerText.trim() };
        if(kind==='risks')  return { id:tds[0].innerText.trim(), description:tds[1].innerText.trim(), owner:tds[2].querySelector('select').value, likelihood:tds[3].querySelector('select').value, impact:tds[4].querySelector('select').val
