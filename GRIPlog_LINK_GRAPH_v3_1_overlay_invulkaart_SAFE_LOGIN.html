<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRIPlog – Honey Value Chain (Kitui) • Overlay Invulkaart + Fixes (Safe Login)</title>
  <link rel="icon" href="assets/dorcas-logo.svg" />
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--ink:#111827;--muted:#6b7280;--line:#e5e7eb;--brand:#0ea5a3;--danger:#ef4444;--ok:#10b981;--warn:#f59e0b;
      --g100:#f3f4f6;--g200:#e5e7eb;--g300:#d1d5db;--g600:#4b5563;--g700:#374151;--g800:#1f2937}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .hidden{display:none !important}
    header{display:flex;gap:12px;align-items:flex-start;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
    header img{height:34px}
    header .title{font-weight:800;font-size:18px}
    header .sub{color:var(--muted);font-size:12px}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:999px;background:#bbb}
    .ok{background:var(--ok)}
    .alert{padding:10px 14px;border:1px solid var(--line);border-left:4px solid var(--warn);background:#fff8e6;border-radius:10px;margin:10px 16px;color:#8a6d1f}
    .alert.err{border-left-color:var(--danger);background:#fff1f2;color:#7f1d1d}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:10px 16px;background:#f0f5f5;border-bottom:1px solid var(--line)}
    .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:8px 12px;background:#fff;cursor:pointer;font-size:14px}
    .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .input,select,input[type="text"],input[type="password"],input[type="email"],input[type="date"]{border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff;font-size:14px}
    nav.tabs{display:flex;gap:8px;padding:10px 16px;background:var(--card);border-bottom:1px solid var(--line)}
    nav.tabs button{border:none;background:#eaf6f6;color:#065a59;padding:8px 10px;border-radius:10px;font-weight:700;cursor:pointer}
    nav.tabs button.active{background:#0ea5a3;color:#fff}
    nav.tabs .push-right{margin-left:auto}
    section{display:none;padding:14px 16px} section.active{display:block}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .sectionbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:6px 0}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{border:1px solid var(--line);padding:6px 8px;vertical-align:top;font-size:14px;background:#fff}
    th{background:#f9fbfb;text-align:left}
    td:first-child, th:first-child{width:1%;white-space:nowrap}
    #tblGoals td:nth-child(2), #tblGoals th:nth-child(2),
    #tblRisks td:nth-child(2), #tblRisks th:nth-child(2),
    #tblIssues td:nth-child(2),#tblIssues th:nth-child(2),
    #tblPlans  td:nth-child(2),#tblPlans  th:nth-child(2),
    #tblQuestions td:nth-child(2),#tblQuestions th:nth-child(2),
    #tblSuggestions td:nth-child(2),#tblSuggestions th:nth-child(2),
    #tblNotifications td:nth-child(2),#tblNotifications th:nth-child(2){width:auto}
    .user-info{display:none}
    .btn-edit{background:var(--g100);border-color:var(--g200);color:var(--g700)}
    .btn-save{background:#e5e7eb;border-color:#d1d5db;color:#111827;font-weight:700}
    .btn-del{background:#111827;border-color:#111827;color:#fff}
    #overlay{position:fixed;inset:0;display:none;z-index:1000}
    #overlay.show{display:block}
    .ov-backdrop{position:absolute;inset:0;background:rgba(15,23,42,.55);backdrop-filter:blur(2px)}
    .ov-panel{position:absolute;inset:24px;display:flex;flex-direction:column;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    .ov-header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#fff,#f8fafc)}
    .ov-body{padding:12px 16px;display:flex;gap:16px;min-height:0;flex:1;overflow:hidden}
    .ov-left{flex:1;min-width:0;overflow:auto}
    .ov-right{flex:0 0 380px;border-left:1px solid var(--line);padding-left:12px;overflow:auto}
    .form-row{display:grid;grid-template-columns:160px 1fr;gap:10px;margin:8px 0}
    .form-row textarea{min-height:120px;resize:vertical}
    .chain-wrap{height:100%;min-height:320px;border:1px dashed var(--line);border-radius:12px;padding:12px;background:linear-gradient(180deg,#f8fafc,#ffffff);overflow:auto}
    .chain{display:inline-block;white-space:nowrap}
    .node{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #cbd5e1;border-radius:14px;background:linear-gradient(180deg,#fff,#f9fafb);font-weight:600;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);margin:6px;cursor:pointer}
    .node.current{transform:scale(1.12);border-color:#6b7280;box-shadow:0 8px 18px rgba(0,0,0,.18)}
    footer{padding:16px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <img src="assets/dorcas-logo.svg" alt="Dorcas" onerror="this.style.display='none'">
    <div>
      <div class="title">GRIPlog – Honey Value Chain (Kitui)</div>
      <div class="sub">Goals • Risks • Issues • Plans • Questions • Suggestions • Notifications</div>
    </div>
    <div style="margin-left:auto;text-align:right">
      <span class="chip"><span id="authDot" class="dot"></span><span id="authTxt">not signed in</span></span>
      <span id="userInfo" class="user-info"></span>
    </div>
  </header>

  <div id="banner" class="alert hidden"></div>
  <div id="errorBanner" class="alert err hidden"></div>

  <div class="toolbar">
    <div>
      <button id="btnLoad" class="btn">Load Database</button>
      <button id="btnSaveAll" class="btn primary" disabled>Save to Database</button>
      <button id="btnDemo" class="btn">Demo mode</button>
    </div>
    <div>
      <input id="fullName" class="input" placeholder="full name *" />
      <input id="email" class="input" type="email" placeholder="email (for editors)" />
      <input id="org" class="input" placeholder="organization *" />
      <select id="role" class="input">
        <option value="Viewer" selected>Viewer (read-only)</option>
        <option>Admin</option><option>Projectmanager</option><option>Strategic Program Advisor</option><option>Thematic Expert</option>
      </select>
      <input id="password" class="input" type="password" placeholder="password *" />
      <button id="btnSignup" class="btn">register</button>
      <button id="btnSignin" class="btn primary">login</button>
      <button id="btnSignout" class="btn" style="display:none">logout</button>
    </div>
  </div>

  <nav class="tabs" role="tablist">
    <button class="active" data-tab="goals">G – Goals</button>
    <button data-tab="risks">R – Risks</button>
    <button data-tab="issues">I – Issues</button>
    <button data-tab="plans">P – Plans</button>
    <button class="push-right" data-tab="questions">Q – Questions</button>
    <button data-tab="suggestions">S – Suggestions</button>
    <button data-tab="notifications">N – Notifications</button>
  </nav>

  <section id="goals" class="active" role="tabpanel">
    <div class="card">
      <div class="sectionbar"><div><h2 style="display:inline">Goals</h2> <button class="btn" id="addGoalBtn" disabled>+ New Goal</button></div></div>
      <table id="tblGoals"><thead><tr>
        <th>ID</th><th>Goal (SMART)</th><th style="width:160px">Owner</th><th style="width:130px">Start</th><th style="width:130px">End</th><th style="width:140px">Status</th><th>Notes</th><th style="width:110px">Actions</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="risks" role="tabpanel">
    <div class="card">
      <div class="sectionbar"><div><h2 style="display:inline">Risks</h2> <button class="btn" id="addRiskBtn" disabled>+ New Risk</button></div></div>
      <table id="tblRisks"><thead><tr>
        <th>ID</th><th>Description</th><th style="width:160px">Owner</th><th style="width:120px">Likelihood</th><th style="width:120px">Impact</th><th style="width:140px">Status</th><th>Mitigation</th><th style="width:110px">Actions</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="issues" role="tabpanel">
    <div class="card">
      <div class="sectionbar"><div><h2 style="display:inline">Issues</h2> <button class="btn" id="addIssueBtn" disabled>+ New Issue</button></div></div>
      <table id="tblIssues"><thead><tr>
        <th>ID</th><th>Description</th><th style="width:160px">Owner</th><th style="width:120px">Severity</th><th style="width:140px">Status</th><th>Resolution</th><th style="width:110px">Actions</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="plans" role="tabpanel">
    <div class="card">
      <div class="sectionbar"><div><h2 style="display:inline">Plans</h2> <button class="btn" id="addPlanBtn" disabled>+ New Plan</button></div></div>
    <table id="tblPlans"><thead><tr>
      <th>ID</th><th>Description</th><th style="width:160px">Owner</th><th style="width:130px">Start</th><th style="width:130px">End</th><th style="width:140px">Status</th><th style="width:110px">Actions</th>
    </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="questions" role="tabpanel">
    <div class="card">
      <div class="sectionbar"><div><h2 style="display:inline">Questions</h2> <button class="btn" id="addQuestionBtn">+ New Question</button></div></div>
      <table id="tblQuestions"><thead><tr>
        <th>ID</th><th>Description</th><th style="width:160px">Owner</th><th style="width:130px">Submitted</th><th style="width:130px">Status</th><th style="width:160px">Reviewer Role</th><th style="width:130px">Reviewed</th><th style="width:120px">Stars</th><th style="width:110px">Actions</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="suggestions" role="tabpanel">
    <div class="card">
      <div class="sectionbar"><div><h2 style="display:inline">Suggestions</h2> <button class="btn" id="addSuggestionBtn">+ New Suggestion</button></div></div>
      <table id="tblSuggestions"><thead><tr>
        <th>ID</th><th>Description</th><th style="width:160px">Owner</th><th style="width:130px">Submitted</th><th style="width:130px">Status</th><th style="width:160px">Reviewer Role</th><th style="width:130px">Reviewed</th><th style="width:120px">Stars</th><th style="width:110px">Actions</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="notifications" role="tabpanel">
    <div class="card">
      <div class="sectionbar"><div><h2 style="display:inline">Notifications</h2></div></div>
      <table id="tblNotifications"><thead><tr>
        <th>ID</th><th>Description</th><th style="width:140px">Status</th><th style="width:160px">Role</th><th style="width:140px">Date</th><th style="width:110px">Actions</th>
      </tr></thead><tbody></tbody></table>
      <p class="help">Only <strong>Admin</strong> can edit or delete rows in this logbook.</p>
    </div>
  </section>

  <div id="overlay">
    <div class="ov-backdrop" data-ov-close></div>
    <div class="ov-panel">
      <div class="ov-header"><div id="ovTitle" style="font-weight:800">Invulkaart</div><div><button class="btn" id="ovClose" data-ov-close>Close ✕</button></div></div>
      <div class="ov-body">
        <div class="ov-left"><form id="ovForm"></form></div>
        <div class="ov-right">
          <h4>Boomgrafiek</h4>
          <div class="chain-wrap"><div id="chain" class="chain"></div></div>
        </div>
      </div>
      <div class="ov-footer" style="padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:space-between;align-items:center">
        <span class="chip">Edit modus staat standaard aan voor editors.</span>
        <div><button id="ovDelete" class="btn btn-del hidden">Delete</button> <button id="ovSave" class="btn btn-save">Save</button></div>
      </div>
    </div>
  </div>

  <footer>© <span id="yr"></span> Dorcas / GRIPlog – role-based viewer/editor.</footer>

  <script type="module">
    // --- Helpers ---
    const $=(q,root=document)=>root.querySelector(q); const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
    const banner=$('#banner'), err=$('#errorBanner');
    function showInfo(msg){ banner.textContent=msg; banner.classList.remove('hidden'); }
    function hideInfo(){ banner.classList.add('hidden'); }
    function showErr(msg){ err.textContent=msg; err.classList.remove('hidden'); console.error(msg); }
    function hideErr(){ err.classList.add('hidden'); }
    function num(id){ const n=parseInt(String(id||'').replace(/\\D+/g,'')||'0',10); return isNaN(n)?0:n; }
    function byId(arr){ return Object.fromEntries(arr.map(x=>[x.id,x])); }
    $('#yr').textContent = new Date().getFullYear();

    // --- LocalStorage for login fields ---
    ['fullName','email','org','role'].forEach(k=>{ const v=localStorage.getItem('login:'+k); if(v!==null) $('#'+k).value=v; $('#'+k).addEventListener('input',e=>localStorage.setItem('login:'+k,e.target.value)); });

    // --- Tabs ---
    $$('.tabs button').forEach(btn=>btn.addEventListener('click',()=>{
      $$('.tabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
      $$('section').forEach(s=>s.classList.remove('active')); $('#'+btn.dataset.tab).classList.add('active');
      renderTab(btn.dataset.tab);
    }));

    // --- Data state ---
    const EDIT_ROLES = new Set(['Admin','Projectmanager','Strategic Program Advisor','Thematic Expert']);
    const owners=["","Coop Board","Kamaki Cooperative","QA Manager","Operations Lead","Value Add Manager","MRDP Field Coord.","SEKU (QA Lab)","Finance Lead","Sales Lead","County Govt Kitui","Dorcas Kenya","Program Manager","Procurement","FFS Coordinator"];
    const ownerRoles=['Admin','Projectmanager','Strategic Program Advisor','Thematic Expert','Partner/Sponsor'];
    const statuses={goals:["","Open","In progress","Done"],risks:["","Open","In progress","Done"],issues:["","Open","In progress","Blocked","Done"],plans:["","Open","In progress","Done"]};
    const tri=["","Low","Medium","High"];
    let CAN_EDIT=false, CURRENT_UID=null, CURRENT_ROLE='Viewer', CURRENT_NAME='';
    let cache={goals:[],risks:[],issues:[],plans:[],suggestions:[],questions:[],notifications:[]};
    let prevCache=JSON.parse(JSON.stringify(cache));
    function setEditMode(can){ CAN_EDIT=!!can; $('#btnSaveAll').disabled=!CAN_EDIT; ['addGoalBtn','addRiskBtn','addIssueBtn','addPlanBtn'].forEach(id=>{ const el=$('#'+id); if(el) el.disabled=!CAN_EDIT; }); }

    // --- Firebase bootstrap with safety ---
    const isFile = location.protocol==='file:';
    const params = new URLSearchParams(location.search);
    const DEMO = params.get('demo')==='1';
    if(isFile){ showInfo('Je opent dit bestand via file:// → gebruik een lokale server (zie stappen hieronder). Demo mode is beschikbaar.'); }

    let app, auth, db;
    async function initFirebase(){
      if(DEMO){ showInfo('Demo mode: gebruik van in‑memory data. Er wordt niets opgeslagen.'); return; }
      // Allow override via window.FIREBASE_CONFIG
      const fallbackConfig = {
          apiKey: "AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps",
  authDomain: "griplog.firebaseapp.com",
  projectId: "griplog",
  storageBucket: "griplog.firebasestorage.app",
  messagingSenderId: "1097061844582",
  appId: "1:1097061844582:web:5fc1c25e320af9c9384fa7",
  measurementId: "G-NPE08326BM"
      };
      const cfg = window.FIREBASE_CONFIG || fallbackConfig;
      if(cfg.apiKey==='AIzaSyAcIiKWweeFZDDwkpnj-triuetWY0zwkps'){ showErr('Firebase config ontbreekt. Zet window.FIREBASE_CONFIG op je pagina of vul je echte config in.'); return; }

      try{
        const [{ initializeApp }, { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile }, { getFirestore, collection, getDocs, setDoc, doc, serverTimestamp, getDoc, deleteDoc }] = await Promise.all([
          import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js'),
          import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js'),
          import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js')
        ]);
        window._fbmods = { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile, getFirestore, collection, getDocs, setDoc, doc, serverTimestamp, getDoc, deleteDoc };
        app = initializeApp(cfg);
        auth = getAuth(app);
        db = getFirestore(app);
        wireAuth();
      }catch(e){
        showErr('Firebase init fout: '+ (e?.message||e));
      }
    }

    function wireAuth(){
      const { onAuthStateChanged } = window._fbmods;
      onAuthStateChanged(auth, async (user)=>{
        const authDot=$('#authDot'), authTxt=$('#authTxt');
        if(!user){ authDot.classList.remove('ok'); authTxt.textContent='not signed in'; $('#btnSignout').style.display='none'; setEditMode(false); CURRENT_UID=null; CURRENT_ROLE='Viewer'; CURRENT_NAME=''; return; }
        $('#btnSignout').style.display='inline-block'; authDot.classList.add('ok'); CURRENT_UID=user.uid; CURRENT_NAME=user.displayName||user.email||'';
        CURRENT_ROLE='Viewer';
        try{
          const { getDoc, doc } = window._fbmods;
          const snap=await getDoc(doc(db,'users',user.uid));
          if(snap.exists()){ const d=snap.data(); CURRENT_ROLE=d.role||'Viewer'; }
        }catch(e){ showErr('Kon user role niet laden: '+e.message); }
        const isEditor = EDIT_ROLES.has(CURRENT_ROLE) && !!user.email;
        $('#authTxt').textContent = isEditor? 'editor' : 'viewer';
        setEditMode(isEditor);
        await loadAll();
      });
    }

    // --- Auth UI handlers (safe) ---
    $('#btnSignup').onclick=async ()=>{
      if(DEMO){ showInfo('Signup niet nodig in Demo mode.'); return; }
      const fullName=$('#fullName').value.trim(); const email=$('#email').value.trim(); const org=$('#org').value.trim(); const role=$('#role').value; const pass=$('#password').value;
      if(!fullName||!org||!pass){ showErr('Vul verplichte velden.'); return; }
      if(EDIT_ROLES.has(role) && !email){ showErr('Email vereist voor editors.'); return; }
      const used=email || (fullName.trim().toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,40)+"@griplog.local");
      try{
        const { createUserWithEmailAndPassword, updateProfile } = window._fbmods;
        const cred = await createUserWithEmailAndPassword(auth, used, pass);
        await updateProfile(cred.user,{displayName:fullName});
        const { setDoc, doc, serverTimestamp } = window._fbmods;
        await setDoc(doc(db,'users',cred.user.uid), { fullName, email: email||'', org, role, createdAt: serverTimestamp() }, { merge:true });
        alert('registered. please login.');
      }catch(e){ showErr('Signup mislukt: '+e.message); }
    };
    $('#btnSignin').onclick=async ()=>{
      if(DEMO){ showInfo('Demo mode: login overgeslagen.'); setEditMode(true); return; }
      const fullName=$('#fullName').value.trim(); const email=$('#email').value.trim(); const rolePick=$('#role').value; const pass=$('#password').value;
      if(!fullName||!pass){ showErr('Vul naam en wachtwoord.'); return; }
      if(EDIT_ROLES.has(rolePick) && !email){ showErr('Email vereist voor editors.'); return; }
      const used=email || (fullName.trim().toLowerCase().replace(/[^a-z0-9]+/g,'').slice(0,40)+"@griplog.local");
      try{
        const { signInWithEmailAndPassword, setDoc, doc } = window._fbmods;
        const cred=await signInWithEmailAndPassword(auth, used, pass);
        if(EDIT_ROLES.has(rolePick) && email){ await setDoc(doc(db,'users',cred.user.uid), { role: rolePick, email, fullName }, {merge:true}); }
      }catch(e){ showErr('Login mislukt: '+e.message); }
    };
    $('#btnSignout').onclick=async ()=>{
      if(DEMO){ location.reload(); return; }
      try{ const { signOut } = window._fbmods; await signOut(auth); }catch(e){ showErr('Logout fout: '+e.message); }
    };

    // --- Load/Save ---
    async function loadAll(){
      if(DEMO){ seedDemo(); renderAll(); return; }
      try{
        const { collection, getDocs } = window._fbmods;
        const [g,r,i,p,s,q] = await Promise.all([
          getDocs(collection(db,'goals')), getDocs(collection(db,'risks')), getDocs(collection(db,'issues')),
          getDocs(collection(db,'plans')), getDocs(collection(db,'suggestions')), getDocs(collection(db,'questions'))
        ]);
        prevCache = JSON.parse(JSON.stringify(cache));
        cache.goals=g.docs.map(d=>({id:d.id,...d.data()}));
        cache.risks=r.docs.map(d=>({id:d.id,...d.data()}));
        cache.issues=i.docs.map(d=>({id:d.id,...d.data()}));
        cache.plans=p.docs.map(d=>({id:d.id,...d.data()}));
        cache.suggestions=s.docs.map(d=>({id:d.id,...d.data()}));
        cache.questions=q.docs.map(d=>({id:d.id,...d.data()}));
        renderAll();
      }catch(e){ showErr('Laden mislukt (Firestore): '+e.message); }
    }
    async function saveAll(){
      if(!CAN_EDIT){ showErr('Geen edit-rechten'); return; }
      if(DEMO){ showInfo('Demo mode: niet opgeslagen.'); return; }
      try{
        const { setDoc, doc, deleteDoc } = window._fbmods;
        const tasks=[];
        function upserts(prevArr, nextArr, coll){
          const prevMap=byId(prevArr);
          nextArr.forEach(row=> tasks.push(setDoc(doc(db,coll,row.id), row)));
          prevArr.forEach(prev=>{ if(!nextArr.find(x=>x.id===prev.id)) tasks.push(deleteDoc(doc(db,coll,prev.id))); });
        }
        upserts(prevCache.goals, rowsFromTable('goals'), 'goals');
        upserts(prevCache.risks, rowsFromTable('risks'), 'risks');
        upserts(prevCache.issues,rowsFromTable('issues'),'issues');
        upserts(prevCache.plans, rowsFromTable('plans'), 'plans');
        await Promise.all(tasks);
        alert('saved');
        await loadAll();
      }catch(e){ showErr('Opslaan mislukt: '+e.message); }
    }
    $('#btnLoad').onclick=loadAll; $('#btnSaveAll').onclick=saveAll;
    $('#btnDemo').onclick=()=>{ location.search='?demo=1'; };

    // --- Renderers (same as previous version, trimmed) ---
    function actionsCell(coll,id){ return \`<div class="row-actions"><button class="btn btn-edit" data-menu="\${coll}" data-id="\${id||''}">Menu</button></div>\`; }
    function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function renderGoals(){ const tb=$('#tblGoals tbody'); tb.innerHTML=''; let rows=[...cache.goals]; rows.sort((a,b)=>num(a.id)-num(b.id));
      rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=\`
      <td>\${escapeHtml(r.id||'')}</td>
      <td><div>\${escapeHtml(r.goal||'')}</div></td>
      <td><select disabled>\${owners.map(o=>\`<option \${o===(r.owner||'')?'selected':''}>\${o}</option>\`).join('')}</select></td>
      <td><input type="date" value="\${r.start||''}" disabled /></td>
      <td><input type="date" value="\${r.end||''}" disabled /></td>
      <td><select disabled>\${["","Open","In progress","Done"].map(s=>\`<option \${s===(r.status||'')?'selected':''}>\${s}</option>\`).join('')}</select></td>
      <td><div>\${escapeHtml(r.notes||'')}</div></td>
      <td>\${actionsCell('goals',r.id)}</td>\`; tb.appendChild(tr); });
    }
    function renderRisks(){ const tb=$('#tblRisks tbody'); tb.innerHTML=''; let rows=[...cache.risks]; rows.sort((a,b)=>num(a.id)-num(b.id));
      rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=\`
      <td>\${escapeHtml(r.id||'')}</td>
      <td><div>\${escapeHtml(r.description||'')}</div></td>
      <td><select disabled>\${owners.map(o=>\`<option \${o===(r.owner||'')?'selected':''}>\${o}</option>\`).join('')}</select></td>
      <td><select disabled>\${["","Low","Medium","High"].map(v=>\`<option \${v===(r.likelihood||'')?'selected':''}>\${v}</option>\`).join('')}</select></td>
      <td><select disabled>\${["","Low","Medium","High"].map(v=>\`<option \${v===(r.impact||'')?'selected':''}>\${v}</option>\`).join('')}</select></td>
      <td><select disabled>\${["","Open","In progress","Done"].map(s=>\`<option \${s===(r.status||'')?'selected':''}>\${s}</option>\`).join('')}</select></td>
      <td><div>\${escapeHtml(r.mitigation||'')}</div></td>
      <td>\${actionsCell('risks',r.id)}</td>\`; tb.appendChild(tr); });
    }
    function renderIssues(){ const tb=$('#tblIssues tbody'); tb.innerHTML=''; let rows=[...cache.issues]; rows.sort((a,b)=>num(a.id)-num(b.id));
      rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=\`
      <td>\${escapeHtml(r.id||'')}</td>
      <td><div>\${escapeHtml(r.description||'')}</div></td>
      <td><select disabled>\${owners.map(o=>\`<option \${o===(r.owner||'')?'selected':''}>\${o}</option>\`).join('')}</select></td>
      <td><select disabled>\${["","Low","Medium","High"].map(v=>\`<option \${v===(r.severity||'')?'selected':''}>\${v}</option>\`).join('')}</select></td>
      <td><select disabled>\${["","Open","In progress","Blocked","Done"].map(s=>\`<option \${s===(r.status||'')?'selected':''}>\${s}</option>\`).join('')}</select></td>
      <td><div>\${escapeHtml(r.resolution||'')}</div></td>
      <td>\${actionsCell('issues',r.id)}</td>\`; tb.appendChild(tr); });
    }
    function renderPlans(){ const tb=$('#tblPlans tbody'); tb.innerHTML=''; let rows=[...cache.plans]; rows.sort((a,b)=>num(a.id)-num(b.id));
      rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=\`
      <td>\${escapeHtml(r.id||'')}</td>
      <td><div>\${escapeHtml(r.description||'')}</div></td>
      <td><select disabled>\${owners.map(o=>\`<option \${o===(r.owner||'')?'selected':''}>\${o}</option>\`).join('')}</select></td>
      <td><input type="date" value="\${r.start||''}" disabled /></td>
      <td><input type="date" value="\${r.end||''}" disabled /></td>
      <td><select disabled>\${["","Open","In progress","Done"].map(s=>\`<option \${s===(r.status||'')?'selected':''}>\${s}</option>\`).join('')}</select></td>
      <td>\${actionsCell('plans',r.id)}</td>\`; tb.appendChild(tr); });
    }
    function renderSuggestions(){ const tb=$('#tblSuggestions tbody'); tb.innerHTML=''; let rows=[...cache.suggestions]; rows.sort((a,b)=>num(a.id)-num(b.id));
      rows.forEach(r=>{ if(r.stars==null) r.stars=0; if(!r.starredBy) r.starredBy={};
        const tr=document.createElement('tr'); const already=!!(r.starredBy && CURRENT_UID && r.starredBy[CURRENT_UID]);
        tr.innerHTML=\`
        <td>\${escapeHtml(r.id||'')}</td>
        <td><div>\${escapeHtml(r.description||'')}</div></td>
        <td><select disabled>\${[''].concat(ownerRoles).map(o=>\`<option \${o===r.owner?'selected':''}>\${o}</option>\`).join('')}</select></td>
        <td><input type="date" value="\${r.submitted||''}" disabled /></td>
        <td><select disabled>\${["","Approved","Pending","Dismissed"].map(s=>\`<option \${s===r.status?'selected':''}>\${s}</option>\`).join('')}</select></td>
        <td><select disabled>\${["","Admin","Strategic Program Advisor","Thematic Expert","Projectmanager"].map(o=>\`<option \${o===r.reviewerRole?'selected':''}>\${o}</option>\`).join('')}</select></td>
        <td><input type="date" value="\${r.reviewed||''}" disabled /></td>
        <td><button class="btn btn-edit" data-star-sug \${!CURRENT_UID||already?'disabled':''}>⭐</button> <span data-star-count>\${r.stars||0}</span></td>
        <td>\${actionsCell('suggestions',r.id)}</td>\`; tb.appendChild(tr); });
    }
    function renderQuestions(){ const tb=$('#tblQuestions tbody'); tb.innerHTML=''; let rows=[...cache.questions]; rows.sort((a,b)=>num(a.id)-num(b.id));
      rows.forEach(r=>{ if(r.stars==null) r.stars=0; if(!r.starredBy) r.starredBy={};
        const tr=document.createElement('tr'); const already=!!(r.starredBy && CURRENT_UID && r.starredBy[CURRENT_UID]);
        tr.innerHTML=\`
        <td>\${escapeHtml(r.id||'')}</td>
        <td><div>\${escapeHtml(r.description||'')}</div></td>
        <td><select disabled>\${[''].concat(ownerRoles).map(o=>\`<option \${o===r.owner?'selected':''}>\${o}</option>\`).join('')}</select></td>
        <td><input type="date" value="\${r.submitted||''}" disabled /></td>
        <td><select disabled>\${["","Approved","Pending","Dismissed"].map(s=>\`<option \${s===r.status?'selected':''}>\${s}</option>\`).join('')}</select></td>
        <td><select disabled>\${["","Admin","Strategic Program Advisor","Thematic Expert","Projectmanager"].map(o=>\`<option \${o===r.reviewerRole?'selected':''}>\${o}</option>\`).join('')}</select></td>
        <td><input type="date" value="\${r.reviewed||''}" disabled /></td>
        <td><button class="btn btn-edit" data-star-q \${!CURRENT_UID||already?'disabled':''}>⭐</button> <span data-star-count>\${r.stars||0}</span></td>
        <td>\${actionsCell('questions',r.id)}</td>\`; tb.appendChild(tr); });
    }
    function renderNotifications(rows=[]){ const tb=$('#tblNotifications tbody'); tb.innerHTML=''; (rows.length?rows:cache.notifications).forEach(r=>{
      const tr=document.createElement('tr'); tr.innerHTML=\`
      <td>\${escapeHtml(r.id||'')}</td><td>\${escapeHtml(r.description||'')}</td><td>\${escapeHtml(r.status||'')}</td><td>\${escapeHtml(r.role||'')}</td><td>\${escapeHtml(r.date||'')}</td><td>—</td>\`; tb.appendChild(tr);
    }); }
    function renderAll(){ renderGoals(); renderRisks(); renderIssues(); renderPlans(); renderSuggestions(); renderQuestions(); renderNotifications([]); }
    function renderTab(tab){ ({goals:renderGoals,risks:renderRisks,issues:renderIssues,plans:renderPlans,questions:renderQuestions,suggestions:renderSuggestions,notifications:()=>renderNotifications([])})[tab]?.(); }

    function rowsFromTable(kind){
      const map = {goals:'#tblGoals', risks:'#tblRisks', issues:'#tblIssues', plans:'#tblPlans'}[kind]; if(!map) return [];
      return Array.from(document.querySelectorAll(\`\${map} tbody tr\`)).map(tr=>{
        const tds = Array.from(tr.querySelectorAll('td'));
        if(kind==='goals')  return { id:tds[0].innerText.trim(), goal:tds[1].innerText.trim(), owner:tds[2].querySelector('select')?.value||'', start:tds[3].querySelector('input')?.value||'', end:tds[4].querySelector('input')?.value||'', status:tds[5].querySelector('select')?.value||'', notes:tds[6].innerText.trim() };
        if(kind==='risks')  return { id:tds[0].innerText.trim(), description:tds[1].innerText.trim(), owner:tds[2].querySelector('select')?.value||'', likelihood:tds[3].querySelector('select')?.value||'', impact:tds[4].querySelector('select')?.value||'', status:tds[5].querySelector('select')?.value||'', mitigation:tds[6].innerText.trim() };
        if(kind==='issues') return { id:tds[0].innerText.trim(), description:tds[1].innerText.trim(), owner:tds[2].querySelector('select')?.value||'', severity:tds[3].querySelector('select')?.value||'', status:tds[4].querySelector('select')?.value||'', resolution:tds[5].innerText.trim() };
        if(kind==='plans')  return { id:tds[0].innerText.trim(), description:tds[1].innerText.trim(), owner:tds[2].querySelector('select')?.value||'', start:tds[3].querySelector('input')?.value||'', end:tds[4].querySelector('input')?.value||'', status:tds[5].querySelector('select')?.value||'' };
      });
    }

    // --- Overlay ---
    const overlay = $('#overlay'); const ovForm=$('#ovForm'); const ovTitle=$('#ovTitle'); const ovSave=$('#ovSave'); const ovDelete=$('#ovDelete');
    let ovMode='create', ovColl='', ovId='';
    function openOverlay({mode,coll,id=null}){
      ovMode=mode; ovColl=coll; ovId=id||''; overlay.classList.add('show'); document.body.style.overflow='hidden';
      buildOverlayForm(coll, id); renderChain(id);
      ovTitle.textContent = (mode==='create' ? 'Nieuw ' : 'Bewerk ') + coll.slice(0,1).toUpperCase() + coll.slice(1,-1);
      ovDelete.classList.toggle('hidden', mode!=='edit');
    }
    function closeOverlay(){ overlay.classList.remove('show'); document.body.style.overflow=''; ovForm.innerHTML=''; }
    overlay.addEventListener('click',e=>{ if(e.target.matches('[data-ov-close]')) closeOverlay(); });
    document.addEventListener('keydown',e=>{ if(e.key==='Escape' && overlay.classList.contains('show')) closeOverlay(); });

    function buildOverlayForm(coll,id){
      const isEdit=!!id; const row=isEdit ? (cache[coll].find(x=>x.id===id)||{}) : {};
      const ownersSel=owners; const triSel=tri; const statusesMap=statuses;
      const fields={
        goals:[ ['goal','Goal (SMART)','textarea', row.goal||''], ['owner','Owner','select', ownersSel, row.owner||''], ['start','Start','date', row.start||''], ['end','End','date', row.end||''], ['status','Status','select', statusesMap.goals, row.status||''], ['notes','Notes','textarea', row.notes||''] ],
        risks:[ ['description','Description','textarea', row.description||''], ['owner','Owner','select', ownersSel, row.owner||''], ['likelihood','Likelihood','select', triSel, row.likelihood||''], ['impact','Impact','select', triSel, row.impact||''], ['status','Status','select', statusesMap.risks, row.status||''], ['mitigation','Mitigation','textarea', row.mitigation||''] ],
        issues:[ ['description','Description','textarea', row.description||''], ['owner','Owner','select', ownersSel, row.owner||''], ['severity','Severity','select', triSel, row.severity||''], ['status','Status','select', statusesMap.issues, row.status||''], ['resolution','Resolution','textarea', row.resolution||''] ],
        plans: [ ['description','Description','textarea', row.description||''], ['owner','Owner','select', ownersSel, row.owner||''], ['start','Start','date', row.start||''], ['end','End','date', row.end||''], ['status','Status','select', statusesMap.plans, row.status||''] ],
        suggestions:[ ['description','Description','textarea', row.description||''], ['owner','Owner','select', [''].concat(ownerRoles), row.owner||''], ['submitted','Submitted','date', row.submitted||new Date().toISOString().slice(0,10)], ['status','Status','select', ["","Approved","Pending","Dismissed"], row.status||''], ['reviewerRole','Reviewer Role','select', ["","Admin","Strategic Program Advisor","Thematic Expert","Projectmanager"], row.reviewerRole||''], ['reviewed','Reviewed','date', row.reviewed||''] ],
        questions:[ ['description','Description','textarea', row.description||''], ['owner','Owner','select', [''].concat(ownerRoles), row.owner||''], ['submitted','Submitted','date', row.submitted||new Date().toISOString().slice(0,10)], ['status','Status','select', ["","Approved","Pending","Dismissed"], row.status||''], ['reviewerRole','Reviewer Role','select', ["","Admin","Strategic Program Advisor","Thematic Expert","Projectmanager"], row.reviewerRole||''], ['reviewed','Reviewed','date', row.reviewed||''] ]
      }[coll];
      const CAN = CAN_EDIT || DEMO;
      const esc=s=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      ovForm.innerHTML = \`
        <div class="form-row"><label>ID</label><input id="ov_id" value="\${isEdit?esc(row.id):''}" disabled></div>
        \${fields.map(([name,label,type,extra,value])=>{
          if(type==='textarea') return \`<div class="form-row"><label>\${label}</label><textarea id="ov_\${name}" \${CAN?'':'disabled'}>\${esc(value)}</textarea></div>\`;
          if(type==='select')   return \`<div class="form-row"><label>\${label}</label><select id="ov_\${name}" \${CAN?'':'disabled'}>\${extra.map(v=>\`<option \${v===value?'selected':''}>\${v}</option>\`).join('')}</select></div>\`;
          if(type==='date')     return \`<div class="form-row"><label>\${label}</label><input type="date" id="ov_\${name}" value="\${value}" \${CAN?'':'disabled'}></div>\`;
          return ''}).join('')}
      \`;
    }

    function renderChain(currentId=null){
      const el=$('#chain'); el.innerHTML='';
      const groups=[['Goals','goals','goal'],['Risks','risks','risk'],['Issues','issues','issue'],['Plans','plans','plan'],['Questions','questions','question'],['Suggestions','suggestions','suggestion']];
      groups.forEach(([label,key,cls])=>{
        const groupTitle=document.createElement('div'); groupTitle.style.fontWeight='800'; groupTitle.style.margin='8px 0 2px'; groupTitle.textContent=label+':'; el.appendChild(groupTitle);
        const row=document.createElement('div'); cache[key].sort((a,b)=>num(a.id)-num(b.id)).forEach(item=>{
          const div=document.createElement('div'); div.className='node '+cls+(item.id===currentId?' current':'');
          div.innerHTML=\`<span class="id">\${item.id}</span><span class="type">\${cls}</span>\`; div.addEventListener('click',()=> openOverlay({mode:'edit',coll:key,id:item.id})); row.appendChild(div);
        }); el.appendChild(row);
      });
    }

    function nextId(arr,prefix){ let m=0; arr.forEach(x=>{ const n=parseInt(String(x.id||'').replace(/\\D+/g,'')||'0',10); if(n>m) m=n; }); return prefix+(m+1); }
    const prefixFor={goals:'G',risks:'R',issues:'I',plans:'P',questions:'Q',suggestions:'S'};

    // Menu / New
    $('#addGoalBtn').onclick = ()=>{ if(!CAN_EDIT && !DEMO) return; openOverlay({mode:'create',coll:'goals'}); };
    $('#addRiskBtn').onclick = ()=>{ if(!CAN_EDIT && !DEMO) return; openOverlay({mode:'create',coll:'risks'}); };
    $('#addIssueBtn').onclick = ()=>{ if(!CAN_EDIT && !DEMO) return; openOverlay({mode:'create',coll:'issues'}); };
    $('#addPlanBtn').onclick  = ()=>{ if(!CAN_EDIT && !DEMO) return; openOverlay({mode:'create',coll:'plans'}); };
    $('#addSuggestionBtn').onclick = ()=> openOverlay({mode:'create',coll:'suggestions'});
    $('#addQuestionBtn').onclick   = ()=> openOverlay({mode:'create',coll:'questions'});

    document.addEventListener('click', (e)=>{ const menu = e.target.closest('button[data-menu]'); if(!menu) return; openOverlay({mode:'edit', coll:menu.dataset.menu, id:menu.dataset.id}); });

    $('#ovSave').addEventListener('click', async (e)=>{
      e.preventDefault();
      const coll=ovColl; const isEdit=(ovMode==='edit'); const prefix=prefixFor[coll]; let id = isEdit ? ovId : nextId(cache[coll], prefix);
      const val=(n)=> $('#ov_'+n)?.value?.trim()||''; let row={id};
      if(coll==='goals') row={id,goal:val('goal'),owner:val('owner'),start:val('start'),end:val('end'),status:val('status'),notes:val('notes')};
      if(coll==='risks') row={id,description:val('description'),owner:val('owner'),likelihood:val('likelihood'),impact:val('impact'),status:val('status'),mitigation:val('mitigation')};
      if(coll==='issues')row={id,description:val('description'),owner:val('owner'),severity:val('severity'),status:val('status'),resolution:val('resolution')};
      if(coll==='plans') row={id,description:val('description'),owner:val('owner'),start:val('start'),end:val('end'),status:val('status')};
      if(coll==='suggestions') row={id,description:val('description'),owner:val('owner'),submitted:val('submitted'),status:val('status'),reviewerRole:val('reviewerRole'),reviewed:val('reviewed'),stars:0,starredBy:{}};
      if(coll==='questions')   row={id,description:val('description'),owner:val('owner'),submitted:val('submitted'),status:val('status'),reviewerRole:val('reviewerRole'),reviewed:val('reviewed'),stars:0,starredBy:{}};

      if(DEMO){ if(isEdit){ const i=cache[coll].findIndex(x=>x.id===id); if(i>-1) cache[coll][i]=row; } else cache[coll].push(row); renderAll(); closeOverlay(); return; }

      if(!CAN_EDIT){ showErr('Geen edit-rechten'); return; }
      try{
        const { setDoc, doc } = window._fbmods; await setDoc(doc(db,coll,id), row);
        if(isEdit){ const i=cache[coll].findIndex(x=>x.id===id); if(i>-1) cache[coll][i]=row; } else cache[coll].push(row);
        renderAll(); closeOverlay();
      }catch(e){ showErr('Save fout: '+e.message); }
    });
    $('#ovDelete').addEventListener('click', async ()=>{
      if(DEMO){ cache[ovColl]=cache[ovColl].filter(x=>x.id!==ovId); renderAll(); closeOverlay(); return; }
      if(!CAN_EDIT){ showErr('Geen edit-rechten'); return; }
      try{ const { deleteDoc, doc } = window._fbmods; await deleteDoc(doc(db,ovColl,ovId)); cache[ovColl]=cache[ovColl].filter(x=>x.id!==ovId); renderAll(); closeOverlay(); }
      catch(e){ showErr('Delete fout: '+e.message); }
    });

    // --- Demo seed ---
    function seedDemo(){
      cache.goals=[{id:'G1',goal:'Launch pellet hub',owner:'Dorcas Kenya',start:'2025-01-01',end:'2025-06-30',status:'In progress',notes:'Phase 1'}];
      cache.risks=[{id:'R1',description:'Supply disruption',owner:'Procurement',likelihood:'Medium',impact:'High',status:'Open',mitigation:'Dual-sourcing'}];
      cache.issues=[{id:'I1',description:'DB sync lag',owner:'QA Manager',severity:'Low',status:'In progress',resolution:''}];
      cache.plans=[{id:'P1',description:'Train field staff',owner:'Program Manager',start:'2025-02-01',end:'2025-03-15',status:'Open'}];
      cache.suggestions=[{id:'S1',description:'Add EN/NL toggle',owner:'Admin',submitted:'2025-09-01',status:'Pending',reviewerRole:'',reviewed:'',stars:2,starredBy:{}}];
      cache.questions=[{id:'Q1',description:'Carbon price assumption?',owner:'Thematic Expert',submitted:'2025-09-05',status:'Pending',reviewerRole:'',reviewed:'',stars:1,starredBy:{}}];
    }

    // --- Startup checks / guidance ---
    (function startup(){
      if(isFile){ showInfo('Serve lokaal: open terminal → ga naar map → run: python -m http.server 8000  (of VSCode Live Server). Open daarna http://localhost:8000/.'); }
      initFirebase();
    })();
  </script>
</body>
</html>
